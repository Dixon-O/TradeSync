(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const u of document.querySelectorAll('link[rel="modulepreload"]'))c(u);new MutationObserver(u=>{for(const p of u)if(p.type==="childList")for(const h of p.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&c(h)}).observe(document,{childList:!0,subtree:!0});function d(u){const p={};return u.integrity&&(p.integrity=u.integrity),u.referrerPolicy&&(p.referrerPolicy=u.referrerPolicy),u.crossOrigin==="use-credentials"?p.credentials="include":u.crossOrigin==="anonymous"?p.credentials="omit":p.credentials="same-origin",p}function c(u){if(u.ep)return;u.ep=!0;const p=d(u);fetch(u.href,p)}})();const oo="modulepreload",so=function(i){return"/"+i},$i={},wt=function(o,d,c){let u=Promise.resolve();if(d&&d.length>0){let I=function($){return Promise.all($.map(C=>Promise.resolve(C).then(A=>({status:"fulfilled",value:A}),A=>({status:"rejected",reason:A}))))};var h=I;document.getElementsByTagName("link");const m=document.querySelector("meta[property=csp-nonce]"),v=m?.nonce||m?.getAttribute("nonce");u=I(d.map($=>{if($=so($),$ in $i)return;$i[$]=!0;const C=$.endsWith(".css"),A=C?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${$}"]${A}`))return;const B=document.createElement("link");if(B.rel=C?"stylesheet":oo,C||(B.as="script"),B.crossOrigin="",B.href=$,v&&B.setAttribute("nonce",v),document.head.appendChild(B),C)return new Promise((V,N)=>{B.addEventListener("load",V),B.addEventListener("error",()=>N(new Error(`Unable to preload CSS for ${$}`)))})}))}function p(m){const v=new Event("vite:preloadError",{cancelable:!0});if(v.payload=m,window.dispatchEvent(v),!v.defaultPrevented)throw m}return u.then(m=>{for(const v of m||[])v.status==="rejected"&&p(v.reason);return o().catch(p)})};let wr=0,kr=0;function Ht(){const i=Date.now();return i>kr?(kr=i,wr=0):wr++,`${kr.toString(36)}-${wr.toString(36)}`}const co=Object.freeze(Object.defineProperty({__proto__:null,now:Ht},Symbol.toStringTag,{value:"Module"}));function ge(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,i=>{const o=Math.random()*16|0;return(i==="x"?o:o&3|8).toString(16)})}function Cn(){let i=localStorage.getItem("ts_deviceId");return i||(i=`device-${ge().slice(0,8)}`,localStorage.setItem("ts_deviceId",i)),i}const lo=Object.freeze(Object.defineProperty({__proto__:null,getDeviceId:Cn,uuid:ge},Symbol.toStringTag,{value:"Module"}));var uo=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function fo(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var kn={exports:{}},po=kn.exports,Ai;function ho(){return Ai||(Ai=1,(function(i,o){((d,c)=>{i.exports=c()})(po,function(){var d=function(e,t){return(d=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(n,r){n.__proto__=r}:function(n,r){for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(n[a]=r[a])}))(e,t)},c=function(){return(c=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)};function u(e,t,n){for(var r,a=0,s=t.length;a<s;a++)!r&&a in t||((r=r||Array.prototype.slice.call(t,0,a))[a]=t[a]);return e.concat(r||Array.prototype.slice.call(t))}var p=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:uo,h=Object.keys,m=Array.isArray;function v(e,t){return typeof t=="object"&&h(t).forEach(function(n){e[n]=t[n]}),e}typeof Promise>"u"||p.Promise||(p.Promise=Promise);var I=Object.getPrototypeOf,$={}.hasOwnProperty;function C(e,t){return $.call(e,t)}function A(e,t){typeof t=="function"&&(t=t(I(e))),(typeof Reflect>"u"?h:Reflect.ownKeys)(t).forEach(function(n){V(e,n,t[n])})}var B=Object.defineProperty;function V(e,t,n,r){B(e,t,v(n&&C(n,"get")&&typeof n.get=="function"?{get:n.get,set:n.set,configurable:!0}:{value:n,configurable:!0,writable:!0},r))}function N(e){return{from:function(t){return e.prototype=Object.create(t.prototype),V(e.prototype,"constructor",e),{extend:A.bind(null,e.prototype)}}}}var Z=Object.getOwnPropertyDescriptor,_e=[].slice;function ot(e,t,n){return _e.call(e,t,n)}function Pt(e,t){return t(e)}function Fe(e){if(!e)throw new Error("Assertion Failed")}function Xt(e){p.setImmediate?setImmediate(e):setTimeout(e,0)}function ke(e,t){if(typeof t=="string"&&C(e,t))return e[t];if(!t)return e;if(typeof t!="string"){for(var n=[],r=0,a=t.length;r<a;++r){var s=ke(e,t[r]);n.push(s)}return n}var l,f=t.indexOf(".");return f===-1||(l=e[t.substr(0,f)])==null?void 0:ke(l,t.substr(f+1))}function pe(e,t,n){if(e&&t!==void 0&&!("isFrozen"in Object&&Object.isFrozen(e)))if(typeof t!="string"&&"length"in t){Fe(typeof n!="string"&&"length"in n);for(var r=0,a=t.length;r<a;++r)pe(e,t[r],n[r])}else{var s,l,f=t.indexOf(".");f!==-1?(s=t.substr(0,f),(f=t.substr(f+1))===""?n===void 0?m(e)&&!isNaN(parseInt(s))?e.splice(s,1):delete e[s]:e[s]=n:pe(l=(l=e[s])&&C(e,s)?l:e[s]={},f,n)):n===void 0?m(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=n}}function zr(e){var t,n={};for(t in e)C(e,t)&&(n[t]=e[t]);return n}var xa=[].concat;function Ur(e){return xa.apply([],e)}var Ae="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(Ur([8,16,32,64].map(function(e){return["Int","Uint","Float"].map(function(t){return t+e+"Array"})}))).filter(function(e){return p[e]}),Hr=new Set(Ae.map(function(e){return p[e]})),Lt=null;function ze(e){return Lt=new WeakMap,e=(function t(n){if(!n||typeof n!="object")return n;var r=Lt.get(n);if(r)return r;if(m(n)){r=[],Lt.set(n,r);for(var a=0,s=n.length;a<s;++a)r.push(t(n[a]))}else if(Hr.has(n.constructor))r=n;else{var l,f=I(n);for(l in r=f===Object.prototype?{}:Object.create(f),Lt.set(n,r),n)C(n,l)&&(r[l]=t(n[l]))}return r})(e),Lt=null,e}var Pa={}.toString;function On(e){return Pa.call(e).slice(8,-1)}var Kn=typeof Symbol<"u"?Symbol.iterator:"@@iterator",La=typeof Kn=="symbol"?function(e){var t;return e!=null&&(t=e[Kn])&&t.apply(e)}:function(){return null};function Ue(e,t){t=e.indexOf(t),0<=t&&e.splice(t,1)}var st={};function $e(e){var t,n,r,a;if(arguments.length===1){if(m(e))return e.slice();if(this===st&&typeof e=="string")return[e];if(a=La(e))for(n=[];!(r=a.next()).done;)n.push(r.value);else{if(e==null)return[e];if(typeof(t=e.length)!="number")return[e];for(n=new Array(t);t--;)n[t]=e[t]}}else for(t=arguments.length,n=new Array(t);t--;)n[t]=arguments[t];return n}var Mn=typeof Symbol<"u"?function(e){return e[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},Ae=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],he=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(Ae),Ia={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function ct(e,t){this.name=e,this.message=t}function Vr(e,t){return e+". Errors: "+Object.keys(t).map(function(n){return t[n].toString()}).filter(function(n,r,a){return a.indexOf(n)===r}).join(`
`)}function Wt(e,t,n,r){this.failures=t,this.failedKeys=r,this.successCount=n,this.message=Vr(e,t)}function lt(e,t){this.name="BulkError",this.failures=Object.keys(t).map(function(n){return t[n]}),this.failuresByPos=t,this.message=Vr(e,this.failures)}N(ct).from(Error).extend({toString:function(){return this.name+": "+this.message}}),N(Wt).from(ct),N(lt).from(ct);var jn=he.reduce(function(e,t){return e[t]=t+"Error",e},{}),$a=ct,H=he.reduce(function(e,t){var n=t+"Error";function r(a,s){this.name=n,a?typeof a=="string"?(this.message="".concat(a).concat(s?`
 `+s:""),this.inner=s||null):typeof a=="object"&&(this.message="".concat(a.name," ").concat(a.message),this.inner=a):(this.message=Ia[t]||n,this.inner=null)}return N(r).from($a),e[t]=r,e},{}),Xr=(H.Syntax=SyntaxError,H.Type=TypeError,H.Range=RangeError,Ae.reduce(function(e,t){return e[t+"Error"]=H[t],e},{}));Ae=he.reduce(function(e,t){return["Syntax","Type","Range"].indexOf(t)===-1&&(e[t+"Error"]=H[t]),e},{});function ne(){}function It(e){return e}function Aa(e,t){return e==null||e===It?t:function(n){return t(e(n))}}function He(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}}function Ta(e,t){return e===ne?t:function(){var n=e.apply(this,arguments),r=(n!==void 0&&(arguments[0]=n),this.onsuccess),a=this.onerror,s=(this.onsuccess=null,this.onerror=null,t.apply(this,arguments));return r&&(this.onsuccess=this.onsuccess?He(r,this.onsuccess):r),a&&(this.onerror=this.onerror?He(a,this.onerror):a),s!==void 0?s:n}}function Ba(e,t){return e===ne?t:function(){e.apply(this,arguments);var n=this.onsuccess,r=this.onerror;this.onsuccess=this.onerror=null,t.apply(this,arguments),n&&(this.onsuccess=this.onsuccess?He(n,this.onsuccess):n),r&&(this.onerror=this.onerror?He(r,this.onerror):r)}}function Ca(e,t){return e===ne?t:function(a){var r=e.apply(this,arguments),a=(v(a,r),this.onsuccess),s=this.onerror,l=(this.onsuccess=null,this.onerror=null,t.apply(this,arguments));return a&&(this.onsuccess=this.onsuccess?He(a,this.onsuccess):a),s&&(this.onerror=this.onerror?He(s,this.onerror):s),r===void 0?l===void 0?void 0:l:v(r,l)}}function Da(e,t){return e===ne?t:function(){return t.apply(this,arguments)!==!1&&e.apply(this,arguments)}}function qn(e,t){return e===ne?t:function(){var n=e.apply(this,arguments);if(n&&typeof n.then=="function"){for(var r=this,a=arguments.length,s=new Array(a);a--;)s[a]=arguments[a];return n.then(function(){return t.apply(r,s)})}return t.apply(this,arguments)}}Ae.ModifyError=Wt,Ae.DexieError=ct,Ae.BulkError=lt;var Ee=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function Wr(e){Ee=e}var $t={},Yr=100,At=typeof Promise>"u"?[]:(he=Promise.resolve(),typeof crypto<"u"&&crypto.subtle?[At=crypto.subtle.digest("SHA-512",new Uint8Array([0])),I(At),he]:[he,I(he),he]),he=At[0],yt=At[1],yt=yt&&yt.then,Ve=he&&he.constructor,Rn=!!At[2],Tt=function(e,t){Bt.push([e,t]),Yt&&(queueMicrotask(Ka),Yt=!1)},Nn=!0,Yt=!0,Xe=[],Gt=[],Fn=It,De={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:ne,pgp:!1,env:{},finalize:ne},U=De,Bt=[],We=0,Qt=[];function q(e){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var t=this._PSD=U;if(typeof e!="function"){if(e!==$t)throw new TypeError("Not a function");this._state=arguments[1],this._value=arguments[2],this._state===!1&&Un(this,this._value)}else this._state=null,this._value=null,++t.ref,(function n(r,a){try{a(function(s){if(r._state===null){if(s===r)throw new TypeError("A promise cannot be resolved with itself.");var l=r._lib&&ut();s&&typeof s.then=="function"?n(r,function(f,b){s instanceof q?s._then(f,b):s.then(f,b)}):(r._state=!0,r._value=s,Qr(r)),l&&dt()}},Un.bind(null,r))}catch(s){Un(r,s)}})(this,e)}var zn={get:function(){var e=U,t=tn;function n(r,a){var s=this,l=!e.global&&(e!==U||t!==tn),f=l&&!Ke(),b=new q(function(x,w){Hn(s,new Gr(Zr(r,e,l,f),Zr(a,e,l,f),x,w,e))});return this._consoleTask&&(b._consoleTask=this._consoleTask),b}return n.prototype=$t,n},set:function(e){V(this,"then",e&&e.prototype===$t?zn:{get:function(){return e},set:zn.set})}};function Gr(e,t,n,r,a){this.onFulfilled=typeof e=="function"?e:null,this.onRejected=typeof t=="function"?t:null,this.resolve=n,this.reject=r,this.psd=a}function Un(e,t){var n,r;Gt.push(t),e._state===null&&(n=e._lib&&ut(),t=Fn(t),e._state=!1,e._value=t,r=e,Xe.some(function(a){return a._value===r._value})||Xe.push(r),Qr(e),n)&&dt()}function Qr(e){var t=e._listeners;e._listeners=[];for(var n=0,r=t.length;n<r;++n)Hn(e,t[n]);var a=e._PSD;--a.ref||a.finalize(),We===0&&(++We,Tt(function(){--We==0&&Vn()},[]))}function Hn(e,t){if(e._state===null)e._listeners.push(t);else{var n=e._state?t.onFulfilled:t.onRejected;if(n===null)return(e._state?t.resolve:t.reject)(e._value);++t.psd.ref,++We,Tt(Oa,[n,e,t])}}function Oa(e,t,n){try{var r,a=t._value;!t._state&&Gt.length&&(Gt=[]),r=Ee&&t._consoleTask?t._consoleTask.run(function(){return e(a)}):e(a),t._state||Gt.indexOf(a)!==-1||(s=>{for(var l=Xe.length;l;)if(Xe[--l]._value===s._value)return Xe.splice(l,1)})(t),n.resolve(r)}catch(s){n.reject(s)}finally{--We==0&&Vn(),--n.psd.ref||n.psd.finalize()}}function Ka(){Ye(De,function(){ut()&&dt()})}function ut(){var e=Nn;return Yt=Nn=!1,e}function dt(){var e,t,n;do for(;0<Bt.length;)for(e=Bt,Bt=[],n=e.length,t=0;t<n;++t){var r=e[t];r[0].apply(null,r[1])}while(0<Bt.length);Yt=Nn=!0}function Vn(){for(var e=Xe,t=(Xe=[],e.forEach(function(r){r._PSD.onunhandled.call(null,r._value,r)}),Qt.slice(0)),n=t.length;n;)t[--n]()}function Jt(e){return new q($t,!1,e)}function ie(e,t){var n=U;return function(){var r=ut(),a=U;try{return Me(n,!0),e.apply(this,arguments)}catch(s){t&&t(s)}finally{Me(a,!1),r&&dt()}}}A(q.prototype,{then:zn,_then:function(e,t){Hn(this,new Gr(null,null,e,t,U))},catch:function(e){var t,n;return arguments.length===1?this.then(null,e):(t=e,n=arguments[1],typeof t=="function"?this.then(null,function(r){return(r instanceof t?n:Jt)(r)}):this.then(null,function(r){return(r&&r.name===t?n:Jt)(r)}))},finally:function(e){return this.then(function(t){return q.resolve(e()).then(function(){return t})},function(t){return q.resolve(e()).then(function(){return Jt(t)})})},timeout:function(e,t){var n=this;return e<1/0?new q(function(r,a){var s=setTimeout(function(){return a(new H.Timeout(t))},e);n.then(r,a).finally(clearTimeout.bind(null,s))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&V(q.prototype,Symbol.toStringTag,"Dexie.Promise"),De.env=Jr(),A(q,{all:function(){var e=$e.apply(null,arguments).map(nn);return new q(function(t,n){e.length===0&&t([]);var r=e.length;e.forEach(function(a,s){return q.resolve(a).then(function(l){e[s]=l,--r||t(e)},n)})})},resolve:function(e){return e instanceof q?e:e&&typeof e.then=="function"?new q(function(t,n){e.then(t,n)}):new q($t,!0,e)},reject:Jt,race:function(){var e=$e.apply(null,arguments).map(nn);return new q(function(t,n){e.map(function(r){return q.resolve(r).then(t,n)})})},PSD:{get:function(){return U},set:function(e){return U=e}},totalEchoes:{get:function(){return tn}},newPSD:Oe,usePSD:Ye,scheduler:{get:function(){return Tt},set:function(e){Tt=e}},rejectionMapper:{get:function(){return Fn},set:function(e){Fn=e}},follow:function(e,t){return new q(function(n,r){return Oe(function(a,s){var l=U;l.unhandleds=[],l.onunhandled=s,l.finalize=He(function(){var f,b=this;f=function(){b.unhandleds.length===0?a():s(b.unhandleds[0])},Qt.push(function x(){f(),Qt.splice(Qt.indexOf(x),1)}),++We,Tt(function(){--We==0&&Vn()},[])},l.finalize),e()},t,n,r)})}}),Ve&&(Ve.allSettled&&V(q,"allSettled",function(){var e=$e.apply(null,arguments).map(nn);return new q(function(t){e.length===0&&t([]);var n=e.length,r=new Array(n);e.forEach(function(a,s){return q.resolve(a).then(function(l){return r[s]={status:"fulfilled",value:l}},function(l){return r[s]={status:"rejected",reason:l}}).then(function(){return--n||t(r)})})})}),Ve.any&&typeof AggregateError<"u"&&V(q,"any",function(){var e=$e.apply(null,arguments).map(nn);return new q(function(t,n){e.length===0&&n(new AggregateError([]));var r=e.length,a=new Array(r);e.forEach(function(s,l){return q.resolve(s).then(function(f){return t(f)},function(f){a[l]=f,--r||n(new AggregateError(a))})})})}),Ve.withResolvers)&&(q.withResolvers=Ve.withResolvers);var ue={awaits:0,echoes:0,id:0},Ma=0,Zt=[],en=0,tn=0,ja=0;function Oe(e,l,n,r){var a=U,s=Object.create(a),l=(s.parent=a,s.ref=0,s.global=!1,s.id=++ja,De.env,s.env=Rn?{Promise:q,PromiseProp:{value:q,configurable:!0,writable:!0},all:q.all,race:q.race,allSettled:q.allSettled,any:q.any,resolve:q.resolve,reject:q.reject}:{},l&&v(s,l),++a.ref,s.finalize=function(){--this.parent.ref||this.parent.finalize()},Ye(s,e,n,r));return s.ref===0&&s.finalize(),l}function ft(){return ue.id||(ue.id=++Ma),++ue.awaits,ue.echoes+=Yr,ue.id}function Ke(){return!!ue.awaits&&(--ue.awaits==0&&(ue.id=0),ue.echoes=ue.awaits*Yr,!0)}function nn(e){return ue.echoes&&e&&e.constructor===Ve?(ft(),e.then(function(t){return Ke(),t},function(t){return Ke(),ce(t)})):e}function qa(){var e=Zt[Zt.length-1];Zt.pop(),Me(e,!1)}function Me(e,t){var n,r,a=U;(t?!ue.echoes||en++&&e===U:!en||--en&&e===U)||queueMicrotask(t?(function(s){++tn,ue.echoes&&--ue.echoes!=0||(ue.echoes=ue.awaits=ue.id=0),Zt.push(U),Me(s,!0)}).bind(null,e):qa),e!==U&&(U=e,a===De&&(De.env=Jr()),Rn)&&(n=De.env.Promise,r=e.env,a.global||e.global)&&(Object.defineProperty(p,"Promise",r.PromiseProp),n.all=r.all,n.race=r.race,n.resolve=r.resolve,n.reject=r.reject,r.allSettled&&(n.allSettled=r.allSettled),r.any)&&(n.any=r.any)}function Jr(){var e=p.Promise;return Rn?{Promise:e,PromiseProp:Object.getOwnPropertyDescriptor(p,"Promise"),all:e.all,race:e.race,allSettled:e.allSettled,any:e.any,resolve:e.resolve,reject:e.reject}:{}}function Ye(e,t,n,r,a){var s=U;try{return Me(e,!0),t(n,r,a)}finally{Me(s,!1)}}function Zr(e,t,n,r){return typeof e!="function"?e:function(){var a=U;n&&ft(),Me(t,!0);try{return e.apply(this,arguments)}finally{Me(a,!1),r&&queueMicrotask(Ke)}}}function Xn(e){Promise===Ve&&ue.echoes===0?en===0?e():enqueueNativeMicroTask(e):setTimeout(e,0)}(""+yt).indexOf("[native code]")===-1&&(ft=Ke=ne);var ce=q.reject,Ge="ï¿¿",Te="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",ei="String expected.",pt=[],rn="__dbnames",Wn="readonly",Yn="readwrite";function Qe(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}var ti={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function an(e){return typeof e!="string"||/\./.test(e)?function(t){return t}:function(t){return t[e]===void 0&&e in t&&delete(t=ze(t))[e],t}}function ni(){throw H.Type("Entity instances must never be new:ed. Instances are generated by the framework bypassing the constructor.")}function Q(e,t){try{var n=ri(e),r=ri(t);if(n!==r)return n==="Array"?1:r==="Array"?-1:n==="binary"?1:r==="binary"?-1:n==="string"?1:r==="string"?-1:n==="Date"?1:r!=="Date"?NaN:-1;switch(n){case"number":case"Date":case"string":return t<e?1:e<t?-1:0;case"binary":for(var a=ii(e),s=ii(t),l=a.length,f=s.length,b=l<f?l:f,x=0;x<b;++x)if(a[x]!==s[x])return a[x]<s[x]?-1:1;return l===f?0:l<f?-1:1;case"Array":for(var w=e,y=t,S=w.length,_=y.length,k=S<_?S:_,g=0;g<k;++g){var P=Q(w[g],y[g]);if(P!==0)return P}return S===_?0:S<_?-1:1}}catch{}return NaN}function ri(e){var t=typeof e;return t=="object"&&(ArrayBuffer.isView(e)||(t=On(e))==="ArrayBuffer")?"binary":t}function ii(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}function on(e,t,n){var r=e.schema.yProps;return r?(t&&0<n.numFailures&&(t=t.filter(function(a,s){return!n.failures[s]})),Promise.all(r.map(function(a){return a=a.updatesTable,t?e.db.table(a).where("k").anyOf(t).delete():e.db.table(a).clear()})).then(function(){return n})):n}ai.prototype.execute=function(e){var t=this["@@propmod"];if(t.add!==void 0){var n=t.add;if(m(n))return u(u([],m(e)?e:[],!0),n).sort();if(typeof n=="number")return(Number(e)||0)+n;if(typeof n=="bigint")try{return BigInt(e)+n}catch{return BigInt(0)+n}throw new TypeError("Invalid term ".concat(n))}if(t.remove!==void 0){var r=t.remove;if(m(r))return m(e)?e.filter(function(a){return!r.includes(a)}).sort():[];if(typeof r=="number")return Number(e)-r;if(typeof r=="bigint")try{return BigInt(e)-r}catch{return BigInt(0)-r}throw new TypeError("Invalid subtrahend ".concat(r))}return n=(n=t.replacePrefix)==null?void 0:n[0],n&&typeof e=="string"&&e.startsWith(n)?t.replacePrefix[1]+e.substring(n.length):e};var Ct=ai;function ai(e){this["@@propmod"]=e}function oi(e,t){for(var n=h(t),r=n.length,a=!1,s=0;s<r;++s){var l=n[s],f=t[l],b=ke(e,l);f instanceof Ct?(pe(e,l,f.execute(b)),a=!0):b!==f&&(pe(e,l,f),a=!0)}return a}re.prototype._trans=function(e,t,n){var r=this._tx||U.trans,a=this.name,s=Ee&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(e==="readonly"?"read":"write"," ").concat(this.name));function l(x,w,y){if(y.schema[a])return t(y.idbtrans,y);throw new H.NotFound("Table "+a+" not part of transaction")}var f=ut();try{var b=r&&r.db._novip===this.db._novip?r===U.trans?r._promise(e,l,n):Oe(function(){return r._promise(e,l,n)},{trans:r,transless:U.transless||U}):(function x(w,y,S,_){if(w.idbdb&&(w._state.openComplete||U.letThrough||w._vip)){var k=w._createTransaction(y,S,w._dbSchema);try{k.create(),w._state.PR1398_maxLoop=3}catch(g){return g.name===jn.InvalidState&&w.isOpen()&&0<--w._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),w.close({disableAutoOpen:!1}),w.open().then(function(){return x(w,y,S,_)})):ce(g)}return k._promise(y,function(g,P){return Oe(function(){return U.trans=k,_(g,P,k)})}).then(function(g){if(y==="readwrite")try{k.idbtrans.commit()}catch{}return y==="readonly"?g:k._completion.then(function(){return g})})}if(w._state.openComplete)return ce(new H.DatabaseClosed(w._state.dbOpenError));if(!w._state.isBeingOpened){if(!w._state.autoOpen)return ce(new H.DatabaseClosed);w.open().catch(ne)}return w._state.dbReadyPromise.then(function(){return x(w,y,S,_)})})(this.db,e,[this.name],l);return s&&(b._consoleTask=s,b=b.catch(function(x){return console.trace(x),ce(x)})),b}finally{f&&dt()}},re.prototype.get=function(e,t){var n=this;return e&&e.constructor===Object?this.where(e).first(t):e==null?ce(new H.Type("Invalid argument to Table.get()")):this._trans("readonly",function(r){return n.core.get({trans:r,key:e}).then(function(a){return n.hook.reading.fire(a)})}).then(t)},re.prototype.where=function(e){if(typeof e=="string")return new this.db.WhereClause(this,e);if(m(e))return new this.db.WhereClause(this,"[".concat(e.join("+"),"]"));var t=h(e);if(t.length===1)return this.where(t[0]).equals(e[t[0]]);var n=this.schema.indexes.concat(this.schema.primKey).filter(function(f){if(f.compound&&t.every(function(x){return 0<=f.keyPath.indexOf(x)})){for(var b=0;b<t.length;++b)if(t.indexOf(f.keyPath[b])===-1)return!1;return!0}return!1}).sort(function(f,b){return f.keyPath.length-b.keyPath.length})[0];if(n&&this.db._maxKey!==Ge)return l=n.keyPath.slice(0,t.length),this.where(l).equals(l.map(function(f){return e[f]}));!n&&Ee&&console.warn("The query ".concat(JSON.stringify(e)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(t.join("+"),"]"));var r=this.schema.idxByName;function a(f,b){return Q(f,b)===0}var l=t.reduce(function(w,b){var x=w[0],w=w[1],y=r[b],S=e[b];return[x||y,x||!y?Qe(w,y&&y.multi?function(_){return _=ke(_,b),m(_)&&_.some(function(k){return a(S,k)})}:function(_){return a(S,ke(_,b))}):w]},[null,null]),s=l[0],l=l[1];return s?this.where(s.name).equals(e[s.keyPath]).filter(l):n?this.filter(l):this.where(t).equals("")},re.prototype.filter=function(e){return this.toCollection().and(e)},re.prototype.count=function(e){return this.toCollection().count(e)},re.prototype.offset=function(e){return this.toCollection().offset(e)},re.prototype.limit=function(e){return this.toCollection().limit(e)},re.prototype.each=function(e){return this.toCollection().each(e)},re.prototype.toArray=function(e){return this.toCollection().toArray(e)},re.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},re.prototype.orderBy=function(e){return new this.db.Collection(new this.db.WhereClause(this,m(e)?"[".concat(e.join("+"),"]"):e))},re.prototype.reverse=function(){return this.toCollection().reverse()},re.prototype.mapToClass=function(e){for(var t=this.db,n=this.name,r=((this.schema.mappedClass=e).prototype instanceof ni&&(e=(l=>{var f=w,b=l;if(typeof b!="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function x(){this.constructor=f}function w(){return l!==null&&l.apply(this,arguments)||this}return d(f,b),f.prototype=b===null?Object.create(b):(x.prototype=b.prototype,new x),Object.defineProperty(w.prototype,"db",{get:function(){return t},enumerable:!1,configurable:!0}),w.prototype.table=function(){return n},w})(e)),new Set),a=e.prototype;a;a=I(a))Object.getOwnPropertyNames(a).forEach(function(l){return r.add(l)});function s(l){if(!l)return l;var f,b=Object.create(e.prototype);for(f in l)if(!r.has(f))try{b[f]=l[f]}catch{}return b}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=s,this.hook("reading",s),e},re.prototype.defineClass=function(){return this.mapToClass(function(e){v(this,e)})},re.prototype.add=function(e,t){var n=this,r=this.schema.primKey,a=r.auto,s=r.keyPath,l=e;return s&&a&&(l=an(s)(e)),this._trans("readwrite",function(f){return n.core.mutate({trans:f,type:"add",keys:t!=null?[t]:null,values:[l]})}).then(function(f){return f.numFailures?q.reject(f.failures[0]):f.lastResult}).then(function(f){if(s)try{pe(e,s,f)}catch{}return f})},re.prototype.upsert=function(e,t){var n=this,r=this.schema.primKey.keyPath;return this._trans("readwrite",function(a){return n.core.get({trans:a,key:e}).then(function(s){var l=s??{};return oi(l,t),r&&pe(l,r,e),n.core.mutate({trans:a,type:"put",values:[l],keys:[e],upsert:!0,updates:{keys:[e],changeSpecs:[t]}}).then(function(f){return f.numFailures?q.reject(f.failures[0]):!!s})})})},re.prototype.update=function(e,t){return typeof e!="object"||m(e)?this.where(":id").equals(e).modify(t):(e=ke(e,this.schema.primKey.keyPath))===void 0?ce(new H.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(e).modify(t)},re.prototype.put=function(e,t){var n=this,r=this.schema.primKey,a=r.auto,s=r.keyPath,l=e;return s&&a&&(l=an(s)(e)),this._trans("readwrite",function(f){return n.core.mutate({trans:f,type:"put",values:[l],keys:t!=null?[t]:null})}).then(function(f){return f.numFailures?q.reject(f.failures[0]):f.lastResult}).then(function(f){if(s)try{pe(e,s,f)}catch{}return f})},re.prototype.delete=function(e){var t=this;return this._trans("readwrite",function(n){return t.core.mutate({trans:n,type:"delete",keys:[e]}).then(function(r){return on(t,[e],r)}).then(function(r){return r.numFailures?q.reject(r.failures[0]):void 0})})},re.prototype.clear=function(){var e=this;return this._trans("readwrite",function(t){return e.core.mutate({trans:t,type:"deleteRange",range:ti}).then(function(n){return on(e,null,n)})}).then(function(t){return t.numFailures?q.reject(t.failures[0]):void 0})},re.prototype.bulkGet=function(e){var t=this;return this._trans("readonly",function(n){return t.core.getMany({keys:e,trans:n}).then(function(r){return r.map(function(a){return t.hook.reading.fire(a)})})})},re.prototype.bulkAdd=function(e,t,n){var r=this,a=Array.isArray(t)?t:void 0,s=(n=n||(a?void 0:t))?n.allKeys:void 0;return this._trans("readwrite",function(l){var f=r.schema.primKey,x=f.auto,f=f.keyPath;if(f&&a)throw new H.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(a&&a.length!==e.length)throw new H.InvalidArgument("Arguments objects and keys must have the same length");var b=e.length,x=f&&x?e.map(an(f)):e;return r.core.mutate({trans:l,type:"add",keys:a,values:x,wantResults:s}).then(function(w){var y=w.numFailures,S=w.failures;if(y===0)return s?w.results:w.lastResult;throw new lt("".concat(r.name,".bulkAdd(): ").concat(y," of ").concat(b," operations failed"),S)})})},re.prototype.bulkPut=function(e,t,n){var r=this,a=Array.isArray(t)?t:void 0,s=(n=n||(a?void 0:t))?n.allKeys:void 0;return this._trans("readwrite",function(l){var f=r.schema.primKey,x=f.auto,f=f.keyPath;if(f&&a)throw new H.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(a&&a.length!==e.length)throw new H.InvalidArgument("Arguments objects and keys must have the same length");var b=e.length,x=f&&x?e.map(an(f)):e;return r.core.mutate({trans:l,type:"put",keys:a,values:x,wantResults:s}).then(function(w){var y=w.numFailures,S=w.failures;if(y===0)return s?w.results:w.lastResult;throw new lt("".concat(r.name,".bulkPut(): ").concat(y," of ").concat(b," operations failed"),S)})})},re.prototype.bulkUpdate=function(e){var t=this,n=this.core,r=e.map(function(l){return l.key}),a=e.map(function(l){return l.changes}),s=[];return this._trans("readwrite",function(l){return n.getMany({trans:l,keys:r,cache:"clone"}).then(function(f){var b=[],x=[],w=(e.forEach(function(y,S){var _=y.key,k=y.changes,g=f[S];if(g){for(var P=0,L=Object.keys(k);P<L.length;P++){var E=L[P],T=k[E];if(E===t.schema.primKey.keyPath){if(Q(T,_)!==0)throw new H.Constraint("Cannot update primary key in bulkUpdate()")}else pe(g,E,T)}s.push(S),b.push(_),x.push(g)}}),b.length);return n.mutate({trans:l,type:"put",keys:b,values:x,updates:{keys:r,changeSpecs:a}}).then(function(y){var S=y.numFailures,_=y.failures;if(S===0)return w;for(var k=0,g=Object.keys(_);k<g.length;k++){var P,L=g[k],E=s[Number(L)];E!=null&&(P=_[L],delete _[L],_[E]=P)}throw new lt("".concat(t.name,".bulkUpdate(): ").concat(S," of ").concat(w," operations failed"),_)})})})},re.prototype.bulkDelete=function(e){var t=this,n=e.length;return this._trans("readwrite",function(r){return t.core.mutate({trans:r,type:"delete",keys:e}).then(function(a){return on(t,e,a)})}).then(function(r){var a=r.numFailures,s=r.failures;if(a===0)return r.lastResult;throw new lt("".concat(t.name,".bulkDelete(): ").concat(a," of ").concat(n," operations failed"),s)})};var si=re;function re(){}function Dt(e){function t(l,f){if(f){for(var b=arguments.length,x=new Array(b-1);--b;)x[b-1]=arguments[b];return n[l].subscribe.apply(null,x),e}if(typeof l=="string")return n[l]}var n={};t.addEventType=s;for(var r=1,a=arguments.length;r<a;++r)s(arguments[r]);return t;function s(l,f,b){var x,w;if(typeof l!="object")return f=f||Da,w={subscribers:[],fire:b=b||ne,subscribe:function(y){w.subscribers.indexOf(y)===-1&&(w.subscribers.push(y),w.fire=f(w.fire,y))},unsubscribe:function(y){w.subscribers=w.subscribers.filter(function(S){return S!==y}),w.fire=w.subscribers.reduce(f,b)}},n[l]=t[l]=w;h(x=l).forEach(function(y){var S=x[y];if(m(S))s(y,x[y][0],x[y][1]);else{if(S!=="asap")throw new H.InvalidArgument("Invalid event config");var _=s(y,It,function(){for(var k=arguments.length,g=new Array(k);k--;)g[k]=arguments[k];_.subscribers.forEach(function(P){Xt(function(){P.apply(null,g)})})})}})}}function Ot(e,t){return N(t).from({prototype:e}),t}function ht(e,t){return!(e.filter||e.algorithm||e.or)&&(t?e.justLimit:!e.replayFilter)}function Gn(e,t){e.filter=Qe(e.filter,t)}function Qn(e,t,n){var r=e.replayFilter;e.replayFilter=r?function(){return Qe(r(),t())}:t,e.justLimit=n&&!r}function sn(e,t){if(e.isPrimKey)return t.primaryKey;var n=t.getIndexByKeyPath(e.index);if(n)return n;throw new H.Schema("KeyPath "+e.index+" on object store "+t.name+" is not indexed")}function ci(e,t,n){var r=sn(e,t.schema);return t.openCursor({trans:n,values:!e.keysOnly,reverse:e.dir==="prev",unique:!!e.unique,query:{index:r,range:e.range}})}function cn(e,t,n,r){var a,s,l=e.replayFilter?Qe(e.filter,e.replayFilter()):e.filter;return e.or?(a={},s=function(f,b,x){var w,y;l&&!l(b,x,function(S){return b.stop(S)},function(S){return b.fail(S)})||((y=""+(w=b.primaryKey))=="[object ArrayBuffer]"&&(y=""+new Uint8Array(w)),C(a,y))||(a[y]=!0,t(f,b,x))},Promise.all([e.or._iterate(s,n),li(ci(e,r,n),e.algorithm,s,!e.keysOnly&&e.valueMapper)])):li(ci(e,r,n),Qe(e.algorithm,l),t,!e.keysOnly&&e.valueMapper)}function li(e,t,n,r){var a=ie(r?function(s,l,f){return n(r(s),l,f)}:n);return e.then(function(s){if(s)return s.start(function(){var l=function(){return s.continue()};t&&!t(s,function(f){return l=f},function(f){s.stop(f),l=ne},function(f){s.fail(f),l=ne})||a(s.value,s,function(f){return l=f}),l()})})}ee.prototype._read=function(e,t){var n=this._ctx;return n.error?n.table._trans(null,ce.bind(null,n.error)):n.table._trans("readonly",e).then(t)},ee.prototype._write=function(e){var t=this._ctx;return t.error?t.table._trans(null,ce.bind(null,t.error)):t.table._trans("readwrite",e,"locked")},ee.prototype._addAlgorithm=function(e){var t=this._ctx;t.algorithm=Qe(t.algorithm,e)},ee.prototype._iterate=function(e,t){return cn(this._ctx,e,t,this._ctx.table.core)},ee.prototype.clone=function(e){var t=Object.create(this.constructor.prototype),n=Object.create(this._ctx);return e&&v(n,e),t._ctx=n,t},ee.prototype.raw=function(){return this._ctx.valueMapper=null,this},ee.prototype.each=function(e){var t=this._ctx;return this._read(function(n){return cn(t,e,n,t.table.core)})},ee.prototype.count=function(e){var t=this;return this._read(function(n){var r,a=t._ctx,s=a.table.core;return ht(a,!0)?s.count({trans:n,query:{index:sn(a,s.schema),range:a.range}}).then(function(l){return Math.min(l,a.limit)}):(r=0,cn(a,function(){return++r,!1},n,s).then(function(){return r}))}).then(e)},ee.prototype.sortBy=function(e,t){var n=e.split(".").reverse(),r=n[0],a=n.length-1;function s(b,x){return x?s(b[n[x]],x-1):b[r]}var l=this._ctx.dir==="next"?1:-1;function f(b,x){return Q(s(b,a),s(x,a))*l}return this.toArray(function(b){return b.sort(f)}).then(t)},ee.prototype.toArray=function(e){var t=this;return this._read(function(n){var r,a,s,l=t._ctx;return l.dir==="next"&&ht(l,!0)&&0<l.limit?(r=l.valueMapper,a=sn(l,l.table.core.schema),l.table.core.query({trans:n,limit:l.limit,values:!0,query:{index:a,range:l.range}}).then(function(f){return f=f.result,r?f.map(r):f})):(s=[],cn(l,function(f){return s.push(f)},n,l.table.core).then(function(){return s}))},e)},ee.prototype.offset=function(e){var t=this._ctx;return e<=0||(t.offset+=e,ht(t)?Qn(t,function(){var n=e;return function(r,a){return n===0||(n===1?--n:a(function(){r.advance(n),n=0}),!1)}}):Qn(t,function(){var n=e;return function(){return--n<0}})),this},ee.prototype.limit=function(e){return this._ctx.limit=Math.min(this._ctx.limit,e),Qn(this._ctx,function(){var t=e;return function(n,r,a){return--t<=0&&r(a),0<=t}},!0),this},ee.prototype.until=function(e,t){return Gn(this._ctx,function(n,r,a){return!e(n.value)||(r(a),t)}),this},ee.prototype.first=function(e){return this.limit(1).toArray(function(t){return t[0]}).then(e)},ee.prototype.last=function(e){return this.reverse().first(e)},ee.prototype.filter=function(e){var t;return Gn(this._ctx,function(n){return e(n.value)}),(t=this._ctx).isMatch=Qe(t.isMatch,e),this},ee.prototype.and=function(e){return this.filter(e)},ee.prototype.or=function(e){return new this.db.WhereClause(this._ctx.table,e,this)},ee.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},ee.prototype.desc=function(){return this.reverse()},ee.prototype.eachKey=function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(n,r){e(r.key,r)})},ee.prototype.eachUniqueKey=function(e){return this._ctx.unique="unique",this.eachKey(e)},ee.prototype.eachPrimaryKey=function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(n,r){e(r.primaryKey,r)})},ee.prototype.keys=function(e){var t=this._ctx,n=(t.keysOnly=!t.isMatch,[]);return this.each(function(r,a){n.push(a.key)}).then(function(){return n}).then(e)},ee.prototype.primaryKeys=function(e){var t=this._ctx;if(t.dir==="next"&&ht(t,!0)&&0<t.limit)return this._read(function(r){var a=sn(t,t.table.core.schema);return t.table.core.query({trans:r,values:!1,limit:t.limit,query:{index:a,range:t.range}})}).then(function(r){return r.result}).then(e);t.keysOnly=!t.isMatch;var n=[];return this.each(function(r,a){n.push(a.primaryKey)}).then(function(){return n}).then(e)},ee.prototype.uniqueKeys=function(e){return this._ctx.unique="unique",this.keys(e)},ee.prototype.firstKey=function(e){return this.limit(1).keys(function(t){return t[0]}).then(e)},ee.prototype.lastKey=function(e){return this.reverse().firstKey(e)},ee.prototype.distinct=function(){var e,t=this._ctx,t=t.index&&t.table.schema.idxByName[t.index];return t&&t.multi&&(e={},Gn(this._ctx,function(r){var r=r.primaryKey.toString(),a=C(e,r);return e[r]=!0,!a})),this},ee.prototype.modify=function(e){var t=this,n=this._ctx;return this._write(function(r){function a(g,P){var L=P.failures;S+=g-P.numFailures;for(var E=0,T=h(L);E<T.length;E++){var D=T[E];y.push(L[D])}}var s=typeof e=="function"?e:function(g){return oi(g,e)},l=n.table.core,w=l.schema.primaryKey,f=w.outbound,b=w.extractKey,x=200,w=t.db._options.modifyChunkSize,y=(w&&(x=typeof w=="object"?w[l.name]||w["*"]||200:w),[]),S=0,_=[],k=e===ui;return t.clone().primaryKeys().then(function(g){function P(E){var T=Math.min(x,g.length-E),D=g.slice(E,E+T);return(k?Promise.resolve([]):l.getMany({trans:r,keys:D,cache:"immutable"})).then(function(M){var j=[],O=[],F=f?[]:null,R=k?D:[];if(!k)for(var K=0;K<T;++K){var z=M[K],J={value:ze(z),primKey:g[E+K]};s.call(J,J.value,J)!==!1&&(J.value==null?R.push(g[E+K]):f||Q(b(z),b(J.value))===0?(O.push(J.value),f&&F.push(g[E+K])):(R.push(g[E+K]),j.push(J.value)))}return Promise.resolve(0<j.length&&l.mutate({trans:r,type:"add",values:j}).then(function(te){for(var X in te.failures)R.splice(parseInt(X),1);a(j.length,te)})).then(function(){return(0<O.length||L&&typeof e=="object")&&l.mutate({trans:r,type:"put",keys:F,values:O,criteria:L,changeSpec:typeof e!="function"&&e,isAdditionalChunk:0<E}).then(function(te){return a(O.length,te)})}).then(function(){return(0<R.length||L&&k)&&l.mutate({trans:r,type:"delete",keys:R,criteria:L,isAdditionalChunk:0<E}).then(function(te){return on(n.table,R,te)}).then(function(te){return a(R.length,te)})}).then(function(){return g.length>E+T&&P(E+x)})})}var L=ht(n)&&n.limit===1/0&&(typeof e!="function"||k)&&{index:n.index,range:n.range};return P(0).then(function(){if(0<y.length)throw new Wt("Error modifying one or more objects",y,S,_);return g.length})})})},ee.prototype.delete=function(){var e=this._ctx,t=e.range;return!ht(e)||e.table.schema.yProps||!e.isPrimKey&&t.type!==3?this.modify(ui):this._write(function(n){var r=e.table.core.schema.primaryKey,a=t;return e.table.core.count({trans:n,query:{index:r,range:a}}).then(function(s){return e.table.core.mutate({trans:n,type:"deleteRange",range:a}).then(function(b){var f=b.failures,b=b.numFailures;if(b)throw new Wt("Could not delete some values",Object.keys(f).map(function(x){return f[x]}),s-b);return s-b})})})};var Ra=ee;function ee(){}var ui=function(e,t){return t.value=null};function Na(e,t){return e<t?-1:e===t?0:1}function Fa(e,t){return t<e?-1:e===t?0:1}function me(e,t,n){return e=e instanceof fi?new e.Collection(e):e,e._ctx.error=new(n||TypeError)(t),e}function mt(e){return new e.Collection(e,function(){return di("")}).limit(0)}function ln(_,t,n,r){var a,s,l,f,b,x,w,y=n.length;if(!n.every(function(g){return typeof g=="string"}))return me(_,ei);function S(g){a=g==="next"?function(L){return L.toUpperCase()}:function(L){return L.toLowerCase()},s=g==="next"?function(L){return L.toLowerCase()}:function(L){return L.toUpperCase()},l=g==="next"?Na:Fa;var P=n.map(function(L){return{lower:s(L),upper:a(L)}}).sort(function(L,E){return l(L.lower,E.lower)});f=P.map(function(L){return L.upper}),b=P.map(function(L){return L.lower}),w=(x=g)==="next"?"":r}S("next");var _=new _.Collection(_,function(){return je(f[0],b[y-1]+r)}),k=(_._ondirectionchange=function(g){S(g)},0);return _._addAlgorithm(function(g,P,L){var E=g.key;if(typeof E=="string"){var T=s(E);if(t(T,b,k))return!0;for(var D=null,M=k;M<y;++M){var j=((O,F,R,K,z,J)=>{for(var te=Math.min(O.length,K.length),X=-1,G=0;G<te;++G){var oe=F[G];if(oe!==K[G])return z(O[G],R[G])<0?O.substr(0,G)+R[G]+R.substr(G+1):z(O[G],K[G])<0?O.substr(0,G)+K[G]+R.substr(G+1):0<=X?O.substr(0,X)+F[X]+R.substr(X+1):null;z(O[G],oe)<0&&(X=G)}return te<K.length&&J==="next"?O+R.substr(O.length):te<O.length&&J==="prev"?O.substr(0,R.length):X<0?null:O.substr(0,X)+K[X]+R.substr(X+1)})(E,T,f[M],b[M],l,x);j===null&&D===null?k=M+1:(D===null||0<l(D,j))&&(D=j)}P(D!==null?function(){g.continue(D+w)}:L)}return!1}),_}function je(e,t,n,r){return{type:2,lower:e,upper:t,lowerOpen:n,upperOpen:r}}function di(e){return{type:1,lower:e,upper:e}}Object.defineProperty(de.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),de.prototype.between=function(e,t,n,r){n=n!==!1,r=r===!0;try{return 0<this._cmp(e,t)||this._cmp(e,t)===0&&(n||r)&&(!n||!r)?mt(this):new this.Collection(this,function(){return je(e,t,!n,!r)})}catch{return me(this,Te)}},de.prototype.equals=function(e){return e==null?me(this,Te):new this.Collection(this,function(){return di(e)})},de.prototype.above=function(e){return e==null?me(this,Te):new this.Collection(this,function(){return je(e,void 0,!0)})},de.prototype.aboveOrEqual=function(e){return e==null?me(this,Te):new this.Collection(this,function(){return je(e,void 0,!1)})},de.prototype.below=function(e){return e==null?me(this,Te):new this.Collection(this,function(){return je(void 0,e,!1,!0)})},de.prototype.belowOrEqual=function(e){return e==null?me(this,Te):new this.Collection(this,function(){return je(void 0,e)})},de.prototype.startsWith=function(e){return typeof e!="string"?me(this,ei):this.between(e,e+Ge,!0,!0)},de.prototype.startsWithIgnoreCase=function(e){return e===""?this.startsWith(e):ln(this,function(t,n){return t.indexOf(n[0])===0},[e],Ge)},de.prototype.equalsIgnoreCase=function(e){return ln(this,function(t,n){return t===n[0]},[e],"")},de.prototype.anyOfIgnoreCase=function(){var e=$e.apply(st,arguments);return e.length===0?mt(this):ln(this,function(t,n){return n.indexOf(t)!==-1},e,"")},de.prototype.startsWithAnyOfIgnoreCase=function(){var e=$e.apply(st,arguments);return e.length===0?mt(this):ln(this,function(t,n){return n.some(function(r){return t.indexOf(r)===0})},e,Ge)},de.prototype.anyOf=function(){var e,t,n=this,r=$e.apply(st,arguments),a=this._cmp;try{r.sort(a)}catch{return me(this,Te)}return r.length===0?mt(this):((e=new this.Collection(this,function(){return je(r[0],r[r.length-1])}))._ondirectionchange=function(s){a=s==="next"?n._ascending:n._descending,r.sort(a)},t=0,e._addAlgorithm(function(s,l,f){for(var b=s.key;0<a(b,r[t]);)if(++t===r.length)return l(f),!1;return a(b,r[t])===0||(l(function(){s.continue(r[t])}),!1)}),e)},de.prototype.notEqual=function(e){return this.inAnyRange([[-1/0,e],[e,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},de.prototype.noneOf=function(){var e=$e.apply(st,arguments);if(e.length===0)return new this.Collection(this);try{e.sort(this._ascending)}catch{return me(this,Te)}var t=e.reduce(function(n,r){return n?n.concat([[n[n.length-1][1],r]]):[[-1/0,r]]},null);return t.push([e[e.length-1],this.db._maxKey]),this.inAnyRange(t,{includeLowers:!1,includeUppers:!1})},de.prototype.inAnyRange=function(e,L){var n=this,r=this._cmp,a=this._ascending,s=this._descending,l=this._min,f=this._max;if(e.length===0)return mt(this);if(!e.every(function(E){return E[0]!==void 0&&E[1]!==void 0&&a(E[0],E[1])<=0}))return me(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",H.InvalidArgument);var b=!L||L.includeLowers!==!1,x=L&&L.includeUppers===!0,w,y=a;function S(E,T){return y(E[0],T[0])}try{(w=e.reduce(function(E,T){for(var D=0,M=E.length;D<M;++D){var j=E[D];if(r(T[0],j[1])<0&&0<r(T[1],j[0])){j[0]=l(j[0],T[0]),j[1]=f(j[1],T[1]);break}}return D===M&&E.push(T),E},[])).sort(S)}catch{return me(this,Te)}var _=0,k=x?function(E){return 0<a(E,w[_][1])}:function(E){return 0<=a(E,w[_][1])},g=b?function(E){return 0<s(E,w[_][0])}:function(E){return 0<=s(E,w[_][0])},P=k,L=new this.Collection(this,function(){return je(w[0][0],w[w.length-1][1],!b,!x)});return L._ondirectionchange=function(E){y=E==="next"?(P=k,a):(P=g,s),w.sort(S)},L._addAlgorithm(function(E,T,D){for(var M,j=E.key;P(j);)if(++_===w.length)return T(D),!1;return!k(M=j)&&!g(M)||(n._cmp(j,w[_][1])===0||n._cmp(j,w[_][0])===0||T(function(){y===a?E.continue(w[_][0]):E.continue(w[_][1])}),!1)}),L},de.prototype.startsWithAnyOf=function(){var e=$e.apply(st,arguments);return e.every(function(t){return typeof t=="string"})?e.length===0?mt(this):this.inAnyRange(e.map(function(t){return[t,t+Ge]})):me(this,"startsWithAnyOf() only works with strings")};var fi=de;function de(){}function xe(e){return ie(function(t){return Kt(t),e(t.target.error),!1})}function Kt(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}var Mt="storagemutated",Jn="x-storagemutated-1",qe=Dt(null,Mt),za=(Pe.prototype._lock=function(){return Fe(!U.global),++this._reculock,this._reculock!==1||U.global||(U.lockOwnerFor=this),this},Pe.prototype._unlock=function(){if(Fe(!U.global),--this._reculock==0)for(U.global||(U.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var e=this._blockedFuncs.shift();try{Ye(e[1],e[0])}catch{}}return this},Pe.prototype._locked=function(){return this._reculock&&U.lockOwnerFor!==this},Pe.prototype.create=function(e){var t=this;if(this.mode){var n=this.db.idbdb,r=this.db._state.dbOpenError;if(Fe(!this.idbtrans),!e&&!n)switch(r&&r.name){case"DatabaseClosedError":throw new H.DatabaseClosed(r);case"MissingAPIError":throw new H.MissingAPI(r.message,r);default:throw new H.OpenFailed(r)}if(!this.active)throw new H.TransactionInactive;Fe(this._completion._state===null),(e=this.idbtrans=e||(this.db.core||n).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=ie(function(a){Kt(a),t._reject(e.error)}),e.onabort=ie(function(a){Kt(a),t.active&&t._reject(new H.Abort(e.error)),t.active=!1,t.on("abort").fire(a)}),e.oncomplete=ie(function(){t.active=!1,t._resolve(),"mutatedParts"in e&&qe.storagemutated.fire(e.mutatedParts)})}return this},Pe.prototype._promise=function(e,t,n){var r,a=this;return e==="readwrite"&&this.mode!=="readwrite"?ce(new H.ReadOnly("Transaction is readonly")):this.active?this._locked()?new q(function(s,l){a._blockedFuncs.push([function(){a._promise(e,t,n).then(s,l)},U])}):n?Oe(function(){var s=new q(function(l,f){a._lock();var b=t(l,f,a);b&&b.then&&b.then(l,f)});return s.finally(function(){return a._unlock()}),s._lib=!0,s}):((r=new q(function(s,l){var f=t(s,l,a);f&&f.then&&f.then(s,l)}))._lib=!0,r):ce(new H.TransactionInactive)},Pe.prototype._root=function(){return this.parent?this.parent._root():this},Pe.prototype.waitFor=function(e){var t,n=this._root(),r=q.resolve(e),a=(n._waitingFor?n._waitingFor=n._waitingFor.then(function(){return r}):(n._waitingFor=r,n._waitingQueue=[],t=n.idbtrans.objectStore(n.storeNames[0]),(function s(){for(++n._spinCount;n._waitingQueue.length;)n._waitingQueue.shift()();n._waitingFor&&(t.get(-1/0).onsuccess=s)})()),n._waitingFor);return new q(function(s,l){r.then(function(f){return n._waitingQueue.push(ie(s.bind(null,f)))},function(f){return n._waitingQueue.push(ie(l.bind(null,f)))}).finally(function(){n._waitingFor===a&&(n._waitingFor=null)})})},Pe.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new H.Abort))},Pe.prototype.table=function(e){var t=this._memoizedTables||(this._memoizedTables={});if(C(t,e))return t[e];var n=this.schema[e];if(n)return(n=new this.db.Table(e,n,this)).core=this.db.core.table(e),t[e]=n;throw new H.NotFound("Table "+e+" not part of transaction")},Pe);function Pe(){}function Zn(e,t,n,r,a,s,l,f){return{name:e,keyPath:t,unique:n,multi:r,auto:a,compound:s,src:(n&&!l?"&":"")+(r?"*":"")+(a?"++":"")+pi(t),type:f}}function pi(e){return typeof e=="string"?e:e?"["+[].join.call(e,"+")+"]":""}function er(e,t,n){return{name:e,primKey:t,indexes:n,mappedClass:null,idxByName:(r=function(a){return[a.name,a]},n.reduce(function(a,s,l){return s=r(s,l),s&&(a[s[0]]=s[1]),a},{}))};var r}var jt=function(e){try{return e.only([[]]),jt=function(){return[[]]},[[]]}catch{return jt=function(){return Ge},Ge}};function tr(e){return e==null?function(){}:typeof e=="string"?(t=e).split(".").length===1?function(n){return n[t]}:function(n){return ke(n,t)}:function(n){return ke(n,e)};var t}function hi(e){return[].slice.call(e)}var Ua=0;function qt(e){return e==null?":id":typeof e=="string"?e:"[".concat(e.join("+"),"]")}function Ha(e,t,b){function r(k){if(k.type===3)return null;if(k.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var y=k.lower,S=k.upper,_=k.lowerOpen,k=k.upperOpen;return y===void 0?S===void 0?null:t.upperBound(S,!!k):S===void 0?t.lowerBound(y,!!_):t.bound(y,S,!!_,!!k)}function a(w){var y,S=w.name;return{name:S,schema:w,mutate:function(_){var k=_.trans,g=_.type,P=_.keys,L=_.values,E=_.range;return new Promise(function(T,D){T=ie(T);var M=k.objectStore(S),j=M.keyPath==null,O=g==="put"||g==="add";if(!O&&g!=="delete"&&g!=="deleteRange")throw new Error("Invalid operation type: "+g);var F,R=(P||L||{length:1}).length;if(P&&L&&P.length!==L.length)throw new Error("Given keys array must have same length as given values array.");if(R===0)return T({numFailures:0,failures:{},results:[],lastResult:void 0});function K(se){++te,Kt(se)}var z=[],J=[],te=0;if(g==="deleteRange"){if(E.type===4)return T({numFailures:te,failures:J,results:[],lastResult:void 0});E.type===3?z.push(F=M.clear()):z.push(F=M.delete(r(E)))}else{var j=O?j?[L,P]:[L,null]:[P,null],X=j[0],G=j[1];if(O)for(var oe=0;oe<R;++oe)z.push(F=G&&G[oe]!==void 0?M[g](X[oe],G[oe]):M[g](X[oe])),F.onerror=K;else for(oe=0;oe<R;++oe)z.push(F=M[g](X[oe])),F.onerror=K}function be(se){se=se.target.result,z.forEach(function(et,br){return et.error!=null&&(J[br]=et.error)}),T({numFailures:te,failures:J,results:g==="delete"?P:z.map(function(et){return et.result}),lastResult:se})}F.onerror=function(se){K(se),be(se)},F.onsuccess=be})},getMany:function(_){var k=_.trans,g=_.keys;return new Promise(function(P,L){P=ie(P);for(var E,T=k.objectStore(S),D=g.length,M=new Array(D),j=0,O=0,F=function(z){z=z.target,M[z._pos]=z.result,++O===j&&P(M)},R=xe(L),K=0;K<D;++K)g[K]!=null&&((E=T.get(g[K]))._pos=K,E.onsuccess=F,E.onerror=R,++j);j===0&&P(M)})},get:function(_){var k=_.trans,g=_.key;return new Promise(function(P,L){P=ie(P);var E=k.objectStore(S).get(g);E.onsuccess=function(T){return P(T.target.result)},E.onerror=xe(L)})},query:(y=f,function(_){return new Promise(function(k,g){k=ie(k);var P,L,E,O=_.trans,T=_.values,D=_.limit,j=_.query,M=D===1/0?void 0:D,F=j.index,j=j.range,O=O.objectStore(S),O=F.isPrimaryKey?O:O.index(F.name),F=r(j);if(D===0)return k({result:[]});y?((j=T?O.getAll(F,M):O.getAllKeys(F,M)).onsuccess=function(R){return k({result:R.target.result})},j.onerror=xe(g)):(P=0,L=!T&&"openKeyCursor"in O?O.openKeyCursor(F):O.openCursor(F),E=[],L.onsuccess=function(R){var K=L.result;return!K||(E.push(T?K.value:K.primaryKey),++P===D)?k({result:E}):void K.continue()},L.onerror=xe(g))})}),openCursor:function(_){var k=_.trans,g=_.values,P=_.query,L=_.reverse,E=_.unique;return new Promise(function(T,D){T=ie(T);var O=P.index,M=P.range,j=k.objectStore(S),j=O.isPrimaryKey?j:j.index(O.name),O=L?E?"prevunique":"prev":E?"nextunique":"next",F=!g&&"openKeyCursor"in j?j.openKeyCursor(r(M),O):j.openCursor(r(M),O);F.onerror=xe(D),F.onsuccess=ie(function(R){var K,z,J,te,X=F.result;X?(X.___id=++Ua,X.done=!1,K=X.continue.bind(X),z=(z=X.continuePrimaryKey)&&z.bind(X),J=X.advance.bind(X),te=function(){throw new Error("Cursor not stopped")},X.trans=k,X.stop=X.continue=X.continuePrimaryKey=X.advance=function(){throw new Error("Cursor not started")},X.fail=ie(D),X.next=function(){var G=this,oe=1;return this.start(function(){return oe--?G.continue():G.stop()}).then(function(){return G})},X.start=function(G){function oe(){if(F.result)try{G()}catch(se){X.fail(se)}else X.done=!0,X.start=function(){throw new Error("Cursor behind last entry")},X.stop()}var be=new Promise(function(se,et){se=ie(se),F.onerror=xe(et),X.fail=et,X.stop=function(br){X.stop=X.continue=X.continuePrimaryKey=X.advance=te,se(br)}});return F.onsuccess=ie(function(se){F.onsuccess=oe,oe()}),X.continue=K,X.continuePrimaryKey=z,X.advance=J,oe(),be},T(X)):T(null)},D)})},count:function(_){var k=_.query,g=_.trans,P=k.index,L=k.range;return new Promise(function(E,T){var D=g.objectStore(S),D=P.isPrimaryKey?D:D.index(P.name),M=r(L),M=M?D.count(M):D.count();M.onsuccess=ie(function(j){return E(j.target.result)}),M.onerror=xe(T)})}}}s=b,l=hi((b=e).objectStoreNames);var s,b={schema:{name:b.name,tables:l.map(function(w){return s.objectStore(w)}).map(function(w){var y=w.keyPath,S=w.autoIncrement,k=m(y),_={},k={name:w.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:y==null,compound:k,keyPath:y,autoIncrement:S,unique:!0,extractKey:tr(y)},indexes:hi(w.indexNames).map(function(g){return w.index(g)}).map(function(E){var T=E.name,P=E.unique,L=E.multiEntry,E=E.keyPath,T={name:T,compound:m(E),keyPath:E,unique:P,multiEntry:L,extractKey:tr(E)};return _[qt(E)]=T}),getIndexByKeyPath:function(g){return _[qt(g)]}};return _[":id"]=k.primaryKey,y!=null&&(_[qt(y)]=k.primaryKey),k})},hasGetAll:0<l.length&&"getAll"in s.objectStore(l[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)},l=b.schema,f=b.hasGetAll,b=l.tables.map(a),x={};return b.forEach(function(w){return x[w.name]=w}),{stack:"dbcore",transaction:e.transaction.bind(e),table:function(w){if(x[w])return x[w];throw new Error("Table '".concat(w,"' not found"))},MIN_KEY:-1/0,MAX_KEY:jt(t),schema:l}}function Va(e,t,n,r){return n=n.IDBKeyRange,t=Ha(t,n,r),{dbcore:e.dbcore.reduce(function(a,s){return s=s.create,c(c({},a),s(a))},t)}}function un(e,t){var n=t.db,n=Va(e._middlewares,n,e._deps,t);e.core=n.dbcore,e.tables.forEach(function(r){var a=r.name;e.core.schema.tables.some(function(s){return s.name===a})&&(r.core=e.core.table(a),e[a]instanceof e.Table)&&(e[a].core=r.core)})}function dn(e,t,n,r){n.forEach(function(a){var s=r[a];t.forEach(function(l){var f=(function b(x,w){return Z(x,w)||(x=I(x))&&b(x,w)})(l,a);(!f||"value"in f&&f.value===void 0)&&(l===e.Transaction.prototype||l instanceof e.Transaction?V(l,a,{get:function(){return this.table(a)},set:function(b){B(this,a,{value:b,writable:!0,configurable:!0,enumerable:!0})}}):l[a]=new e.Table(a,s))})})}function nr(e,t){t.forEach(function(n){for(var r in n)n[r]instanceof e.Table&&delete n[r]})}function Xa(e,t){return e._cfg.version-t._cfg.version}function Wa(e,t,n,r){var a=e._dbSchema,s=(n.objectStoreNames.contains("$meta")&&!a.$meta&&(a.$meta=er("$meta",vi("")[0],[]),e._storeNames.push("$meta")),e._createTransaction("readwrite",e._storeNames,a)),l=(s.create(n),s._completion.catch(r),s._reject.bind(s)),f=U.transless||U;Oe(function(){if(U.trans=s,U.transless=f,t!==0)return un(e,n),x=t,((b=s).storeNames.includes("$meta")?b.table("$meta").get("version").then(function(w){return w??x}):q.resolve(x)).then(function(P){var y=e,S=P,_=s,k=n,g=[],P=y._versions,L=y._dbSchema=pn(0,y.idbdb,k);return(P=P.filter(function(E){return E._cfg.version>=S})).length===0?q.resolve():(P.forEach(function(E){g.push(function(){var T,D,M,j=L,O=E._cfg.dbschema,F=(hn(y,j,k),hn(y,O,k),L=y._dbSchema=O,rr(j,O)),R=(F.add.forEach(function(K){ir(k,K[0],K[1].primKey,K[1].indexes)}),F.change.forEach(function(K){if(K.recreate)throw new H.Upgrade("Not yet support for changing primary key");var z=k.objectStore(K.name);K.add.forEach(function(J){return fn(z,J)}),K.change.forEach(function(J){z.deleteIndex(J.name),fn(z,J)}),K.del.forEach(function(J){return z.deleteIndex(J)})}),E._cfg.contentUpgrade);if(R&&E._cfg.version>S)return un(y,k),_._memoizedTables={},T=zr(O),F.del.forEach(function(K){T[K]=j[K]}),nr(y,[y.Transaction.prototype]),dn(y,[y.Transaction.prototype],h(T),T),_.schema=T,(D=Mn(R))&&ft(),O=q.follow(function(){var K;(M=R(_))&&D&&(K=Ke.bind(null,null),M.then(K,K))}),M&&typeof M.then=="function"?q.resolve(M):O.then(function(){return M})}),g.push(function(T){var D,M,j=E._cfg.dbschema;D=j,M=T,[].slice.call(M.db.objectStoreNames).forEach(function(O){return D[O]==null&&M.db.deleteObjectStore(O)}),nr(y,[y.Transaction.prototype]),dn(y,[y.Transaction.prototype],y._storeNames,y._dbSchema),_.schema=y._dbSchema}),g.push(function(T){y.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(y.idbdb.version/10)===E._cfg.version?(y.idbdb.deleteObjectStore("$meta"),delete y._dbSchema.$meta,y._storeNames=y._storeNames.filter(function(D){return D!=="$meta"})):T.objectStore("$meta").put(E._cfg.version,"version"))})}),(function E(){return g.length?q.resolve(g.shift()(_.idbtrans)).then(E):q.resolve()})().then(function(){mi(L,k)}))}).catch(l);var b,x;h(a).forEach(function(w){ir(n,w,a[w].primKey,a[w].indexes)}),un(e,n),q.follow(function(){return e.on.populate.fire(s)}).catch(l)})}function Ya(e,t){mi(e._dbSchema,t),t.db.version%10!=0||t.objectStoreNames.contains("$meta")||t.db.createObjectStore("$meta").add(Math.ceil(t.db.version/10-1),"version");var n=pn(0,e.idbdb,t);hn(e,e._dbSchema,t);for(var r=0,a=rr(n,e._dbSchema).change;r<a.length;r++){var s=(l=>{if(l.change.length||l.recreate)return console.warn("Unable to patch indexes of table ".concat(l.name," because it has changes on the type of index or primary key.")),{value:void 0};var f=t.objectStore(l.name);l.add.forEach(function(b){Ee&&console.debug("Dexie upgrade patch: Creating missing index ".concat(l.name,".").concat(b.src)),fn(f,b)})})(a[r]);if(typeof s=="object")return s.value}}function rr(e,t){var n,r={del:[],add:[],change:[]};for(n in e)t[n]||r.del.push(n);for(n in t){var a=e[n],s=t[n];if(a){var l={name:n,def:s,recreate:!1,del:[],add:[],change:[]};if(""+(a.primKey.keyPath||"")!=""+(s.primKey.keyPath||"")||a.primKey.auto!==s.primKey.auto)l.recreate=!0,r.change.push(l);else{var f=a.idxByName,b=s.idxByName,x=void 0;for(x in f)b[x]||l.del.push(x);for(x in b){var w=f[x],y=b[x];w?w.src!==y.src&&l.change.push(y):l.add.push(y)}(0<l.del.length||0<l.add.length||0<l.change.length)&&r.change.push(l)}}else r.add.push([n,s])}return r}function ir(e,t,n,r){var a=e.db.createObjectStore(t,n.keyPath?{keyPath:n.keyPath,autoIncrement:n.auto}:{autoIncrement:n.auto});r.forEach(function(s){return fn(a,s)})}function mi(e,t){h(e).forEach(function(n){t.db.objectStoreNames.contains(n)||(Ee&&console.debug("Dexie: Creating missing table",n),ir(t,n,e[n].primKey,e[n].indexes))})}function fn(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function pn(e,t,n){var r={};return ot(t.objectStoreNames,0).forEach(function(a){for(var s=n.objectStore(a),l=Zn(pi(x=s.keyPath),x||"",!0,!1,!!s.autoIncrement,x&&typeof x!="string",!0),f=[],b=0;b<s.indexNames.length;++b){var w=s.index(s.indexNames[b]),x=w.keyPath,w=Zn(w.name,x,!!w.unique,!!w.multiEntry,!1,x&&typeof x!="string",!1);f.push(w)}r[a]=er(a,l,f)}),r}function hn(e,t,n){for(var r=n.db.objectStoreNames,a=0;a<r.length;++a){var s=r[a],l=n.objectStore(s);e._hasGetAll="getAll"in l;for(var f=0;f<l.indexNames.length;++f){var b,x=l.indexNames[f],w=l.index(x).keyPath,w=typeof w=="string"?w:"["+ot(w).join("+")+"]";t[s]&&(b=t[s].idxByName[w])&&(b.name=x,delete t[s].idxByName[w],t[s].idxByName[x]=b)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&p.WorkerGlobalScope&&p instanceof p.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(e._hasGetAll=!1)}function vi(e){return e.split(",").map(function(t,n){var a=t.split(":"),r=(r=a[1])==null?void 0:r.trim(),a=(t=a[0].trim()).replace(/([&*]|\+\+)/g,""),s=/^\[/.test(a)?a.match(/^\[(.*)\]$/)[1].split("+"):a;return Zn(a,s||null,/\&/.test(t),/\*/.test(t),/\+\+/.test(t),m(s),n===0,r)})}vt.prototype._createTableSchema=er,vt.prototype._parseIndexSyntax=vi,vt.prototype._parseStoresSpec=function(e,t){var n=this;h(e).forEach(function(r){if(e[r]!==null){var a=n._parseIndexSyntax(e[r]),s=a.shift();if(!s)throw new H.Schema("Invalid schema for table "+r+": "+e[r]);if(s.unique=!0,s.multi)throw new H.Schema("Primary key cannot be multiEntry*");a.forEach(function(l){if(l.auto)throw new H.Schema("Only primary key can be marked as autoIncrement (++)");if(!l.keyPath)throw new H.Schema("Index must have a name and cannot be an empty string")}),s=n._createTableSchema(r,s,a),t[r]=s}})},vt.prototype.stores=function(n){var t=this.db,n=(this._cfg.storesSource=this._cfg.storesSource?v(this._cfg.storesSource,n):n,t._versions),r={},a={};return n.forEach(function(s){v(r,s._cfg.storesSource),a=s._cfg.dbschema={},s._parseStoresSpec(r,a)}),t._dbSchema=a,nr(t,[t._allTables,t,t.Transaction.prototype]),dn(t,[t._allTables,t,t.Transaction.prototype,this._cfg.tables],h(a),a),t._storeNames=h(a),this},vt.prototype.upgrade=function(e){return this._cfg.contentUpgrade=qn(this._cfg.contentUpgrade||ne,e),this};var Ga=vt;function vt(){}function ar(e,t){var n=e._dbNamesDB;return n||(n=e._dbNamesDB=new Be(rn,{addons:[],indexedDB:e,IDBKeyRange:t})).version(1).stores({dbnames:"name"}),n.table("dbnames")}function or(e){return e&&typeof e.databases=="function"}function sr(e){return Oe(function(){return U.letThrough=!0,e()})}function cr(e){return!("from"in e)}var fe=function(e,t){var n;if(!this)return n=new fe,e&&"d"in e&&v(n,e),n;v(this,arguments.length?{d:1,from:e,to:1<arguments.length?t:e}:{d:0})};function Rt(e,t,n){var r=Q(t,n);if(!isNaN(r)){if(0<r)throw RangeError();if(cr(e))return v(e,{from:t,to:n,d:1});var r=e.l,a=e.r;if(Q(n,e.from)<0)return r?Rt(r,t,n):e.l={from:t,to:n,d:1,l:null,r:null},gi(e);if(0<Q(t,e.to))return a?Rt(a,t,n):e.r={from:t,to:n,d:1,l:null,r:null},gi(e);Q(t,e.from)<0&&(e.from=t,e.l=null,e.d=a?a.d+1:1),0<Q(n,e.to)&&(e.to=n,e.r=null,e.d=e.l?e.l.d+1:1),t=!e.r,r&&!e.l&&Nt(e,r),a&&t&&Nt(e,a)}}function Nt(e,t){cr(t)||(function n(r,a){var s=a.from,l=a.l,f=a.r;Rt(r,s,a.to),l&&n(r,l),f&&n(r,f)})(e,t)}function yi(e,t){var n=mn(t),r=n.next();if(!r.done)for(var a=r.value,s=mn(e),l=s.next(a.from),f=l.value;!r.done&&!l.done;){if(Q(f.from,a.to)<=0&&0<=Q(f.to,a.from))return!0;Q(a.from,f.from)<0?a=(r=n.next(f.from)).value:f=(l=s.next(a.from)).value}return!1}function mn(e){var t=cr(e)?null:{s:0,n:e};return{next:function(n){for(var r=0<arguments.length;t;)switch(t.s){case 0:if(t.s=1,r)for(;t.n.l&&Q(n,t.n.from)<0;)t={up:t,n:t.n.l,s:1};else for(;t.n.l;)t={up:t,n:t.n.l,s:1};case 1:if(t.s=2,!r||Q(n,t.n.to)<=0)return{value:t.n,done:!1};case 2:if(t.n.r){t.s=3,t={up:t,n:t.n.r,s:0};continue}case 3:t=t.up}return{done:!0}}}}function gi(e){var t,n,r,a=(((a=e.r)==null?void 0:a.d)||0)-(((a=e.l)==null?void 0:a.d)||0),a=1<a?"r":a<-1?"l":"";a&&(t=a=="r"?"l":"r",n=c({},e),r=e[a],e.from=r.from,e.to=r.to,e[a]=r[a],n[a]=r[t],(e[t]=n).d=bi(n)),e.d=bi(e)}function bi(n){var t=n.r,n=n.l;return(t?n?Math.max(t.d,n.d):t.d:n?n.d:0)+1}function vn(e,t){return h(t).forEach(function(n){e[n]?Nt(e[n],t[n]):e[n]=(function r(a){var s,l,f={};for(s in a)C(a,s)&&(l=a[s],f[s]=!l||typeof l!="object"||Hr.has(l.constructor)?l:r(l));return f})(t[n])}),e}function lr(e,t){return e.all||t.all||Object.keys(e).some(function(n){return t[n]&&yi(t[n],e[n])})}A(fe.prototype,((he={add:function(e){return Nt(this,e),this},addKey:function(e){return Rt(this,e,e),this},addKeys:function(e){var t=this;return e.forEach(function(n){return Rt(t,n,n)}),this},hasKey:function(e){var t=mn(this).next(e).value;return t&&Q(t.from,e)<=0&&0<=Q(t.to,e)}})[Kn]=function(){return mn(this)},he));var Je={},ur={},dr=!1;function yn(e){vn(ur,e),dr||(dr=!0,setTimeout(function(){dr=!1,fr(ur,!(ur={}))},0))}function fr(e,t){t===void 0&&(t=!1);var n=new Set;if(e.all)for(var r=0,a=Object.values(Je);r<a.length;r++)wi(f=a[r],e,n,t);else for(var s in e){var l,f,s=/^idb\:\/\/(.*)\/(.*)\//.exec(s);s&&(l=s[1],s=s[2],f=Je["idb://".concat(l,"/").concat(s)])&&wi(f,e,n,t)}n.forEach(function(b){return b()})}function wi(e,t,n,r){for(var a=[],s=0,l=Object.entries(e.queries.query);s<l.length;s++){for(var f=l[s],b=f[0],x=[],w=0,y=f[1];w<y.length;w++){var S=y[w];lr(t,S.obsSet)?S.subscribers.forEach(function(P){return n.add(P)}):r&&x.push(S)}r&&a.push([b,x])}if(r)for(var _=0,k=a;_<k.length;_++){var g=k[_],b=g[0],x=g[1];e.queries.query[b]=x}}function Qa(e){var t=e._state,n=e._deps.indexedDB;if(t.isBeingOpened||e.idbdb)return t.dbReadyPromise.then(function(){return t.dbOpenError?ce(t.dbOpenError):e});t.isBeingOpened=!0,t.dbOpenError=null,t.openComplete=!1;var r=t.openCanceller,a=Math.round(10*e.verno),s=!1;function l(){if(t.openCanceller!==r)throw new H.DatabaseClosed("db.open() was cancelled")}function f(){return new q(function(S,_){if(l(),!n)throw new H.MissingAPI;var k=e.name,g=t.autoSchema||!a?n.open(k):n.open(k,a);if(!g)throw new H.MissingAPI;g.onerror=xe(_),g.onblocked=ie(e._fireOnBlocked),g.onupgradeneeded=ie(function(P){var L;w=g.transaction,t.autoSchema&&!e._options.allowEmptyDB?(g.onerror=Kt,w.abort(),g.result.close(),(L=n.deleteDatabase(k)).onsuccess=L.onerror=ie(function(){_(new H.NoSuchDatabase("Database ".concat(k," doesnt exist")))})):(w.onerror=xe(_),L=P.oldVersion>Math.pow(2,62)?0:P.oldVersion,y=L<1,e.idbdb=g.result,s&&Ya(e,w),Wa(e,L/10,w,_))},_),g.onsuccess=ie(function(){w=null;var P,L,E,T,D,M,j=e.idbdb=g.result,O=ot(j.objectStoreNames);if(0<O.length)try{var F=j.transaction((D=O).length===1?D[0]:D,"readonly");if(t.autoSchema)M=j,T=F,(E=e).verno=M.version/10,T=E._dbSchema=pn(0,M,T),E._storeNames=ot(M.objectStoreNames,0),dn(E,[E._allTables],h(T),T);else if(hn(e,e._dbSchema,F),L=F,((L=rr(pn(0,(P=e).idbdb,L),P._dbSchema)).add.length||L.change.some(function(R){return R.add.length||R.change.length}))&&!s)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),j.close(),a=j.version+1,s=!0,S(f());un(e,F)}catch{}pt.push(e),j.onversionchange=ie(function(R){t.vcFired=!0,e.on("versionchange").fire(R)}),j.onclose=ie(function(){e.close({disableAutoOpen:!1})}),y&&(O=e._deps,D=k,or(M=O.indexedDB)||D===rn||ar(M,O.IDBKeyRange).put({name:D}).catch(ne)),S()},_)}).catch(function(S){switch(S?.name){case"UnknownError":if(0<t.PR1398_maxLoop)return t.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),f();break;case"VersionError":if(0<a)return a=0,f()}return q.reject(S)})}var b,x=t.dbReadyResolve,w=null,y=!1;return q.race([r,(typeof navigator>"u"?q.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(S){function _(){return indexedDB.databases().finally(S)}b=setInterval(_,100),_()}).finally(function(){return clearInterval(b)}):Promise.resolve()).then(f)]).then(function(){return l(),t.onReadyBeingFired=[],q.resolve(sr(function(){return e.on.ready.fire(e.vip)})).then(function S(){var _;if(0<t.onReadyBeingFired.length)return _=t.onReadyBeingFired.reduce(qn,ne),t.onReadyBeingFired=[],q.resolve(sr(function(){return _(e.vip)})).then(S)})}).finally(function(){t.openCanceller===r&&(t.onReadyBeingFired=null,t.isBeingOpened=!1)}).catch(function(S){t.dbOpenError=S;try{w&&w.abort()}catch{}return r===t.openCanceller&&e._close(),ce(S)}).finally(function(){t.openComplete=!0,x()}).then(function(){var S;return y&&(S={},e.tables.forEach(function(_){_.schema.indexes.forEach(function(k){k.name&&(S["idb://".concat(e.name,"/").concat(_.name,"/").concat(k.name)]=new fe(-1/0,[[[]]]))}),S["idb://".concat(e.name,"/").concat(_.name,"/")]=S["idb://".concat(e.name,"/").concat(_.name,"/:dels")]=new fe(-1/0,[[[]]])}),qe(Mt).fire(S),fr(S,!0)),e})}function pr(e){function t(s){return e.next(s)}var n=a(t),r=a(function(s){return e.throw(s)});function a(s){return function(f){var f=s(f),b=f.value;return f.done?b:b&&typeof b.then=="function"?b.then(n,r):m(b)?Promise.all(b).then(n,r):n(b)}}return a(t)()}function gn(e,t,n){for(var r=m(e)?e.slice():[e],a=0;a<n;++a)r.push(t);return r}var Ja={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(e){return c(c({},e),{table:function(r){var n=e.table(r),r=n.schema,a={},s=[];function l(S,_,k){var E=qt(S),g=a[E]=a[E]||[],P=S==null?0:typeof S=="string"?1:S.length,L=0<_,E=c(c({},k),{name:L?"".concat(E,"(virtual-from:").concat(k.name,")"):k.name,lowLevelIndex:k,isVirtual:L,keyTail:_,keyLength:P,extractKey:tr(S),unique:!L&&k.unique});return g.push(E),E.isPrimaryKey||s.push(E),1<P&&l(P===2?S[0]:S.slice(0,P-1),_+1,k),g.sort(function(T,D){return T.keyTail-D.keyTail}),E}var f=l(r.primaryKey.keyPath,0,r.primaryKey);a[":id"]=[f];for(var b=0,x=r.indexes;b<x.length;b++){var w=x[b];l(w.keyPath,0,w)}function y(S){var _,k=S.query.index;return k.isVirtual?c(c({},S),{query:{index:k.lowLevelIndex,range:(_=S.query.range,k=k.keyTail,{type:_.type===1?2:_.type,lower:gn(_.lower,_.lowerOpen?e.MAX_KEY:e.MIN_KEY,k),lowerOpen:!0,upper:gn(_.upper,_.upperOpen?e.MIN_KEY:e.MAX_KEY,k),upperOpen:!0})}}):S}return c(c({},n),{schema:c(c({},r),{primaryKey:f,indexes:s,getIndexByKeyPath:function(S){return(S=a[qt(S)])&&S[0]}}),count:function(S){return n.count(y(S))},query:function(S){return n.query(y(S))},openCursor:function(S){var _=S.query.index,k=_.keyTail,g=_.keyLength;return _.isVirtual?n.openCursor(y(S)).then(function(L){return L&&P(L)}):n.openCursor(S);function P(L){return Object.create(L,{continue:{value:function(E){E!=null?L.continue(gn(E,S.reverse?e.MAX_KEY:e.MIN_KEY,k)):S.unique?L.continue(L.key.slice(0,g).concat(S.reverse?e.MIN_KEY:e.MAX_KEY,k)):L.continue()}},continuePrimaryKey:{value:function(E,T){L.continuePrimaryKey(gn(E,e.MAX_KEY,k),T)}},primaryKey:{get:function(){return L.primaryKey}},key:{get:function(){var E=L.key;return g===1?E[0]:E.slice(0,g)}},value:{get:function(){return L.value}}})}}})}})}};function hr(e,t,n,r){return n=n||{},r=r||"",h(e).forEach(function(a){var s,l,f;C(t,a)?(s=e[a],l=t[a],typeof s=="object"&&typeof l=="object"&&s&&l?(f=On(s))!==On(l)?n[r+a]=t[a]:f==="Object"?hr(s,l,n,r+a+"."):s!==l&&(n[r+a]=t[a]):s!==l&&(n[r+a]=t[a])):n[r+a]=void 0}),h(t).forEach(function(a){C(e,a)||(n[r+a]=t[a])}),n}function mr(e,t){return t.type==="delete"?t.keys:t.keys||t.values.map(e.extractKey)}var Za={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(e){return c(c({},e),{table:function(t){var n=e.table(t),r=n.schema.primaryKey;return c(c({},n),{mutate:function(a){var s=U.trans,l=s.table(t).hook,f=l.deleting,b=l.creating,x=l.updating;switch(a.type){case"add":if(b.fire===ne)break;return s._promise("readwrite",function(){return w(a)},!0);case"put":if(b.fire===ne&&x.fire===ne)break;return s._promise("readwrite",function(){return w(a)},!0);case"delete":if(f.fire===ne)break;return s._promise("readwrite",function(){return w(a)},!0);case"deleteRange":if(f.fire===ne)break;return s._promise("readwrite",function(){return(function y(S,_,k){return n.query({trans:S,values:!1,query:{index:r,range:_},limit:k}).then(function(g){var P=g.result;return w({type:"delete",keys:P,trans:S}).then(function(L){return 0<L.numFailures?Promise.reject(L.failures[0]):P.length<k?{failures:[],numFailures:0,lastResult:void 0}:y(S,c(c({},_),{lower:P[P.length-1],lowerOpen:!0}),k)})})})(a.trans,a.range,1e4)},!0)}return n.mutate(a);function w(y){var S,_,k,g=U.trans,P=y.keys||mr(r,y);if(P)return(y=y.type==="add"||y.type==="put"?c(c({},y),{keys:P}):c({},y)).type!=="delete"&&(y.values=u([],y.values)),y.keys&&(y.keys=u([],y.keys)),S=n,k=P,((_=y).type==="add"?Promise.resolve([]):S.getMany({trans:_.trans,keys:k,cache:"immutable"})).then(function(L){var E=P.map(function(T,D){var M,j,O,F=L[D],R={onerror:null,onsuccess:null};return y.type==="delete"?f.fire.call(R,T,F,g):y.type==="add"||F===void 0?(M=b.fire.call(R,T,y.values[D],g),T==null&&M!=null&&(y.keys[D]=T=M,r.outbound||pe(y.values[D],r.keyPath,T))):(M=hr(F,y.values[D]),(j=x.fire.call(R,M,T,F,g))&&(O=y.values[D],Object.keys(j).forEach(function(K){C(O,K)?O[K]=j[K]:pe(O,K,j[K])}))),R});return n.mutate(y).then(function(T){for(var D=T.failures,M=T.results,j=T.numFailures,T=T.lastResult,O=0;O<P.length;++O){var F=(M||P)[O],R=E[O];F==null?R.onerror&&R.onerror(D[O]):R.onsuccess&&R.onsuccess(y.type==="put"&&L[O]?y.values[O]:F)}return{failures:D,results:M,numFailures:j,lastResult:T}}).catch(function(T){return E.forEach(function(D){return D.onerror&&D.onerror(T)}),Promise.reject(T)})});throw new Error("Keys missing")}}})}})}};function ki(e,t,n){try{if(!t||t.keys.length<e.length)return null;for(var r=[],a=0,s=0;a<t.keys.length&&s<e.length;++a)Q(t.keys[a],e[s])===0&&(r.push(n?ze(t.values[a]):t.values[a]),++s);return r.length===e.length?r:null}catch{return null}}var eo={stack:"dbcore",level:-1,create:function(e){return{table:function(t){var n=e.table(t);return c(c({},n),{getMany:function(r){var a;return r.cache?(a=ki(r.keys,r.trans._cache,r.cache==="clone"))?q.resolve(a):n.getMany(r).then(function(s){return r.trans._cache={keys:r.keys,values:r.cache==="clone"?ze(s):s},s}):n.getMany(r)},mutate:function(r){return r.type!=="add"&&(r.trans._cache=null),n.mutate(r)}})}}}};function Si(e,t){return e.trans.mode==="readonly"&&!!e.subscr&&!e.trans.explicit&&e.trans.db._options.cache!=="disabled"&&!t.schema.primaryKey.outbound}function _i(e,t){switch(e){case"query":return t.values&&!t.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var to={stack:"dbcore",level:0,name:"Observability",create:function(e){var t=e.schema.name,n=new fe(e.MIN_KEY,e.MAX_KEY);return c(c({},e),{transaction:function(r,a,s){if(U.subscr&&a!=="readonly")throw new H.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(U.querier));return e.transaction(r,a,s)},table:function(r){function a(P){var g,P=P.query;return[g=P.index,new fe((g=(P=P.range).lower)!=null?g:e.MIN_KEY,(g=P.upper)!=null?g:e.MAX_KEY)]}var s=e.table(r),l=s.schema,f=l.primaryKey,b=l.indexes,x=f.extractKey,w=f.outbound,y=f.autoIncrement&&b.filter(function(k){return k.compound&&k.keyPath.includes(f.keyPath)}),S=c(c({},s),{mutate:function(k){function g(z){return z="idb://".concat(t,"/").concat(r,"/").concat(z),D[z]||(D[z]=new fe)}var P,L,E,T=k.trans,D=k.mutatedParts||(k.mutatedParts={}),M=g(""),j=g(":dels"),O=k.type,R=k.type==="deleteRange"?[k.range]:k.type==="delete"?[k.keys]:k.values.length<50?[mr(f,k).filter(function(z){return z}),k.values]:[],F=R[0],R=R[1],K=k.trans._cache;return m(F)?(M.addKeys(F),(O=O==="delete"||F.length===R.length?ki(F,K):null)||j.addKeys(F),(O||R)&&(P=g,L=O,E=R,l.indexes.forEach(function(z){var J=P(z.name||"");function te(G){return G!=null?z.extractKey(G):null}function X(G){z.multiEntry&&m(G)?G.forEach(function(oe){return J.addKey(oe)}):J.addKey(G)}(L||E).forEach(function(G,se){var be=L&&te(L[se]),se=E&&te(E[se]);Q(be,se)!==0&&(be!=null&&X(be),se!=null)&&X(se)})}))):F?(R={from:(K=F.lower)!=null?K:e.MIN_KEY,to:(O=F.upper)!=null?O:e.MAX_KEY},j.add(R),M.add(R)):(M.add(n),j.add(n),l.indexes.forEach(function(z){return g(z.name).add(n)})),s.mutate(k).then(function(z){return!F||k.type!=="add"&&k.type!=="put"||(M.addKeys(z.results),y&&y.forEach(function(J){for(var te=k.values.map(function(be){return J.extractKey(be)}),X=J.keyPath.findIndex(function(be){return be===f.keyPath}),G=0,oe=z.results.length;G<oe;++G)te[G][X]=z.results[G];g(J.name).addKeys(te)})),T.mutatedParts=vn(T.mutatedParts||{},D),z})}}),_={get:function(k){return[f,new fe(k.key)]},getMany:function(k){return[f,new fe().addKeys(k.keys)]},count:a,query:a,openCursor:a};return h(_).forEach(function(k){S[k]=function(g){var P=U.subscr,L=!!P,E=Si(U,s)&&_i(k,g)?g.obsSet={}:P;if(L){var T,P=function(R){return R="idb://".concat(t,"/").concat(r,"/").concat(R),E[R]||(E[R]=new fe)},D=P(""),M=P(":dels"),L=_[k](g),j=L[0],L=L[1];if((k==="query"&&j.isPrimaryKey&&!g.values?M:P(j.name||"")).add(L),!j.isPrimaryKey){if(k!=="count")return T=k==="query"&&w&&g.values&&s.query(c(c({},g),{values:!1})),s[k].apply(this,arguments).then(function(R){if(k==="query"){if(w&&g.values)return T.then(function(te){return te=te.result,D.addKeys(te),R});var K=g.values?R.result.map(x):R.result;(g.values?D:M).addKeys(K)}else{var z,J;if(k==="openCursor")return J=g.values,(z=R)&&Object.create(z,{key:{get:function(){return M.addKey(z.primaryKey),z.key}},primaryKey:{get:function(){var te=z.primaryKey;return M.addKey(te),te}},value:{get:function(){return J&&D.addKey(z.primaryKey),z.value}}})}return R});M.add(n)}}return s[k].apply(this,arguments)}}),S}})}};function Ei(e,t,n){var r;return n.numFailures===0?t:t.type==="deleteRange"||(r=t.keys?t.keys.length:"values"in t&&t.values?t.values.length:1,n.numFailures===r)?null:(r=c({},t),m(r.keys)&&(r.keys=r.keys.filter(function(a,s){return!(s in n.failures)})),"values"in r&&m(r.values)&&(r.values=r.values.filter(function(a,s){return!(s in n.failures)})),r)}function vr(e,t){return n=e,((r=t).lower===void 0||(r.lowerOpen?0<Q(n,r.lower):0<=Q(n,r.lower)))&&(n=e,(r=t).upper===void 0||(r.upperOpen?Q(n,r.upper)<0:Q(n,r.upper)<=0));var n,r}function xi(e,t,n,r,a,s){var l,f,b,x,w,y;return!n||n.length===0||(l=t.query.index,f=l.multiEntry,b=t.query.range,x=r.schema.primaryKey.extractKey,w=l.extractKey,y=(l.lowLevelIndex||l).extractKey,(r=n.reduce(function(S,_){var k=S,g=[];if(_.type==="add"||_.type==="put")for(var P=new fe,L=_.values.length-1;0<=L;--L){var E,T=_.values[L],D=x(T);!P.hasKey(D)&&(E=w(T),f&&m(E)?E.some(function(R){return vr(R,b)}):vr(E,b))&&(P.addKey(D),g.push(T))}switch(_.type){case"add":var M=new fe().addKeys(t.values?S.map(function(K){return x(K)}):S),k=S.concat(t.values?g.filter(function(K){return K=x(K),!M.hasKey(K)&&(M.addKey(K),!0)}):g.map(function(K){return x(K)}).filter(function(K){return!M.hasKey(K)&&(M.addKey(K),!0)}));break;case"put":var j=new fe().addKeys(_.values.map(function(K){return x(K)}));k=S.filter(function(K){return!j.hasKey(t.values?x(K):K)}).concat(t.values?g:g.map(function(K){return x(K)}));break;case"delete":var O=new fe().addKeys(_.keys);k=S.filter(function(K){return!O.hasKey(t.values?x(K):K)});break;case"deleteRange":var F=_.range;k=S.filter(function(K){return!vr(x(K),F)})}return k},e))===e)?e:(r.sort(function(S,_){return Q(y(S),y(_))||Q(x(S),x(_))}),t.limit&&t.limit<1/0&&(r.length>t.limit?r.length=t.limit:e.length===t.limit&&r.length<t.limit&&(a.dirty=!0)),s?Object.freeze(r):r)}function Pi(e,t){return Q(e.lower,t.lower)===0&&Q(e.upper,t.upper)===0&&!!e.lowerOpen==!!t.lowerOpen&&!!e.upperOpen==!!t.upperOpen}function no(e,t){return((n,r,a,s)=>{if(n===void 0)return r!==void 0?-1:0;if(r===void 0)return 1;if((n=Q(n,r))===0){if(a&&s)return 0;if(a)return 1;if(s)return-1}return n})(e.lower,t.lower,e.lowerOpen,t.lowerOpen)<=0&&0<=((n,r,a,s)=>{if(n===void 0)return r!==void 0?1:0;if(r===void 0)return-1;if((n=Q(n,r))===0){if(a&&s)return 0;if(a)return-1;if(s)return 1}return n})(e.upper,t.upper,e.upperOpen,t.upperOpen)}function ro(e,t,n,r){e.subscribers.add(n),r.addEventListener("abort",function(){var a,s;e.subscribers.delete(n),e.subscribers.size===0&&(a=e,s=t,setTimeout(function(){a.subscribers.size===0&&Ue(s,a)},3e3))})}var io={stack:"dbcore",level:0,name:"Cache",create:function(e){var t=e.schema.name;return c(c({},e),{transaction:function(n,r,a){var s,l,f=e.transaction(n,r,a);return r==="readwrite"&&(a=(s=new AbortController).signal,f.addEventListener("abort",(l=function(b){return function(){if(s.abort(),r==="readwrite"){for(var x=new Set,w=0,y=n;w<y.length;w++){var S=y[w],_=Je["idb://".concat(t,"/").concat(S)];if(_){var k=e.table(S),g=_.optimisticOps.filter(function(z){return z.trans===f});if(f._explicit&&b&&f.mutatedParts)for(var P=0,L=Object.values(_.queries.query);P<L.length;P++)for(var E=0,T=(j=L[P]).slice();E<T.length;E++)lr((O=T[E]).obsSet,f.mutatedParts)&&(Ue(j,O),O.subscribers.forEach(function(z){return x.add(z)}));else if(0<g.length){_.optimisticOps=_.optimisticOps.filter(function(z){return z.trans!==f});for(var D=0,M=Object.values(_.queries.query);D<M.length;D++)for(var j,O,F,R=0,K=(j=M[D]).slice();R<K.length;R++)(O=K[R]).res!=null&&f.mutatedParts&&(b&&!O.dirty?(F=Object.isFrozen(O.res),F=xi(O.res,O.req,g,k,O,F),O.dirty?(Ue(j,O),O.subscribers.forEach(function(z){return x.add(z)})):F!==O.res&&(O.res=F,O.promise=q.resolve({result:F}))):(O.dirty&&Ue(j,O),O.subscribers.forEach(function(z){return x.add(z)})))}}}x.forEach(function(z){return z()})}}})(!1),{signal:a}),f.addEventListener("error",l(!1),{signal:a}),f.addEventListener("complete",l(!0),{signal:a})),f},table:function(n){var r=e.table(n),a=r.schema.primaryKey;return c(c({},r),{mutate:function(s){var l,f=U.trans;return!a.outbound&&f.db._options.cache!=="disabled"&&!f.explicit&&f.idbtrans.mode==="readwrite"&&(l=Je["idb://".concat(t,"/").concat(n)])?(f=r.mutate(s),s.type!=="add"&&s.type!=="put"||!(50<=s.values.length||mr(a,s).some(function(b){return b==null}))?(l.optimisticOps.push(s),s.mutatedParts&&yn(s.mutatedParts),f.then(function(b){0<b.numFailures&&(Ue(l.optimisticOps,s),(b=Ei(0,s,b))&&l.optimisticOps.push(b),s.mutatedParts)&&yn(s.mutatedParts)}),f.catch(function(){Ue(l.optimisticOps,s),s.mutatedParts&&yn(s.mutatedParts)})):f.then(function(b){var x=Ei(0,c(c({},s),{values:s.values.map(function(w,y){var S;return b.failures[y]?w:(pe(S=(S=a.keyPath)!=null&&S.includes(".")?ze(w):c({},w),a.keyPath,b.results[y]),S)})}),b);l.optimisticOps.push(x),queueMicrotask(function(){return s.mutatedParts&&yn(s.mutatedParts)})}),f):r.mutate(s)},query:function(s){var l,f,b,x,w,y,S;return Si(U,r)&&_i("query",s)?(l=((b=U.trans)==null?void 0:b.db._options.cache)==="immutable",f=(b=U).requery,b=b.signal,y=((_,k,g,P)=>{var L=Je["idb://".concat(_,"/").concat(k)];if(!L)return[];if(!(_=L.queries[g]))return[null,!1,L,null];var E=_[(P.query?P.query.index.name:null)||""];if(!E)return[null,!1,L,null];switch(g){case"query":var T=E.find(function(D){return D.req.limit===P.limit&&D.req.values===P.values&&Pi(D.req.query.range,P.query.range)});return T?[T,!0,L,E]:[E.find(function(D){return("limit"in D.req?D.req.limit:1/0)>=P.limit&&(!P.values||D.req.values)&&no(D.req.query.range,P.query.range)}),!1,L,E];case"count":return T=E.find(function(D){return Pi(D.req.query.range,P.query.range)}),[T,!!T,L,E]}})(t,n,"query",s),S=y[0],x=y[2],w=y[3],S&&y[1]?S.obsSet=s.obsSet:(y=r.query(s).then(function(_){var k=_.result;if(S&&(S.res=k),l){for(var g=0,P=k.length;g<P;++g)Object.freeze(k[g]);Object.freeze(k)}else _.result=ze(k);return _}).catch(function(_){return w&&S&&Ue(w,S),Promise.reject(_)}),S={obsSet:s.obsSet,promise:y,subscribers:new Set,type:"query",req:s,dirty:!1},w?w.push(S):(w=[S],(x=x||(Je["idb://".concat(t,"/").concat(n)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[s.query.index.name||""]=w)),ro(S,w,f,b),S.promise.then(function(_){return{result:xi(_.result,s,x?.optimisticOps,r,S,l)}})):r.query(s)}})}})}};function bn(e,t){return new Proxy(e,{get:function(n,r,a){return r==="db"?t:Reflect.get(n,r,a)}})}le.prototype.version=function(e){if(isNaN(e)||e<.1)throw new H.Type("Given version is not a positive number");if(e=Math.round(10*e)/10,this.idbdb||this._state.isBeingOpened)throw new H.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,e);var t=this._versions,n=t.filter(function(r){return r._cfg.version===e})[0];return n||(n=new this.Version(e),t.push(n),t.sort(Xa),n.stores({}),this._state.autoSchema=!1),n},le.prototype._whenReady=function(e){var t=this;return this.idbdb&&(this._state.openComplete||U.letThrough||this._vip)?e():new q(function(n,r){if(t._state.openComplete)return r(new H.DatabaseClosed(t._state.dbOpenError));if(!t._state.isBeingOpened){if(!t._state.autoOpen)return void r(new H.DatabaseClosed);t.open().catch(ne)}t._state.dbReadyPromise.then(n,r)}).then(e)},le.prototype.use=function(a){var t=a.stack,n=a.create,r=a.level,a=a.name,s=(a&&this.unuse({stack:t,name:a}),this._middlewares[t]||(this._middlewares[t]=[]));return s.push({stack:t,create:n,level:r??10,name:a}),s.sort(function(l,f){return l.level-f.level}),this},le.prototype.unuse=function(e){var t=e.stack,n=e.name,r=e.create;return t&&this._middlewares[t]&&(this._middlewares[t]=this._middlewares[t].filter(function(a){return r?a.create!==r:!!n&&a.name!==n})),this},le.prototype.open=function(){var e=this;return Ye(De,function(){return Qa(e)})},le.prototype._close=function(){this.on.close.fire(new CustomEvent("close"));var e=this._state,t=pt.indexOf(this);if(0<=t&&pt.splice(t,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}e.isBeingOpened||(e.dbReadyPromise=new q(function(n){e.dbReadyResolve=n}),e.openCanceller=new q(function(n,r){e.cancelOpen=r}))},le.prototype.close=function(t){var t=(t===void 0?{disableAutoOpen:!0}:t).disableAutoOpen,n=this._state;t?(n.isBeingOpened&&n.cancelOpen(new H.DatabaseClosed),this._close(),n.autoOpen=!1,n.dbOpenError=new H.DatabaseClosed):(this._close(),n.autoOpen=this._options.autoOpen||n.isBeingOpened,n.openComplete=!1,n.dbOpenError=null)},le.prototype.delete=function(e){var t=this,n=(e===void 0&&(e={disableAutoOpen:!0}),0<arguments.length&&typeof arguments[0]!="object"),r=this._state;return new q(function(a,s){function l(){t.close(e);var f=t._deps.indexedDB.deleteDatabase(t.name);f.onsuccess=ie(function(){var b,x,w;b=t._deps,x=t.name,or(w=b.indexedDB)||x===rn||ar(w,b.IDBKeyRange).delete(x).catch(ne),a()}),f.onerror=xe(s),f.onblocked=t._fireOnBlocked}if(n)throw new H.InvalidArgument("Invalid closeOptions argument to db.delete()");r.isBeingOpened?r.dbReadyPromise.then(l):l()})},le.prototype.backendDB=function(){return this.idbdb},le.prototype.isOpen=function(){return this.idbdb!==null},le.prototype.hasBeenClosed=function(){var e=this._state.dbOpenError;return e&&e.name==="DatabaseClosed"},le.prototype.hasFailed=function(){return this._state.dbOpenError!==null},le.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(le.prototype,"tables",{get:function(){var e=this;return h(this._allTables).map(function(t){return e._allTables[t]})},enumerable:!1,configurable:!0}),le.prototype.transaction=function(){var e=(function(t,n,r){var a=arguments.length;if(a<2)throw new H.InvalidArgument("Too few arguments");for(var s=new Array(a-1);--a;)s[a-1]=arguments[a];return r=s.pop(),[t,Ur(s),r]}).apply(this,arguments);return this._transaction.apply(this,e)},le.prototype._transaction=function(e,t,n){var r,a,s=this,l=U.trans,f=(l&&l.db===this&&e.indexOf("!")===-1||(l=null),e.indexOf("?")!==-1);e=e.replace("!","").replace("?","");try{if(a=t.map(function(x){if(x=x instanceof s.Table?x.name:x,typeof x!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return x}),e=="r"||e===Wn)r=Wn;else{if(e!="rw"&&e!=Yn)throw new H.InvalidArgument("Invalid transaction mode: "+e);r=Yn}if(l){if(l.mode===Wn&&r===Yn){if(!f)throw new H.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");l=null}l&&a.forEach(function(x){if(l&&l.storeNames.indexOf(x)===-1){if(!f)throw new H.SubTransaction("Table "+x+" not included in parent transaction.");l=null}}),f&&l&&!l.active&&(l=null)}}catch(x){return l?l._promise(null,function(w,y){y(x)}):ce(x)}var b=(function x(w,y,S,_,k){return q.resolve().then(function(){var E=U.transless||U,g=w._createTransaction(y,S,w._dbSchema,_),E=(g.explicit=!0,{trans:g,transless:E});if(_)g.idbtrans=_.idbtrans;else try{g.create(),g.idbtrans._explicit=!0,w._state.PR1398_maxLoop=3}catch(T){return T.name===jn.InvalidState&&w.isOpen()&&0<--w._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),w.close({disableAutoOpen:!1}),w.open().then(function(){return x(w,y,S,null,k)})):ce(T)}var P,L=Mn(k),E=(L&&ft(),q.follow(function(){var T;(P=k.call(g,g))&&(L?(T=Ke.bind(null,null),P.then(T,T)):typeof P.next=="function"&&typeof P.throw=="function"&&(P=pr(P)))},E));return(P&&typeof P.then=="function"?q.resolve(P).then(function(T){return g.active?T:ce(new H.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):E.then(function(){return P})).then(function(T){return _&&g._resolve(),g._completion.then(function(){return T})}).catch(function(T){return g._reject(T),ce(T)})})}).bind(null,this,r,a,l,n);return l?l._promise(r,b,"lock"):U.trans?Ye(U.transless,function(){return s._whenReady(b)}):this._whenReady(b)},le.prototype.table=function(e){if(C(this._allTables,e))return this._allTables[e];throw new H.InvalidTable("Table ".concat(e," does not exist"))};var Be=le;function le(e,t){var n,r,a,s,l,f=this,b=(this._middlewares={},this.verno=0,le.dependencies),b=(this._options=t=c({addons:le.addons,autoOpen:!0,indexedDB:b.indexedDB,IDBKeyRange:b.IDBKeyRange,cache:"cloned"},t),this._deps={indexedDB:t.indexedDB,IDBKeyRange:t.IDBKeyRange},t.addons),x=(this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this,{dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:ne,dbReadyPromise:null,cancelOpen:ne,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:t.autoOpen}),w=(x.dbReadyPromise=new q(function(y){x.dbReadyResolve=y}),x.openCanceller=new q(function(y,S){x.cancelOpen=S}),this._state=x,this.name=e,this.on=Dt(this,"populate","blocked","versionchange","close",{ready:[qn,ne]}),this.once=function(y,S){var _=function(){for(var k=[],g=0;g<arguments.length;g++)k[g]=arguments[g];f.on(y).unsubscribe(_),S.apply(f,k)};return f.on(y,_)},this.on.ready.subscribe=Pt(this.on.ready.subscribe,function(y){return function(S,_){le.vip(function(){var k,g=f._state;g.openComplete?(g.dbOpenError||q.resolve().then(S),_&&y(S)):g.onReadyBeingFired?(g.onReadyBeingFired.push(S),_&&y(S)):(y(S),k=f,_||y(function P(){k.on.ready.unsubscribe(S),k.on.ready.unsubscribe(P)}))})}}),this.Collection=(n=this,Ot(Ra.prototype,function(P,g){this.db=n;var _=ti,k=null;if(g)try{_=g()}catch(E){k=E}var g=P._ctx,P=g.table,L=P.hook.reading.fire;this._ctx={table:P,index:g.index,isPrimKey:!g.index||P.schema.primKey.keyPath&&g.index===P.schema.primKey.name,range:_,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:k,or:g.or,valueMapper:L!==It?L:null}})),this.Table=(r=this,Ot(si.prototype,function(y,S,_){this.db=r,this._tx=_,this.name=y,this.schema=S,this.hook=r._allTables[y]?r._allTables[y].hook:Dt(null,{creating:[Ta,ne],reading:[Aa,It],updating:[Ca,ne],deleting:[Ba,ne]})})),this.Transaction=(a=this,Ot(za.prototype,function(y,S,_,k,g){var P=this;y!=="readonly"&&S.forEach(function(L){L=(L=_[L])==null?void 0:L.yProps,L&&(S=S.concat(L.map(function(E){return E.updatesTable})))}),this.db=a,this.mode=y,this.storeNames=S,this.schema=_,this.chromeTransactionDurability=k,this.idbtrans=null,this.on=Dt(this,"complete","error","abort"),this.parent=g||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new q(function(L,E){P._resolve=L,P._reject=E}),this._completion.then(function(){P.active=!1,P.on.complete.fire()},function(L){var E=P.active;return P.active=!1,P.on.error.fire(L),P.parent?P.parent._reject(L):E&&P.idbtrans&&P.idbtrans.abort(),ce(L)})})),this.Version=(s=this,Ot(Ga.prototype,function(y){this.db=s,this._cfg={version:y,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(l=this,Ot(fi.prototype,function(y,S,_){if(this.db=l,this._ctx={table:y,index:S===":id"?null:S,or:_},this._cmp=this._ascending=Q,this._descending=function(k,g){return Q(g,k)},this._max=function(k,g){return 0<Q(k,g)?k:g},this._min=function(k,g){return Q(k,g)<0?k:g},this._IDBKeyRange=l._deps.IDBKeyRange,!this._IDBKeyRange)throw new H.MissingAPI})),this.on("versionchange",function(y){0<y.newVersion?console.warn("Another connection wants to upgrade database '".concat(f.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(f.name,"'. Closing db now to resume the delete request.")),f.close({disableAutoOpen:!1})}),this.on("blocked",function(y){!y.newVersion||y.newVersion<y.oldVersion?console.warn("Dexie.delete('".concat(f.name,"') was blocked")):console.warn("Upgrade '".concat(f.name,"' blocked by other connection holding version ").concat(y.oldVersion/10))}),this._maxKey=jt(t.IDBKeyRange),this._createTransaction=function(y,S,_,k){return new f.Transaction(y,S,_,f._options.chromeTransactionDurability,k)},this._fireOnBlocked=function(y){f.on("blocked").fire(y),pt.filter(function(S){return S.name===f.name&&S!==f&&!S._state.vcFired}).map(function(S){return S.on("versionchange").fire(y)})},this.use(eo),this.use(io),this.use(to),this.use(Ja),this.use(Za),new Proxy(this,{get:function(y,S,_){var k;return S==="_vip"||(S==="table"?function(g){return bn(f.table(g),w)}:(k=Reflect.get(y,S,_))instanceof si?bn(k,w):S==="tables"?k.map(function(g){return bn(g,w)}):S==="_createTransaction"?function(){return bn(k.apply(this,arguments),w)}:k)}}));this.vip=w,b.forEach(function(y){return y(f)})}var wn,yt=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",ao=(yr.prototype.subscribe=function(e,t,n){return this._subscribe(e&&typeof e!="function"?e:{next:e,error:t,complete:n})},yr.prototype[yt]=function(){return this},yr);function yr(e){this._subscribe=e}try{wn={indexedDB:p.indexedDB||p.mozIndexedDB||p.webkitIndexedDB||p.msIndexedDB,IDBKeyRange:p.IDBKeyRange||p.webkitIDBKeyRange}}catch{wn={indexedDB:null,IDBKeyRange:null}}function Li(e){var t,n=!1,r=new ao(function(a){var s=Mn(e),l,f=!1,b={},x={},w={get closed(){return f},unsubscribe:function(){f||(f=!0,l&&l.abort(),y&&qe.storagemutated.unsubscribe(_))}},y=(a.start&&a.start(w),!1),S=function(){return Xn(k)},_=function(g){vn(b,g),lr(x,b)&&S()},k=function(){var g,P,L;!f&&wn.indexedDB&&(b={},g={},l&&l.abort(),l=new AbortController,L=(E=>{var T=ut();try{s&&ft();var D=Oe(e,E);return D=s?D.finally(Ke):D}finally{T&&dt()}})(P={subscr:g,signal:l.signal,requery:S,querier:e,trans:null}),Promise.resolve(L).then(function(E){n=!0,t=E,f||P.signal.aborted||(b={},(T=>{for(var D in T)if(C(T,D))return;return 1})(x=g)||y||(qe(Mt,_),y=!0),Xn(function(){return!f&&a.next&&a.next(E)}))},function(E){n=!1,["DatabaseClosedError","AbortError"].includes(E?.name)||f||Xn(function(){f||a.error&&a.error(E)})}))};return setTimeout(S,0),w});return r.hasValue=function(){return n},r.getValue=function(){return t},r}var Ze=Be;function gr(e){var t=Re;try{Re=!0,qe.storagemutated.fire(e),fr(e,!0)}finally{Re=t}}A(Ze,c(c({},Ae),{delete:function(e){return new Ze(e,{addons:[]}).delete()},exists:function(e){return new Ze(e,{addons:[]}).open().then(function(t){return t.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(e){try{return t=Ze.dependencies,n=t.indexedDB,t=t.IDBKeyRange,(or(n)?Promise.resolve(n.databases()).then(function(r){return r.map(function(a){return a.name}).filter(function(a){return a!==rn})}):ar(n,t).toCollection().primaryKeys()).then(e)}catch{return ce(new H.MissingAPI)}var t,n},defineClass:function(){return function(e){v(this,e)}},ignoreTransaction:function(e){return U.trans?Ye(U.transless,e):e()},vip:sr,async:function(e){return function(){try{var t=pr(e.apply(this,arguments));return t&&typeof t.then=="function"?t:q.resolve(t)}catch(n){return ce(n)}}},spawn:function(e,t,n){try{var r=pr(e.apply(n,t||[]));return r&&typeof r.then=="function"?r:q.resolve(r)}catch(a){return ce(a)}},currentTransaction:{get:function(){return U.trans||null}},waitFor:function(e,t){return e=q.resolve(typeof e=="function"?Ze.ignoreTransaction(e):e).timeout(t||6e4),U.trans?U.trans.waitFor(e):e},Promise:q,debug:{get:function(){return Ee},set:function(e){Wr(e)}},derive:N,extend:v,props:A,override:Pt,Events:Dt,on:qe,liveQuery:Li,extendObservabilitySet:vn,getByKeyPath:ke,setByKeyPath:pe,delByKeyPath:function(e,t){typeof t=="string"?pe(e,t,void 0):"length"in t&&[].map.call(t,function(n){pe(e,n,void 0)})},shallowClone:zr,deepClone:ze,getObjectDiff:hr,cmp:Q,asap:Xt,minKey:-1/0,addons:[],connections:pt,errnames:jn,dependencies:wn,cache:Je,semVer:"4.3.0",version:"4.3.0".split(".").map(function(e){return parseInt(e)}).reduce(function(e,t,n){return e+t/Math.pow(10,2*n)})})),Ze.maxKey=jt(Ze.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(qe(Mt,function(e){Re||(e=new CustomEvent(Jn,{detail:e}),Re=!0,dispatchEvent(e),Re=!1)}),addEventListener(Jn,function(e){e=e.detail,Re||gr(e)}));var gt,Re=!1,Ii=function(){};return typeof BroadcastChannel<"u"&&((Ii=function(){(gt=new BroadcastChannel(Jn)).onmessage=function(e){return e.data&&gr(e.data)}})(),typeof gt.unref=="function"&&gt.unref(),qe(Mt,function(e){Re||gt.postMessage(e)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(e){if(!Be.disableBfCache&&e.persisted){Ee&&console.debug("Dexie: handling persisted pagehide"),gt?.close();for(var t=0,n=pt;t<n.length;t++)n[t].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(e){!Be.disableBfCache&&e.persisted&&(Ee&&console.debug("Dexie: handling persisted pageshow"),Ii(),gr({all:new fe(-1/0,[[]])}))})),q.rejectionMapper=function(e,t){return!e||e instanceof ct||e instanceof TypeError||e instanceof SyntaxError||!e.name||!Xr[e.name]?e:(t=new Xr[e.name](t||e.message,e),"stack"in e&&V(t,"stack",{get:function(){return this.inner.stack}}),t)},Wr(Ee),c(Be,Object.freeze({__proto__:null,Dexie:Be,Entity:ni,PropModification:Ct,RangeSet:fe,add:function(e){return new Ct({add:e})},cmp:Q,default:Be,liveQuery:Li,mergeRanges:Nt,rangesOverlap:yi,remove:function(e){return new Ct({remove:e})},replacePrefix:function(e,t){return new Ct({replacePrefix:[e,t]})}}),{default:Be}),Be})})(kn)),kn.exports}var mo=ho();const xr=fo(mo),Ti=Symbol.for("Dexie"),Ln=globalThis[Ti]||(globalThis[Ti]=xr);if(xr.semVer!==Ln.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${xr.semVer} and ${Ln.semVer}`);const{liveQuery:ps,mergeRanges:hs,rangesOverlap:ms,RangeSet:vs,cmp:ys,Entity:gs,PropModification:bs,replacePrefix:ws,add:ks,remove:Ss,DexieYProvider:_s}=Ln,Y=new Ln("DukaImara");Y.version(2).stores({profiles:"id, name, pin, role, phone, createdAt",products:"id, name, category, price, stock, emoji, unit, costPrice, sku, description, lowStockThreshold, _hlc, _tombstone",sales:"id, items, total, paymentMethod, profileId, profileName, saleTime, createdAt, receiptId, _hlc, _tombstone",credits:"id, customerName, phone, amount, originalAmount, payments, createdAt, _hlc, _tombstone",debits:"id, customerName, phone, initialDeposit, balance, transactions, createdAt, _hlc, _tombstone",receipts:"id, saleId, receiptData, qrData, createdAt",syncQueue:"id, table, recordId, operation, delta, hlc, retries, status, createdAt",syncLog:"id, action, table, recordId, timestamp, details"});const Sr=Cn();function Le(i,o=!1){const d=Ht();return o&&(i.id=i.id||ge(),i.createdAt=Date.now()),i._hlc=d,i._lastModified=Date.now(),i._deviceId=Sr,i._tombstone=i._tombstone||!1,i._vectorClock=i._vectorClock||{},i._vectorClock[Sr]=(i._vectorClock[Sr]||0)+1,i}async function Ie(i,o,d,c){await Y.syncQueue.add({id:ge(),table:i,recordId:o,operation:d,delta:c,hlc:Ht(),retries:0,status:"pending",createdAt:Date.now()})}function ye(i,o){const d=parseFloat(i);if(isNaN(d)||d<0)throw new Error(`${o} must be a non-negative number`);return d}async function Dn(){return Y.profiles.toArray()}async function Ui(){return await Y.profiles.count()===0}async function Or(i,o,d="staff",c=null,u=null){if(await Ui())d="admin",c={canSell:!0,canAddStock:!0,canManageCredits:!0,canViewReports:!0,canManageDebits:!0};else{if(u){const v=await Y.profiles.get(u);if(!v||v.role!=="admin")throw new Error("Only admin can create profiles")}c||(c={canSell:!0,canAddStock:!1,canManageCredits:!1,canViewReports:!1,canManageDebits:!1})}const h=["#0d9488","#14b8a6","#f97316","#fb923c","#ef4444","#3b82f6","#8b5cf6","#ec4899"],m={id:ge(),name:i,pin:o,role:d,privileges:c,color:h[Math.floor(Math.random()*h.length)],createdAt:Date.now()};return await Y.profiles.add(m),m}async function Hi(i,o){return await Y.profiles.update(i,o),Y.profiles.get(i)}async function Vi(i){if((await Y.profiles.get(i))?.role==="admin")throw new Error("Cannot delete the admin profile");await Y.profiles.delete(i)}async function Xi(i,o){const d=await Y.profiles.get(i);return d&&d.pin===o}function rt(i,o){return i?i.role==="admin"?!0:i.privileges?.[o]===!0:!1}async function xt(){return Y.products.filter(i=>!i._tombstone).toArray()}async function Wi(i){ye(i.price,"Price"),ye(i.stock,"Stock"),i.costPrice!==void 0&&i.costPrice!==""&&ye(i.costPrice,"Cost price");const o=Le({...i},!0);return await Y.products.add(o),await Ie("products",o.id,"CREATE",i),o}async function Kr(i,o){const d=await Y.products.get(i);if(!d)return null;o.price!==void 0&&ye(o.price,"Price"),o.stock!==void 0&&ye(o.stock,"Stock"),o.costPrice!==void 0&&o.costPrice!==""&&ye(o.costPrice,"Cost price");const c=Le({...d,...o});return await Y.products.put(c),await Ie("products",i,"UPDATE",o),c}async function Yi(i){const o=await Y.products.get(i);if(!o)return;const d=Le({...o,_tombstone:!0});await Y.products.put(d),await Ie("products",i,"DELETE",{_tombstone:!0})}async function Gi(){const i=new Date;return i.setHours(0,0,0,0),Y.sales.filter(o=>!o._tombstone&&o.createdAt>=i.getTime()).toArray()}async function In(i,o,d,c,u,p=null){ye(o,"Total"),i.forEach($=>{ye($.price,"Item price"),ye($.quantity,"Item quantity")});const h=`TS-${Date.now().toString(36).toUpperCase()}-${ge().substr(0,4).toUpperCase()}`,m=new Date().toISOString(),v={items:i,total:o,paymentMethod:d,customerCreditId:p,profileId:c,profileName:u||"Unknown",saleTime:m,receiptId:h},I=Le({...v},!0);await Y.sales.add(I);for(const $ of i){const C=await Y.products.get($.productId);C&&await Kr($.productId,{stock:Math.max(0,C.stock-$.quantity)})}return await Ie("sales",I.id,"CREATE",v),I}async function Vt(){return Y.credits.filter(i=>!i._tombstone).toArray()}async function Qi(i){if(!i)return null;const o=i.replace(/\s/g,"");return(await Y.credits.filter(c=>!c._tombstone).toArray()).find(c=>c.phone===o)||null}async function Mr(i,o,d,c){ye(d,"Credit amount");const u=o?o.replace(/\s/g,""):"";if(u){const m=await Qi(u);if(m){const v=m.amount+d,I=(m.originalAmount||m.amount)+d,$={amount:v,originalAmount:I,customerName:i||m.customerName},C=Le({...m,...$});return await Y.credits.put(C),await Ie("credits",m.id,"UPDATE",$),C}}const p={customerName:i,phone:u,amount:d,originalAmount:d,payments:[],trustScore:50,profileId:c},h=Le({...p},!0);return await Y.credits.add(h),await Ie("credits",h.id,"CREATE",p),h}async function Ji(i,o){const d=await Y.credits.get(i);if(!d)return null;const c=parseFloat(o);if(isNaN(c)||c<=0)throw new Error("Payment amount must be greater than 0");if(c>d.amount)throw new Error(`Payment amount (${c}) cannot exceed outstanding balance (${d.amount})`);const u={id:ge(),amount:c,date:Date.now()},p=[...d.payments||[],u],h=Math.min(100,(d.trustScore||50)+10),m=Math.max(0,d.amount-c),v={payments:p,trustScore:h,amount:m},I=Le({...d,...v});return await Y.credits.put(I),await Ie("credits",i,"UPDATE",v),I}async function jr(){return Y.debits.filter(i=>!i._tombstone).toArray()}async function Zi(i,o,d){ye(d,"Initial deposit");const c=o?o.replace(/\s/g,""):"",u={customerName:i,phone:c,initialDeposit:d,balance:d,transactions:[{id:ge(),type:"deposit",amount:d,description:"Initial deposit",date:Date.now()}]},p=Le({...u},!0);return await Y.debits.add(p),await Ie("debits",p.id,"CREATE",u),p}async function ea(i,o,d="Purchase"){const c=await Y.debits.get(i);if(!c)return null;const u=ye(o,"Purchase amount");if(u>c.balance)throw new Error(`Insufficient balance. Available: KSh ${c.balance}, Requested: KSh ${u}`);const p={id:ge(),type:"purchase",amount:u,description:d,date:Date.now()},h=[...c.transactions||[],p],m=c.balance-u,v={transactions:h,balance:m},I=Le({...c,...v});return await Y.debits.put(I),await Ie("debits",i,"UPDATE",v),I}async function ta(i,o){const d=await Y.debits.get(i);if(!d)return null;const c=ye(o,"Top-up amount"),u={id:ge(),type:"deposit",amount:c,description:"Top-up",date:Date.now()},p=[...d.transactions||[],u],h=d.balance+c,m={transactions:p,balance:h},v=Le({...d,...m});return await Y.debits.put(v),await Ie("debits",i,"UPDATE",m),v}async function qr(){return Y.syncQueue.where("status").equals("pending").toArray()}async function Sn(i,o){await Y.syncQueue.update(i,o)}async function na(){await Y.syncQueue.where("status").equals("done").delete()}async function Ft(i,o,d,c=""){await Y.syncLog.add({id:ge(),action:i,table:o,recordId:d,timestamp:Date.now(),details:c})}async function ra(i=50){return Y.syncLog.reverse().limit(i).toArray()}async function ia(i){const o=await Gi(),d=await xt(),c=await Vt(),u=o.reduce((v,I)=>v+I.total,0),p=o.reduce((v,I)=>v+I.items.reduce(($,C)=>$+C.quantity,0),0),h=d.filter(v=>v.stock<=(v.lowStockThreshold||5)),m=c.reduce((v,I)=>v+I.amount,0);return{totalRevenue:u,itemsSold:p,salesCount:o.length,lowStock:h,totalOwed:m,totalProducts:d.length,totalCredits:c.length}}async function aa(i=null,o=null,d=null,c=null){let u=await Y.sales.filter(A=>!A._tombstone).toArray();i&&(u=u.filter(A=>A.createdAt>=i)),o&&(u=u.filter(A=>A.createdAt<=o)),d&&(u=u.filter(A=>A.paymentMethod===d)),c&&(u=u.filter(A=>A.profileId===c)),u.sort((A,B)=>B.createdAt-A.createdAt);const p=u.reduce((A,B)=>A+B.total,0),h=u.reduce((A,B)=>A+B.items.reduce((V,N)=>V+N.quantity,0),0),m=u.length>0?p/u.length:0,v={};u.forEach(A=>{A.items.forEach(B=>{v[B.name]||(v[B.name]={name:B.name,quantity:0,revenue:0}),v[B.name].quantity+=B.quantity,v[B.name].revenue+=B.subtotal})});const I=Object.values(v).sort((A,B)=>B.revenue-A.revenue).slice(0,10),$={};u.forEach(A=>{$[A.paymentMethod]||($[A.paymentMethod]={count:0,total:0}),$[A.paymentMethod].count++,$[A.paymentMethod].total+=A.total});const C={};return u.forEach(A=>{const B=A.profileName||"Unknown";C[B]||(C[B]={count:0,total:0}),C[B].count++,C[B].total+=A.total}),{sales:u,totalRevenue:p,totalItems:h,totalSales:u.length,avgSaleSize:m,topProducts:I,byMethod:$,byProfile:C}}const oa=Object.freeze(Object.defineProperty({__proto__:null,addCredit:Mr,addPayment:Ji,addProduct:Wi,addSyncLog:Ft,clearCompletedSync:na,createDebit:Zi,createProfile:Or,db:Y,debitPurchase:ea,debitTopUp:ta,deleteProduct:Yi,deleteProfile:Vi,findCreditByPhone:Qi,getCredits:Vt,getDashboardStats:ia,getDebits:jr,getPendingSync:qr,getProducts:xt,getProfiles:Dn,getSalesReport:aa,getSyncLogs:ra,getTodaysSales:Gi,hasPrivilege:rt,isFirstProfile:Ui,recordSale:In,updateProduct:Kr,updateProfile:Hi,updateSyncEntry:Sn,verifyPin:Xi},Symbol.toStringTag,{value:"Module"}));let _r=[];const vo=3e3;function W(i,o="info"){const d=document.getElementById("toast-container");if(!d)return;const c=document.createElement("div");c.className=`toast ${o}`;const u={success:"â",error:"â",warning:"â ",info:"â¹"};c.innerHTML=`
        <span style="font-size: 14px; font-weight: 800;">${u[o]||"â¹"}</span>
        <span>${i}</span>
    `,d.appendChild(c),_r.push(c),setTimeout(()=>{c.style.opacity="0",c.style.transform="translateY(-8px)",c.style.transition="all 0.25s ease",setTimeout(()=>{c.remove(),_r=_r.filter(p=>p!==c)},250)},vo)}let $n=null,ve="",Se="",Pr=null;function at(){return{pinLock:document.getElementById("pin-lock"),mainApp:document.getElementById("main-app"),pinProfiles:document.getElementById("pin-profiles"),pinEntry:document.getElementById("pin-entry"),pinDots:document.querySelector("#pin-entry .pin-dots"),addProfileBtn:document.getElementById("add-profile-btn"),newProfileForm:document.getElementById("new-profile-form"),profileNameInput:document.getElementById("profile-name"),newPinDots:document.getElementById("new-pin-dots"),newPinKeypad:document.getElementById("new-pin-keypad"),createProfileBtn:document.getElementById("create-profile-btn"),cancelProfileBtn:document.getElementById("cancel-profile-btn"),pinCancel:document.getElementById("pin-cancel"),activeUser:document.getElementById("active-user")}}async function sa(){const i=at(),o=await Dn();if(o.length===0){i.pinProfiles.innerHTML=`
            <div class="empty-state" style="padding: 16px;">
                <p style="font-size: 0.85rem; color: var(--text-muted);">
                    Create the admin profile to get started
                </p>
            </div>`,i.addProfileBtn&&(i.addProfileBtn.textContent="+ Create Admin");return}i.pinProfiles.innerHTML=o.map(d=>`
        <div class="profile-circle" data-id="${d.id}">
            <div class="profile-avatar" style="background: ${d.color}">
                ${d.name.charAt(0).toUpperCase()}
                ${d.role==="admin"?'<span class="admin-crown">ð</span>':""}
            </div>
            <span class="profile-name">${d.name}</span>
            <span class="profile-role-badge ${d.role}">${d.role==="admin"?"Admin":"Staff"}</span>
        </div>
    `).join(""),i.addProfileBtn&&(i.addProfileBtn.style.display="none"),i.pinProfiles.querySelectorAll(".profile-circle").forEach(d=>{d.addEventListener("click",()=>yo(d.dataset.id,o))})}function yo(i,o){const d=at();$n=o.find(c=>c.id===i),ve="",d.pinProfiles.querySelectorAll(".profile-circle").forEach(c=>{c.classList.toggle("selected",c.dataset.id===i)}),d.pinEntry.classList.remove("hidden"),d.addProfileBtn&&d.addProfileBtn.classList.add("hidden"),it(d.pinDots,ve.length)}function it(i,o){i.querySelectorAll(".dot").forEach((c,u)=>{c.classList.toggle("filled",u<o),c.classList.remove("error")})}function go(i){i.querySelectorAll(".dot").forEach(o=>{o.classList.add("error")}),setTimeout(()=>{i.querySelectorAll(".dot").forEach(o=>o.classList.remove("error"))},500)}async function bo(i){const o=at();if(i==="back"){ve=ve.slice(0,-1),it(o.pinDots,ve.length);return}ve.length>=4||(ve+=i,it(o.pinDots,ve.length),ve.length===4&&(await Xi($n.id,ve)?ca($n):(go(o.pinDots),ve="",setTimeout(()=>it(o.pinDots,0),500))))}function wo(i){const o=at();if(i==="back"){Se=Se.slice(0,-1),it(o.newPinDots,Se.length),o.createProfileBtn.disabled=!0;return}Se.length>=4||(Se+=i,it(o.newPinDots,Se.length),Se.length===4&&(o.createProfileBtn.disabled=!1))}function ca(i){const o=at();o.pinLock.classList.remove("active"),o.mainApp.classList.add("active");const d=i.role==="admin"?" ð":"";o.activeUser.textContent=i.name+d,Pr&&Pr(i)}function la(){const i=at();i.mainApp.classList.remove("active"),i.pinLock.classList.add("active"),$n=null,ve="",i.pinEntry.classList.add("hidden"),i.newProfileForm.classList.add("hidden"),i.addProfileBtn&&i.addProfileBtn.classList.remove("hidden"),sa()}function ko(i){Pr=i;const o=at();o.pinEntry.querySelector(".pin-keypad").addEventListener("click",c=>{const u=c.target.closest(".key")?.dataset?.key;u&&bo(u)}),o.pinCancel.addEventListener("click",()=>{ve="",o.pinEntry.classList.add("hidden"),o.addProfileBtn&&o.addProfileBtn.classList.remove("hidden"),o.pinProfiles.querySelectorAll(".profile-circle").forEach(c=>{c.classList.remove("selected")})}),o.addProfileBtn.addEventListener("click",async()=>{o.addProfileBtn.classList.add("hidden"),o.pinProfiles.classList.add("hidden"),o.newProfileForm.classList.remove("hidden"),Se="",o.profileNameInput.value="",o.createProfileBtn.disabled=!0,it(o.newPinDots,0),o.profileNameInput.focus()}),o.newPinKeypad.addEventListener("click",c=>{const u=c.target.closest(".key")?.dataset?.key;u&&wo(u)}),o.createProfileBtn.addEventListener("click",async()=>{const c=o.profileNameInput.value.trim();if(!(!c||Se.length!==4))try{const u=await Or(c,Se);o.newProfileForm.classList.add("hidden"),o.pinProfiles.classList.remove("hidden"),o.addProfileBtn&&o.addProfileBtn.classList.remove("hidden"),W(u.role==="admin"?`Admin profile "${c}" created! ð`:`Profile "${c}" created!`,"success"),ca(u)}catch(u){W(u.message,"error")}}),o.cancelProfileBtn.addEventListener("click",()=>{o.newProfileForm.classList.add("hidden"),o.pinProfiles.classList.remove("hidden"),o.addProfileBtn&&o.addProfileBtn.classList.remove("hidden"),Se=""}),sa()}let ua="dashboard",Lr=null;function So(i,o){Lr=i,document.getElementById("bottom-nav").addEventListener("click",c=>{const u=c.target.closest(".nav-btn");if(!u)return;const p=u.dataset.page;p&&p!==ua&&Rr(p)})}function Rr(i){ua=i,document.getElementById("bottom-nav").querySelectorAll(".nav-btn").forEach(d=>{d.classList.toggle("active",d.dataset.page===i)}),history.replaceState(null,"",`#${i}`),Lr&&Lr(i)}function _o(i){const o=document.getElementById("bottom-nav"),d=o.querySelector('[data-page="sales"]'),c=o.querySelector('[data-page="inventory"]'),u=o.querySelector('[data-page="credits"]'),p=o.querySelector('[data-page="settings"]');d&&(d.style.display=rt(i,"canSell")?"":"none"),c&&(c.style.display=rt(i,"canAddStock")?"":"none"),u&&(u.style.display=rt(i,"canManageCredits")?"":"none"),p&&(i.role==="admin"?(p.dataset.page="admin",p.querySelector("span").textContent="Admin"):(p.dataset.page="settings",p.querySelector("span").textContent="More"))}const Ir=new Set;let St=navigator.onLine,da=null,$r="unknown",_t=parseInt(localStorage.getItem("ts_lastOnline")||"0"),_n=null;function Ar(){return St}function Nr(){return St||!_t?0:Date.now()-_t}function fa(){const i=Nr();if(i===0)return"";const o=Math.floor(i/36e5),d=Math.floor(o/24);return d>0?`${d} day${d>1?"s":""} offline`:o>0?`${o} hour${o>1?"s":""} offline`:"Recently offline"}function Eo(i){return Ir.add(i),()=>Ir.delete(i)}function zt(i){const o=St!==i;St=i,i&&(_t=Date.now(),localStorage.setItem("ts_lastOnline",String(_t))),o&&An()}function An(){Ir.forEach(i=>i({online:St,battery:da,connectionType:$r,offlineDuration:Nr()}))}async function Tr(){if(!navigator.onLine){zt(!1);return}try{const i=new AbortController,o=setTimeout(()=>i.abort(),5e3),d=await fetch("/api/health",{method:"GET",cache:"no-store",signal:i.signal});clearTimeout(o),zt(d.ok)}catch{zt(navigator.onLine)}}function xo(i=1e4){Po(),Tr(),_n=setInterval(Tr,i)}function Po(){_n&&(clearInterval(_n),_n=null)}window.addEventListener("online",()=>{zt(!0),setTimeout(Tr,1e3)});window.addEventListener("offline",()=>{zt(!1)});navigator.connection&&($r=navigator.connection.effectiveType||"unknown",navigator.connection.addEventListener("change",()=>{$r=navigator.connection.effectiveType||"unknown",An()}));navigator.getBattery&&navigator.getBattery().then(i=>{da=i,i.addEventListener("levelchange",An),i.addEventListener("chargingchange",An)}).catch(()=>{});St&&(_t=Date.now(),localStorage.setItem("ts_lastOnline",String(_t)));const Lo="/api/sync";let En=null,Ne=!1,bt=null,xn=[];function pa(i){return xn.push(i),()=>{xn=xn.filter(o=>o!==i)}}function tt(i){xn.forEach(o=>o(i))}async function ha(){const i=await qr();return{isSyncing:Ne,lastSyncTime:bt,pendingCount:i.length}}async function ma(){Ne||await ga()}function va(i=3e4){ya(),En=setInterval(async()=>{!Ne&&Ar()&&await ga()},i)}function ya(){En&&(clearInterval(En),En=null)}async function ga(){if(!Ne){Ne=!0,tt({status:"syncing",pendingCount:0});try{const i=await qr();if(i.length===0){Ne=!1,bt=Date.now(),tt({status:"synced",lastSync:bt,pendingCount:0});return}Nr()>864e5&&tt({status:"syncing",detail:`Syncing ${i.length} queued changes...`,pendingCount:i.length});const d=10;let c=0,u=0;for(let p=0;p<i.length;p+=d){const h=i.slice(p,p+d);try{const m=h.map(I=>({table:I.table,id:I.recordId,operation:I.operation,delta:I.delta,hlc:I.hlc})),v=await fetch(Lo,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceId:localStorage.getItem("ts_deviceId")||"unknown",operations:m,timestamp:Date.now()})});if(v.ok){for(const I of h)await Sn(I.id,{status:"done"});c+=h.length,await Ft("SYNC_SUCCESS",h[0].table,h[0].recordId,`Synced ${h.length} operations`)}else{for(const I of h)await Sn(I.id,{retries:(I.retries||0)+1,status:"pending",lastError:`Server returned ${v.status}`});u+=h.length,await Ft("SYNC_SERVER_ERROR",h[0].table,h[0].recordId,`Server error: ${v.status}`)}}catch{for(const v of h)await Sn(v.id,{retries:(v.retries||0)+1,status:"pending"});u+=h.length,await Ft("SYNC_NETWORK_ERROR",h[0]?.table,h[0]?.recordId,"Network unreachable")}tt({status:"syncing",detail:`${c}/${i.length} synced`,pendingCount:i.length-c})}await na(),bt=Date.now(),Ne=!1,u>0?tt({status:"partial",detail:`${c} synced, ${u} pending`,lastSync:bt,pendingCount:u}):tt({status:"synced",lastSync:bt,pendingCount:0})}catch(i){Ne=!1,console.error("[Sync] Error:",i),await Ft("SYNC_ERROR","","",i.message),tt({status:"error",detail:i.message,pendingCount:-1})}}}const Io=Object.freeze(Object.defineProperty({__proto__:null,forceSync:ma,getSyncStatus:ha,onSyncStatusChange:pa,startAutoSync:va,stopAutoSync:ya},Symbol.toStringTag,{value:"Module"}));function $o(){const i=document.querySelector(".sync-dot"),o=document.querySelector(".sync-text"),d=document.getElementById("sync-now-btn"),c=document.getElementById("sync-pending-badge");function u(h){if(!i||!o)return;if(i.className="sync-dot",Ar())if(h?.status==="syncing")i.classList.add("syncing"),o.textContent="Syncing...",d?.classList.add("spinning");else if(h?.status==="retry")i.classList.add("syncing"),o.textContent=h.detail||"Retrying...";else if(h?.status==="partial")i.classList.add("syncing"),o.textContent=h.detail||"Partial sync";else if(i.classList.add("online"),d?.classList.remove("spinning"),h?.lastSync){const v=Ao(h.lastSync);o.textContent=`Online â Synced ${v}`}else o.textContent="Online â Synced";else{i.classList.add("offline");const v=fa();o.textContent=v?`Offline â ${v}`:"Offline â changes queued"}c&&h?.pendingCount!==void 0&&(h.pendingCount>0?(c.textContent=h.pendingCount,c.classList.remove("hidden")):c.classList.add("hidden"))}pa(h=>u(h)),Eo(({online:h})=>{u({status:h?"synced":"offline"})}),d?.addEventListener("click",async()=>{d.classList.add("spinning"),await ma(),setTimeout(()=>d.classList.remove("spinning"),1e3)});const p=async()=>{const h=await ha();u({status:Ar()?h.isSyncing?"syncing":"synced":"offline",lastSync:h.lastSyncTime,pendingCount:h.pendingCount})};p(),setInterval(p,5e3)}function Ao(i){const o=Date.now()-i;return o<6e4?"just now":o<36e5?`${Math.floor(o/6e4)}m ago`:o<864e5?`${Math.floor(o/36e5)}h ago`:"a while ago"}async function To(i,o,d,{navigateTo:c,addToCart:u}){const p=await ia(),h=await xt(),m=h.slice(0,6),v=new Date,I=v.getHours()<12?"Good morning":v.getHours()<17?"Good afternoon":"Good evening",$=v.toLocaleDateString("en-KE",{weekday:"long",month:"short",day:"numeric"}),C=fa();i.innerHTML=`
        <div class="page active" id="page-dashboard">
            <div class="page-header">
                <div>
                    <h2>${I}, ${d?.name||""} ${d?.role==="admin"?"ð":""}!</h2>
                    <div class="subtitle">${$}</div>
                </div>
            </div>

            ${C?`
                <div class="offline-banner">
                    <span>â¡</span> ${C} â your data is safe locally
                </div>
            `:""}

            <div class="stats-grid">
                <div class="stat-card revenue-card">
                    <div class="stat-label">Today's Revenue</div>
                    <div class="stat-value">KSh ${p.totalRevenue.toLocaleString()}</div>
                    <div class="stat-sub">${p.salesCount} sale${p.salesCount!==1?"s":""} Â· ${p.itemsSold} items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Products</div>
                    <div class="stat-value">${p.totalProducts}</div>
                    <div class="stat-sub">in catalog</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Owed to You</div>
                    <div class="stat-value" style="color: var(--accent-secondary);">KSh ${p.totalOwed.toLocaleString()}</div>
                    <div class="stat-sub">${p.totalCredits} customer${p.totalCredits!==1?"s":""}</div>
                </div>
            </div>

            ${p.lowStock.length>0?`
                <div class="section-header">
                    <h3>â ï¸ Low Stock Alerts</h3>
                    <button class="view-all" id="dash-view-inventory">View All</button>
                </div>
                <div class="alerts-list">
                    ${p.lowStock.map(A=>`
                        <div class="alert-item">
                            <div class="alert-icon low-stock">${A.emoji||"ð¦"}</div>
                            <div class="alert-info">
                                <div class="alert-title">${A.name}</div>
                                <div class="alert-desc">${A.stock} ${A.unit||"pcs"} left â restock soon</div>
                            </div>
                            <span class="badge badge-warning">${A.stock}</span>
                        </div>
                    `).join("")}
                </div>
            `:""}

            ${m.length>0&&rt(d,"canSell")?`
                <div class="section-header">
                    <h3>â¡ Quick Sell</h3>
                    <button class="view-all" id="dash-view-sales">Sell Page â</button>
                </div>
                <div class="quick-sell-grid">
                    ${m.map(A=>`
                        <div class="quick-sell-item" data-id="${A.id}">
                            <span class="qs-emoji">${A.emoji||"ð¦"}</span>
                            <span class="qs-name">${A.name}</span>
                            <span class="qs-price">KSh ${A.price.toLocaleString()}</span>
                        </div>
                    `).join("")}
                </div>
            `:m.length===0?`
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                    </svg>
                    <h3>No products yet</h3>
                    <p>Head to the Stock page to add your first product</p>
                </div>
            `:""}
        </div>
    `,i.querySelectorAll(".quick-sell-item").forEach(A=>{A.addEventListener("click",()=>{const B=h.find(V=>V.id===A.dataset.id);B&&B.stock>0?(u(B),W(`${B.name} added to cart`,"success"),c("sales")):W("Out of stock!","warning")})}),i.querySelector("#dash-view-inventory")?.addEventListener("click",()=>c("inventory")),i.querySelector("#dash-view-sales")?.addEventListener("click",()=>c("sales"))}function Bo(i,o){const d=document.createElement("div");d.className=`product-tile${i.stock<=0?" out-of-stock":""}`,d.dataset.id=i.id;const c=i.stock<=(i.lowStockThreshold||5)?" low":"",u=i.unit&&i.unit!=="pcs"?`/${i.unit}`:"";return d.innerHTML=`
        <span class="pt-emoji">${i.emoji||"ð¦"}</span>
        <span class="pt-name">${i.name}</span>
        <span class="pt-price">KSh ${i.price.toLocaleString()}${u}</span>
        <span class="pt-stock${c}">${i.stock} ${i.unit||"pcs"}</span>
        <span class="pt-add-badge">+</span>
    `,o&&d.addEventListener("click",()=>o(i)),d}function Co(i,o){const d=document.createElement("div");d.className="inventory-item",d.dataset.id=i.id;const c=i.stock<=0?"out":i.stock<=(i.lowStockThreshold||5)?"low":"",u=i.unit||"pcs",p=i.costPrice&&i.price?Math.round((i.price-i.costPrice)/i.price*100):null;return d.innerHTML=`
        <span class="inv-emoji">${i.emoji||"ð¦"}</span>
        <div class="inv-info">
            <div class="inv-name">${i.name}</div>
            <div class="inv-meta">${i.category||"General"} Â· KSh ${i.price.toLocaleString()}/${u}</div>
            ${i.description?`<div class="inv-desc">${i.description}</div>`:""}
            ${i.sku?`<div class="inv-sku">SKU: ${i.sku}</div>`:""}
        </div>
        <div class="inv-stock ${c}">
            <div class="stock-count">${i.stock}</div>
            <div class="stock-label">${u}</div>
            ${p!==null?`<div class="stock-margin ${p>=20?"good":"low"}">${p}% margin</div>`:""}
        </div>
    `,o&&d.addEventListener("click",()=>o(i)),d}const nt=new Uint8Array(512),Br=new Uint8Array(256);(function(){let o=1;for(let d=0;d<255;d++)nt[d]=o,Br[o]=d,o=o<<1^(o&128?285:0);nt[255]=nt[0];for(let d=256;d<512;d++)nt[d]=nt[d-255]})();function ba(i,o){return i===0||o===0?0:nt[Br[i]+Br[o]]}function Do(i){let o=[1];for(let d=0;d<i;d++){const c=new Array(o.length+1).fill(0);for(let u=0;u<o.length;u++)c[u]^=o[u],c[u+1]^=ba(o[u],nt[d]);o=c}return o}function Oo(i,o){const d=Do(o),c=new Array(i.length+o).fill(0);for(let u=0;u<i.length;u++)c[u]=i[u];for(let u=0;u<i.length;u++){const p=c[u];if(p!==0)for(let h=1;h<d.length;h++)c[u+h]^=ba(d[h],p)}return c.slice(i.length)}const Fr=[null,{size:21,totalData:19,ecPerBlock:7,blocks:1,alignment:[]},{size:25,totalData:34,ecPerBlock:10,blocks:1,alignment:[18]},{size:29,totalData:55,ecPerBlock:15,blocks:1,alignment:[22]},{size:33,totalData:80,ecPerBlock:20,blocks:1,alignment:[26]},{size:37,totalData:108,ecPerBlock:26,blocks:1,alignment:[30]},{size:41,totalData:136,ecPerBlock:18,blocks:2,alignment:[34]},{size:45,totalData:156,ecPerBlock:20,blocks:2,alignment:[6,22,38]},{size:49,totalData:194,ecPerBlock:24,blocks:2,alignment:[6,24,42]},{size:53,totalData:232,ecPerBlock:30,blocks:2,alignment:[6,26,46]},{size:57,totalData:274,ecPerBlock:18,blocks:2,alignment:[6,28,50]}],Bi=Fr.length-1,Ko=[30660,29427,32170,30877,26159,25368,27713,26998];function Mo(i){for(let o=1;o<=Bi;o++){const c=4+(o<=9?8:16)+i*8;if(Fr[o].totalData*8>=c)return o}return Bi}function jo(i){let o=new TextEncoder().encode(i);const d=Mo(o.length),c=Fr[d],u=c.totalData*8,p=d<=9?8:16,h=Math.floor((u-4-p)/8);o.length>h&&(o=o.slice(0,h));let m="0100";m+=o.length.toString(2).padStart(p,"0");for(const N of o)m+=N.toString(2).padStart(8,"0");for(m+="0".repeat(Math.min(4,u-m.length));m.length%8!==0&&m.length<u;)m+="0";const v=["11101100","00010001"];let I=0;for(;m.length<u;)m+=v[I++%2];m=m.substring(0,u);const $=[];for(let N=0;N<m.length;N+=8)$.push(parseInt(m.substr(N,8),2));const C=Math.ceil($.length/c.blocks),A=[],B=[];for(let N=0;N<c.blocks;N++){const Z=N*C,_e=$.slice(Z,Math.min(Z+C,$.length));for(;_e.length<C;)_e.push(0);A.push(_e),B.push(Oo(_e,c.ecPerBlock))}const V=[];for(let N=0;N<C;N++)for(let Z=0;Z<c.blocks;Z++)N<A[Z].length&&V.push(A[Z][N]);for(let N=0;N<c.ecPerBlock;N++)for(let Z=0;Z<c.blocks;Z++)N<B[Z].length&&V.push(B[Z][N]);return{version:d,cfg:c,codewords:V}}function qo(i){return{modules:Array.from({length:i},()=>Array(i).fill(!1)),reserved:Array.from({length:i},()=>Array(i).fill(!1)),size:i}}function Ut(i,o,d,c,u=!0){o>=0&&o<i.size&&d>=0&&d<i.size&&(i.modules[o][d]=c,u&&(i.reserved[o][d]=!0))}function Er(i,o,d){for(let c=-1;c<=7;c++)for(let u=-1;u<=7;u++){const p=o+c,h=d+u;if(p<0||p>=i.size||h<0||h>=i.size)continue;let m;c===-1||c===7||u===-1||u===7?m=!1:c===0||c===6||u===0||u===6||c>=2&&c<=4&&u>=2&&u<=4?m=!0:m=!1,Ut(i,p,h,m)}}function Ci(i,o,d){for(let c=-2;c<=2;c++)for(let u=-2;u<=2;u++){const p=o+c,h=d+u;if(!(p<0||p>=i.size||h<0||h>=i.size)&&i.reserved[p][h])return}for(let c=-2;c<=2;c++)for(let u=-2;u<=2;u++){const p=o+c,h=d+u,m=Math.abs(c)===2||Math.abs(u)===2||c===0&&u===0;Ut(i,p,h,m)}}function Ro(i){for(let o=8;o<i.size-8;o++){const d=o%2===0;i.reserved[6][o]||Ut(i,6,o,d),i.reserved[o][6]||Ut(i,o,6,d)}}function No(i){for(let o=0;o<9;o++)i.reserved[8][o]||(i.reserved[8][o]=!0),i.reserved[o][8]||(i.reserved[o][8]=!0);for(let o=0;o<8;o++){const d=i.size-1-o;i.reserved[8][d]||(i.reserved[8][d]=!0)}for(let o=0;o<7;o++){const d=i.size-1-o;i.reserved[d][8]||(i.reserved[d][8]=!0)}Ut(i,i.size-8,8,!0)}function Fo(i,o){const d=[];for(const p of o)for(let h=7;h>=0;h--)d.push(p>>h&1);let c=0,u=!0;for(let p=i.size-1;p>=0;p-=2){p===6&&(p=5);const h=u?Array.from({length:i.size},(m,v)=>i.size-1-v):Array.from({length:i.size},(m,v)=>v);for(const m of h)for(const v of[p,p-1])v<0||v>=i.size||i.reserved[m][v]||(i.modules[m][v]=c<d.length?d[c++]===1:!1);u=!u}}const zo=[(i,o)=>(i+o)%2===0,(i,o)=>i%2===0,(i,o)=>o%3===0,(i,o)=>(i+o)%3===0,(i,o)=>(Math.floor(i/2)+Math.floor(o/3))%2===0,(i,o)=>i*o%2+i*o%3===0,(i,o)=>(i*o%2+i*o%3)%2===0,(i,o)=>((i+o)%2+i*o%3)%2===0];function Di(i,o){const d=zo[o];for(let c=0;c<i.size;c++)for(let u=0;u<i.size;u++)!i.reserved[c][u]&&d(c,u)&&(i.modules[c][u]=!i.modules[c][u])}function Uo(i){let o=0;const d=i.size;for(let c=0;c<d;c++){let u=1;for(let p=1;p<d;p++)i.modules[c][p]===i.modules[c][p-1]?u++:(u>=5&&(o+=u-2),u=1);u>=5&&(o+=u-2)}for(let c=0;c<d;c++){let u=1;for(let p=1;p<d;p++)i.modules[p][c]===i.modules[p-1][c]?u++:(u>=5&&(o+=u-2),u=1);u>=5&&(o+=u-2)}for(let c=0;c<d-1;c++)for(let u=0;u<d-1;u++){const p=i.modules[c][u];p===i.modules[c][u+1]&&p===i.modules[c+1][u]&&p===i.modules[c+1][u+1]&&(o+=3)}return o}function Oi(i,o){const d=Ko[o],c=[];for(let p=0;p<=5;p++)c.push([8,p]);c.push([8,7],[8,8],[7,8]);for(let p=5;p>=0;p--)c.push([p,8]);const u=[];for(let p=0;p<7;p++)u.push([i.size-1-p,8]);u.push([8,i.size-8]);for(let p=6;p>=1;p--)u.push([8,i.size-p]);for(let p=0;p<15;p++){const h=(d>>14-p&1)===1;if(p<c.length){const[m,v]=c[p];m>=0&&m<i.size&&v>=0&&v<i.size&&(i.modules[m][v]=h)}if(p<u.length){const[m,v]=u[p];m>=0&&m<i.size&&v>=0&&v<i.size&&(i.modules[m][v]=h)}}}function Ho(i){if(!i||i.length===0)return[];const{cfg:o,codewords:d}=jo(i),c=qo(o.size);if(Er(c,0,0),Er(c,0,c.size-7),Er(c,c.size-7,0),o.alignment.length>0){const m=o.alignment;if(m.length===1)Ci(c,m[0],m[0]);else for(const v of m)for(const I of m)Ci(c,v,I)}Ro(c),No(c),Fo(c,d);let u=0,p=1/0;const h=c.modules.map(m=>[...m]);for(let m=0;m<8;m++){c.modules=h.map(I=>[...I]),Di(c,m),Oi(c,m);const v=Uo(c);v<p&&(p=v,u=m)}return c.modules=h.map(m=>[...m]),Di(c,u),Oi(c,u),c.modules}function Vo(i,o=4,d=4){const c=Ho(i);if(c.length===0)return"";const u=c.length,p=(u+d*2)*o,h=document.createElement("canvas");h.width=p,h.height=p;const m=h.getContext("2d");m.fillStyle="#ffffff",m.fillRect(0,0,p,p),m.fillStyle="#000000";for(let v=0;v<u;v++)for(let I=0;I<u;I++)c[v][I]&&m.fillRect((I+d)*o,(v+d)*o,o,o);return h.toDataURL("image/png")}const wa=Cn();function Xo(){const i=new Uint8Array(16);if(typeof crypto<"u"&&crypto.getRandomValues)crypto.getRandomValues(i);else for(let o=0;o<16;o++)i[o]=Math.floor(Math.random()*256);return Array.from(i,o=>o.toString(16).padStart(2,"0")).join("")}function ka(){const i=localStorage.getItem("ts_merchantId");if(i)return i;const o=`TSM-${wa.substr(0,8).toUpperCase()}`;return localStorage.setItem("ts_merchantId",o),o}async function Wo(i){const o=JSON.stringify(i);if(typeof crypto<"u"&&crypto.subtle)try{const u=new TextEncoder().encode(o),p=await crypto.subtle.digest("SHA-256",u);return Array.from(new Uint8Array(p)).map(m=>m.toString(16).padStart(2,"0")).join("")}catch{}let d=0;for(let c=0;c<o.length;c++){const u=o.charCodeAt(c);d=(d<<5)-d+u,d=d&d}return Math.abs(d).toString(16).padStart(8,"0")}async function Yo(i){const o=ka(),d=Xo(),c=Date.now(),u=Ht(),p={version:"1.0",type:"SALE",merchantId:o,deviceId:wa,transactionId:i.receiptId||ge(),nonce:d,timestamp:c,hlc:u,amount:i.total,currency:"KES",paymentMethod:i.paymentMethod,itemCount:i.items?i.items.length:0,items:i.items?i.items.map(m=>({name:m.name,qty:m.quantity,price:m.price,subtotal:m.subtotal})):[],profileName:i.profileName,saleTime:i.saleTime,status:navigator.onLine?"confirmed":"pending_sync",offlineCreated:!navigator.onLine},h={merchantId:p.merchantId,transactionId:p.transactionId,nonce:p.nonce,amount:p.amount,timestamp:p.timestamp,deviceId:p.deviceId};return p.signature=await Wo(h),p}function Go(i){return[i.merchantId,i.transactionId?.slice(-8)||"",i.amount,i.paymentMethod?.charAt(0)||"c",i.itemCount||0,i.signature?.slice(0,8)||"",i.status==="confirmed"?1:0].join("|")}function Qo(){return ka()}async function Cr(i){const o=await Yo(i),d=Go(o);let c="";try{c=Vo(d,3,2)}catch(C){console.warn("[Receipt] QR generation failed, showing receipt without QR:",C.message)}const u=Qo(),p=new Date(i.saleTime||i.createdAt),h=p.toLocaleDateString("en-KE",{weekday:"short",year:"numeric",month:"short",day:"numeric"}),m=p.toLocaleTimeString("en-KE",{hour:"2-digit",minute:"2-digit"}),v={cash:"ðµ Cash",credit:"ð Credit",mpesa:"ð± M-Pesa",airtel:"ð± Airtel Money"},I=document.getElementById("modal-backdrop"),$=document.getElementById("modal");$.innerHTML=`
        <div class="modal-handle"></div>
        <div class="receipt-container" id="receipt-content">
            <div class="receipt-header">
                <div class="receipt-logo">DukaImara</div>
                <div class="receipt-sub">Sales Receipt</div>
                <div class="receipt-merchant">${u}</div>
            </div>
            <div class="receipt-divider">â â â â â â â â â â â â â â</div>
            <div class="receipt-info">
                <div class="receipt-row">
                    <span>Receipt #</span>
                    <span>${i.receiptId||"N/A"}</span>
                </div>
                <div class="receipt-row">
                    <span>Date</span>
                    <span>${h}</span>
                </div>
                <div class="receipt-row">
                    <span>Time</span>
                    <span>${m}</span>
                </div>
                <div class="receipt-row">
                    <span>Served by</span>
                    <span>${i.profileName||"Staff"}</span>
                </div>
                <div class="receipt-row">
                    <span>Payment</span>
                    <span>${v[i.paymentMethod]||i.paymentMethod}</span>
                </div>
            </div>
            <div class="receipt-divider">â â â â â â â â â â â â â â</div>
            <div class="receipt-items">
                ${i.items.map(C=>`
                    <div class="receipt-item">
                        <div class="receipt-item-name">${C.name}</div>
                        <div class="receipt-item-detail">
                            <span>${C.quantity} Ã KSh ${C.price.toLocaleString()}</span>
                            <span>KSh ${C.subtotal.toLocaleString()}</span>
                        </div>
                    </div>
                `).join("")}
            </div>
            <div class="receipt-divider">â â â â â â â â â â â â â â</div>
            <div class="receipt-total">
                <span>TOTAL</span>
                <span>KSh ${i.total.toLocaleString()}</span>
            </div>
            <div class="receipt-qr">
                ${c?`<img src="${c}" alt="Transaction QR" />`:`<div style="text-align:center;padding:8px;color:var(--text-tertiary);font-size:12px;">TX: ${o.transactionId}</div>`}
                <div class="receipt-qr-label">Scan to verify transaction</div>
            </div>
            <div class="receipt-footer">
                <div class="receipt-status ${o.status==="confirmed"?"confirmed":"pending"}">
                    ${o.status==="confirmed"?"â Verified":"â³ Pending Sync"}
                </div>
                <div class="receipt-sig">Sig: ${o.signature.substr(0,12)}...</div>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-ghost" id="receipt-close">Close</button>
            <button class="btn btn-primary" id="receipt-download">ð¥ Download</button>
        </div>
    `,I.classList.remove("hidden"),$.classList.remove("hidden"),document.getElementById("receipt-close").addEventListener("click",Ki),I.addEventListener("click",Ki),document.getElementById("receipt-download").addEventListener("click",()=>Jo(i.receiptId))}function Ki(){document.getElementById("modal-backdrop").classList.add("hidden"),document.getElementById("modal").classList.add("hidden")}function Jo(i){const o=document.getElementById("receipt-content");if(!o)return;const d=document.createElement("canvas"),c=2;d.width=o.offsetWidth*c,d.height=o.offsetHeight*c;const u=d.getContext("2d");u.scale(c,c);const p=getComputedStyle(document.documentElement),h=p.getPropertyValue("--bg-primary").trim()||"#f8fafc",m=p.getPropertyValue("--text-primary").trim()||"#0f172a",v=p.getPropertyValue("--accent-primary").trim()||"#0D9488";u.fillStyle=h,u.fillRect(0,0,d.width,d.height),u.font="14px Inter, sans-serif",u.textAlign="center",u.fillText(`Receipt #${i||"N/A"}`,d.width/(2*c),30);const A=`
        <!DOCTYPE html><html><head>
        <style>
            body { background: ${h}; color: ${m}; font-family: 'Inter', sans-serif;
                   max-width: 320px; margin: 0 auto; padding: 16px; }
            .receipt-header { text-align: center; margin-bottom: 12px; }
            .receipt-logo { font-size: 20px; font-weight: 800; color: ${v}; }
            .receipt-row { display: flex; justify-content: space-between; padding: 2px 0; font-size: 13px; }
            .receipt-total { display: flex; justify-content: space-between; font-size: 18px; font-weight: 700; padding: 8px 0; }
            .receipt-divider { text-align: center; color: #94a3b8; font-size: 11px; margin: 8px 0; }
            img { display: block; margin: 12px auto; }
        </style>
        </head><body>${o.innerHTML}</body></html>
    `,B=new Blob([A],{type:"text/html"}),V=URL.createObjectURL(B),N=document.createElement("a");N.href=V,N.download=`receipt-${i||"sale"}.html`,N.click(),URL.revokeObjectURL(V)}function Zo(i,o,d,c){const u=document.getElementById("modal-backdrop"),p=document.getElementById("modal"),h=i.reduce((v,I)=>v+I.subtotal,0);p.innerHTML=`
        <div class="modal-handle"></div>
        <h2>Checkout â KSh ${h.toLocaleString()}</h2>
        <div class="cart-summary-modal">
            <div class="cart-items" style="max-height: 120px; overflow-y: auto;">
                ${i.map(v=>`
                    <div class="cart-item">
                        <span style="font-size: 18px;">${v.emoji||"ð¦"}</span>
                        <div class="cart-item-info">
                            <div class="cart-item-name">${v.name}</div>
                            <div class="cart-item-price">KSh ${v.price} Ã ${v.quantity}</div>
                        </div>
                        <div class="cart-item-total">KSh ${v.subtotal.toLocaleString()}</div>
                    </div>
                `).join("")}
            </div>
            <div class="cart-total">
                <span>Total</span>
                <span>KSh ${h.toLocaleString()}</span>
            </div>
        </div>

        <div class="payment-methods" id="payment-methods">
            <div class="payment-method-label">Select Payment Method</div>
            <div class="payment-grid">
                <button class="payment-btn cash" data-method="cash">
                    <span class="pm-icon">ðµ</span>
                    <span class="pm-label">Cash</span>
                </button>
                <button class="payment-btn mpesa" data-method="mpesa">
                    <span class="pm-icon">ð±</span>
                    <span class="pm-label">M-Pesa</span>
                </button>
                <button class="payment-btn airtel" data-method="airtel">
                    <span class="pm-icon">ð²</span>
                    <span class="pm-label">Airtel Money</span>
                </button>
                <button class="payment-btn credit" data-method="credit">
                    <span class="pm-icon">ð</span>
                    <span class="pm-label">Credit</span>
                </button>
            </div>
        </div>

        <div id="payment-form" class="hidden"></div>

        <div class="modal-actions">
            <button class="btn btn-ghost" id="checkout-cancel">Cancel</button>
        </div>
    `,u.classList.remove("hidden"),p.classList.remove("hidden");const m=document.getElementById("payment-form");document.querySelectorAll(".payment-btn").forEach(v=>{v.addEventListener("click",()=>{const I=v.dataset.method;document.querySelectorAll(".payment-btn").forEach($=>$.classList.remove("selected")),v.classList.add("selected"),es(I,m,i,h,o,d,c)})}),document.getElementById("checkout-cancel").addEventListener("click",Ce),u.addEventListener("click",Ce)}function es(i,o,d,c,u,p,h){switch(o.classList.remove("hidden"),i){case"cash":o.innerHTML=`
                <div class="payment-confirm">
                    <div class="payment-confirm-icon cash-icon">ðµ</div>
                    <div class="payment-confirm-text">Cash Payment â KSh ${c.toLocaleString()}</div>
                    <button class="btn btn-success btn-lg btn-full" id="confirm-cash">Confirm Cash Payment</button>
                </div>
            `,document.getElementById("confirm-cash").addEventListener("click",async()=>{try{const m=Dr(d),v=await In(m,c,"cash",u,p);Ce(),W(`Sale â KSh ${c.toLocaleString()} â`,"success"),await Cr(v),h&&h()}catch(m){W(`Error: ${m.message}`,"error"),console.error("[Cash checkout]",m)}});break;case"mpesa":o.innerHTML=`
                <div class="mpesa-form">
                    <div class="payment-brand mpesa-brand">
                        <span class="brand-logo">M</span>-PESA
                    </div>
                    <div class="form-group">
                        <label>Customer's Phone Number</label>
                        <input type="tel" id="mpesa-phone" placeholder="07XX XXX XXX" maxlength="12" />
                    </div>
                    <button class="btn btn-lg btn-full mpesa-btn" id="send-stk">
                        ð² Send STK Push â KSh ${c.toLocaleString()}
                    </button>
                </div>
                <div id="stk-progress" class="hidden"></div>
            `,document.getElementById("send-stk").addEventListener("click",()=>{const m=document.getElementById("mpesa-phone").value.trim();if(!m||m.length<10){W("Enter a valid phone number","warning");return}Mi("mpesa",m,c,d,u,p,h)});break;case"airtel":o.innerHTML=`
                <div class="airtel-form">
                    <div class="payment-brand airtel-brand">
                        <span class="brand-logo">A</span>irtel Money
                    </div>
                    <div class="form-group">
                        <label>Customer's Phone Number</label>
                        <input type="tel" id="airtel-phone" placeholder="07XX XXX XXX" maxlength="12" />
                    </div>
                    <button class="btn btn-lg btn-full airtel-btn" id="send-airtel-stk">
                        ð² Send STK Push â KSh ${c.toLocaleString()}
                    </button>
                </div>
            `,document.getElementById("send-airtel-stk").addEventListener("click",()=>{const m=document.getElementById("airtel-phone").value.trim();if(!m||m.length<10){W("Enter a valid phone number","warning");return}Mi("airtel",m,c,d,u,p,h)});break;case"credit":o.innerHTML=`
                <div class="credit-checkout-form">
                    <div class="form-group">
                        <label>Customer Name</label>
                        <input type="text" id="credit-cust-name" placeholder="Customer name" />
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="credit-cust-phone" placeholder="07XX XXX XXX" maxlength="12" />
                    </div>
                    <button class="btn btn-lg btn-full" id="confirm-credit" style="background: var(--accent-secondary); color: white;">
                        ð Add to Customer Tab â KSh ${c.toLocaleString()}
                    </button>
                </div>
            `,document.getElementById("confirm-credit").addEventListener("click",async()=>{const m=document.getElementById("credit-cust-name").value.trim(),v=document.getElementById("credit-cust-phone").value.trim();if(!m){W("Enter customer name","warning");return}try{const I=Dr(d),$=await In(I,c,"credit",u,p);await Mr(m,v,c,u),Ce(),W(`Credit â KSh ${c.toLocaleString()} on ${m}'s tab`,"success"),await Cr($),h&&h()}catch(I){W(`Error: ${I.message}`,"error"),console.error("[Credit checkout]",I)}});break}}function Mi(i,o,d,c,u,p,h){const m=document.getElementById("payment-form"),v=i==="mpesa"?"M-PESA":"Airtel Money",I=i==="mpesa"?"mpesa":"airtel";m.innerHTML=`
        <div class="stk-simulation">
            <div class="stk-step active" id="stk-1">
                <div class="stk-loader ${I}"></div>
                <div class="stk-msg">Sending STK push to ${o}...</div>
            </div>
            <div class="stk-step hidden" id="stk-2">
                <div class="stk-loader ${I}"></div>
                <div class="stk-msg">Waiting for ${v} confirmation...</div>
                <div class="stk-sub">Customer should enter PIN on their phone</div>
            </div>
            <div class="stk-step hidden" id="stk-3">
                <div class="stk-success">â</div>
                <div class="stk-msg stk-done">Payment Confirmed!</div>
                <div class="stk-sub">KSh ${d.toLocaleString()} via ${v}</div>
            </div>
        </div>
    `,setTimeout(()=>{document.getElementById("stk-1")?.classList.add("hidden"),document.getElementById("stk-2")?.classList.remove("hidden")},1500),setTimeout(async()=>{document.getElementById("stk-2")?.classList.add("hidden"),document.getElementById("stk-3")?.classList.remove("hidden");const $=Dr(c),C=await In($,d,i,u,p);setTimeout(async()=>{Ce(),W(`${v} â KSh ${d.toLocaleString()} â`,"success"),await Cr(C),h&&h()},1200)},3500)}function Dr(i){return i.map(o=>({productId:o.productId,name:o.name,quantity:o.quantity,price:o.price,subtotal:o.subtotal}))}const ts={Food:["ð","ð¥","ð","ð½","ð«","ð","ð¥©","ð§","ð«","ð¥¬","ð","ð§","ð¥","ð¥","ð","ð¥­","ð"],Drinks:["ð¥","ð¥¤","ð§","â","ðµ","ð§","ð§","ðº","ð¥","ð«"],Snacks:["ðª","ð©","ð¿","ð§","ð¬","ð«","ð¥","ð°"],Household:["ð§¹","ð§´","ð§¼","ð§½","ðª£","ð§»","ð¡","ðª¥","ð§¯"],Electronics:["ð±","ð","ð","ð»","ð§","ðº","â","ð¦"],Clothing:["ð","ð","ð","ð","ð§¢","ð§£","ð§¤","ð"],Other:["ð¦","ð","ð","âï¸","ð","ð","ðª","ð·ï¸","ð§²","â½"]};function ji(i,o,d){const c=document.getElementById("modal-backdrop"),u=document.getElementById("modal"),p=!i,h=i||{name:"",price:"",stock:"",category:"General",emoji:"ð¦",lowStockThreshold:5,description:"",unit:"pcs",costPrice:"",sku:""},m=["General","Food","Drinks","Snacks","Household","Electronics","Clothing","Other"];u.innerHTML=`
        <div class="modal-handle"></div>
        <h2>${p?"Add Product":"Edit Product"}</h2>

        <div class="form-group">
            <label>Product Name</label>
            <input type="text" id="prod-name" value="${h.name}" placeholder="e.g. White Bread 400g" />
        </div>
        <div class="form-group">
            <label>Description</label>
            <textarea id="prod-desc" placeholder="Brief description..." rows="2" style="resize:none;">${h.description||""}</textarea>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Selling Price (KSh)</label>
                <input type="number" id="prod-price" value="${h.price}" placeholder="0" min="0" />
            </div>
            <div class="form-group">
                <label>Cost Price (KSh)</label>
                <input type="number" id="prod-cost" value="${h.costPrice||""}" placeholder="Optional" min="0" />
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Stock Qty</label>
                <input type="number" id="prod-stock" value="${h.stock}" placeholder="0" min="0" />
            </div>
            <div class="form-group">
                <label>Unit</label>
                <select id="prod-unit">
                    ${["pcs","kg","g","litre","ml","pack","box","tray","dozen","pair"].map($=>`<option value="${$}" ${$===(h.unit||"pcs")?"selected":""}>${$}</option>`).join("")}
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Category</label>
                <select id="prod-category">
                    ${m.map($=>`<option value="${$}" ${$===h.category?"selected":""}>${$}</option>`).join("")}
                </select>
            </div>
            <div class="form-group">
                <label>SKU / Barcode</label>
                <input type="text" id="prod-sku" value="${h.sku||""}" placeholder="Optional" />
            </div>
        </div>
        <div class="form-group">
            <label>Icon â Select or Search</label>
            <input type="search" id="emoji-search" placeholder="Search emojis..." class="emoji-search-input" />
            <div class="emoji-picker-grid" id="emoji-picker"></div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Low Stock Alert</label>
                <input type="number" id="prod-threshold" value="${h.lowStockThreshold||5}" min="1" />
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-ghost" id="prod-cancel">Cancel</button>
            ${p?"":'<button class="btn btn-danger" id="prod-delete">Delete</button>'}
            <button class="btn btn-primary" id="prod-save">${p?"Add Product":"Save Changes"}</button>
        </div>
    `,c.classList.remove("hidden"),u.classList.remove("hidden");let v=h.emoji;function I($=""){const C=document.getElementById("emoji-picker");let A="";for(const[B,V]of Object.entries(ts)){const N=$?V.filter(()=>!0):V;if(N.length!==0){A+=`<div class="emoji-cat-label">${B}</div><div class="emoji-cat-row">`;for(const Z of N)A+=`<button type="button" class="emoji-btn ${Z===v?"active":""}" data-emoji="${Z}">${Z}</button>`;A+="</div>"}}C.innerHTML=A,C.querySelectorAll(".emoji-btn").forEach(B=>{B.addEventListener("click",()=>{v=B.dataset.emoji,C.querySelectorAll(".emoji-btn").forEach(V=>V.classList.remove("active")),B.classList.add("active")})})}I(),document.getElementById("emoji-search").addEventListener("input",$=>{I($.target.value)}),document.getElementById("prod-save").addEventListener("click",()=>{const $=document.getElementById("prod-name").value.trim(),C=parseFloat(document.getElementById("prod-price").value),A=parseInt(document.getElementById("prod-stock").value);if(!$){W("Product name is required","warning");return}if(isNaN(C)||C<0){W("Enter a valid price (â¥ 0)","warning");return}if(isNaN(A)||A<0){W("Enter a valid stock (â¥ 0)","warning");return}const B=document.getElementById("prod-cost").value;if(B&&(isNaN(parseFloat(B))||parseFloat(B)<0)){W("Cost price must be â¥ 0","warning");return}const V={name:$,price:C,stock:A,category:document.getElementById("prod-category").value,emoji:v,lowStockThreshold:parseInt(document.getElementById("prod-threshold").value)||5,description:document.getElementById("prod-desc").value.trim(),unit:document.getElementById("prod-unit").value,costPrice:B?parseFloat(B):null,sku:document.getElementById("prod-sku").value.trim()};Ce(),o&&o(V,i?.id)}),p||document.getElementById("prod-delete").addEventListener("click",()=>{Ce(),d&&d(i.id)}),document.getElementById("prod-cancel").addEventListener("click",Ce),c.addEventListener("click",Ce)}function Ce(){document.getElementById("modal-backdrop").classList.add("hidden"),document.getElementById("modal").classList.add("hidden")}let ae=[];function Sa(i){const o=ae.find(d=>d.productId===i.id);if(o)o.quantity<i.stock?(o.quantity++,o.subtotal=o.quantity*o.price):W("Not enough stock!","warning");else{if(i.stock<=0){W("Out of stock!","warning");return}ae.push({productId:i.id,name:i.name,emoji:i.emoji,price:i.price,quantity:1,subtotal:i.price})}}async function _a(i,o,d){if(!rt(d,"canSell")){i.innerHTML=`<div class="page active"><div class="empty-state"><h3>Access Denied</h3><p>You don't have permission to make sales</p></div></div>`;return}const c=await xt(),u=["All",...new Set(c.map(v=>v.category||"General"))];i.innerHTML=`
        <div class="page active" id="page-sales">
            <div class="page-header">
                <div>
                    <h2>Sell</h2>
                    <div class="subtitle">Tap products to add to cart</div>
                </div>
            </div>

            <div class="search-bar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                </svg>
                <input type="search" id="sale-search" placeholder="Search products..." />
            </div>

            <div class="category-filters" id="sale-categories">
                ${u.map((v,I)=>`
                    <button class="cat-filter ${I===0?"active":""}" data-cat="${v}">${v}</button>
                `).join("")}
            </div>

            <div class="pos-products" id="product-grid"></div>

            <div class="cart-section ${ae.length===0?"hidden":""}" id="cart-section">
                <div class="cart-header">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <h3>Cart</h3>
                        <span class="cart-count" id="cart-count">${ae.length}</span>
                    </div>
                    <button class="cart-clear" id="cart-clear">Clear</button>
                </div>
                <div class="cart-items" id="cart-items"></div>
                <div class="cart-total">
                    <span>Total</span>
                    <span id="cart-total">KSh 0</span>
                </div>
                <div class="checkout-btns">
                    <button class="btn btn-success btn-lg" id="checkout-btn">ðµ Checkout</button>
                </div>
            </div>
        </div>
    `;let p="All";function h(v=""){const I=document.getElementById("product-grid");I.innerHTML="";let $=c;if(p!=="All"&&($=$.filter(C=>(C.category||"General")===p)),v){const C=v.toLowerCase();$=$.filter(A=>A.name.toLowerCase().includes(C))}if($.length===0){I.innerHTML=`
                <div class="empty-state" style="grid-column: 1/-1;">
                    <h3>No products found</h3>
                    <p>Try a different search or category</p>
                </div>
            `;return}$.forEach(C=>{I.appendChild(Bo(C,A=>{Sa(A),m(),W(`${A.name} added`,"success")}))})}function m(){const v=document.getElementById("cart-section"),I=document.getElementById("cart-items"),$=document.getElementById("cart-count"),C=document.getElementById("cart-total");if(ae.length===0){v.classList.add("hidden");return}v.classList.remove("hidden"),$.textContent=ae.reduce((A,B)=>A+B.quantity,0),I.innerHTML=ae.map((A,B)=>`
            <div class="cart-item">
                <span style="font-size: 18px;">${A.emoji||"ð¦"}</span>
                <div class="cart-item-info">
                    <div class="cart-item-name">${A.name}</div>
                    <div class="cart-item-price">KSh ${A.price.toLocaleString()}</div>
                </div>
                <div class="cart-item-qty">
                    <button data-action="dec" data-idx="${B}">â</button>
                    <span>${A.quantity}</span>
                    <button data-action="inc" data-idx="${B}">+</button>
                </div>
                <div class="cart-item-total">KSh ${A.subtotal.toLocaleString()}</div>
            </div>
        `).join(""),C.textContent=`KSh ${ae.reduce((A,B)=>A+B.subtotal,0).toLocaleString()}`,I.querySelectorAll("button").forEach(A=>{A.addEventListener("click",()=>{const B=parseInt(A.dataset.idx);if(A.dataset.action==="inc"){const V=c.find(N=>N.id===ae[B].productId);V&&ae[B].quantity<V.stock&&(ae[B].quantity++,ae[B].subtotal=ae[B].quantity*ae[B].price)}else ae[B].quantity--,ae[B].quantity<=0?ae.splice(B,1):ae[B].subtotal=ae[B].quantity*ae[B].price;m()})})}document.getElementById("sale-search").addEventListener("input",v=>{h(v.target.value)}),document.getElementById("sale-categories").addEventListener("click",v=>{const I=v.target.closest(".cat-filter");I&&(p=I.dataset.cat,document.querySelectorAll("#sale-categories .cat-filter").forEach($=>$.classList.remove("active")),I.classList.add("active"),h(document.getElementById("sale-search").value))}),document.getElementById("cart-clear").addEventListener("click",()=>{ae=[],m()}),document.getElementById("checkout-btn").addEventListener("click",()=>{ae.length!==0&&Zo(ae,o,d?.name||"Staff",()=>{ae=[],_a(i,o,d)})}),h(),m()}async function Pn(i,o,d){const c=rt(d,"canAddStock"),u=await xt(),p=["All",...new Set(u.map($=>$.category||"General"))],h=u.reduce(($,C)=>$+C.price*C.stock,0),m=u.filter($=>$.stock<=($.lowStockThreshold||5)).length;u.reduce(($,C)=>$+(C.costPrice||0)*C.stock,0),i.innerHTML=`
        <div class="page active" id="page-inventory">
            <div class="page-header">
                <div>
                    <h2>Stock</h2>
                    <div class="subtitle">${u.length} products Â· KSh ${h.toLocaleString()} value</div>
                </div>
                ${c?'<button class="btn btn-primary" id="add-product-btn">+ Add</button>':""}
            </div>

            ${m>0?`
                <div class="low-stock-banner">
                    â ï¸ <strong>${m}</strong> product${m>1?"s":""} running low
                </div>
            `:""}

            <div class="search-bar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                </svg>
                <input type="search" id="inv-search" placeholder="Search products..." />
            </div>

            <div class="category-filters" id="inv-categories">
                ${p.map(($,C)=>`
                    <button class="cat-filter ${C===0?"active":""}" data-cat="${$}">${$}</button>
                `).join("")}
            </div>

            <div class="inventory-list" id="inv-list"></div>
        </div>
    `;let v="All";function I($=""){const C=document.getElementById("inv-list");let A=u;if(v!=="All"&&(A=A.filter(B=>(B.category||"General")===v)),$){const B=$.toLowerCase();A=A.filter(V=>V.name.toLowerCase().includes(B)||V.sku&&V.sku.toLowerCase().includes(B))}if(A.length===0){C.innerHTML=`
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                    </svg>
                    <h3>No products</h3>
                    <p>Tap "+ Add" to add your first product</p>
                </div>
            `;return}C.innerHTML="",A.forEach(B=>{C.appendChild(Co(B,V=>{if(!c){W("You don't have permission to edit stock","warning");return}ji(V,async(N,Z)=>{await Kr(Z,N),W(`${N.name} updated`,"success"),Pn(i,o,d)},async N=>{await Yi(N),W("Product deleted","info"),Pn(i,o,d)})}))})}document.getElementById("inv-search").addEventListener("input",$=>{I($.target.value)}),document.getElementById("inv-categories").addEventListener("click",$=>{const C=$.target.closest(".cat-filter");C&&(v=C.dataset.cat,document.querySelectorAll("#inv-categories .cat-filter").forEach(A=>A.classList.remove("active")),C.classList.add("active"),I(document.getElementById("inv-search").value))}),c&&document.getElementById("add-product-btn")?.addEventListener("click",()=>{ji(null,async $=>{await Wi($),W(`${$.name} added to inventory`,"success"),Pn(i,o,d)})}),I()}let kt="credits";async function Et(i,o,d){const c=await Vt(),u=await jr();c.reduce((p,h)=>p+h.amount,0),u.reduce((p,h)=>p+h.balance,0),i.innerHTML=`
        <div class="page active" id="page-credits">
            <div class="page-header">
                <div>
                    <h2>Accounts</h2>
                    <div class="subtitle">Credits & Deposits</div>
                </div>
            </div>

            <div class="tab-bar">
                <button class="tab-btn ${kt==="credits"?"active":""}" data-tab="credits">
                    ð Credits <span class="tab-badge">${c.length}</span>
                </button>
                <button class="tab-btn ${kt==="debits"?"active":""}" data-tab="debits">
                    ð° Deposits <span class="tab-badge">${u.length}</span>
                </button>
            </div>

            <div id="tab-content"></div>
        </div>
    `,i.querySelectorAll(".tab-btn").forEach(p=>{p.addEventListener("click",()=>{kt=p.dataset.tab,i.querySelectorAll(".tab-btn").forEach(h=>h.classList.toggle("active",h.dataset.tab===kt)),qi(i,o,d)})}),qi(i,o,d)}async function qi(i,o,d){const c=document.getElementById("tab-content");kt==="credits"?await ns(c,o,d,i):await rs(c,o,d,i)}async function ns(i,o,d,c){const u=await Vt(),p=u.reduce((v,I)=>v+I.amount,0);i.innerHTML=`
        <div class="credit-controls">
            <div class="search-bar" style="margin-bottom: 8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                </svg>
                <input type="search" id="credit-search" placeholder="Search by name or phone..." />
            </div>
            <div class="credit-filter-row">
                <select id="credit-amount-filter">
                    <option value="">All amounts</option>
                    <option value="0-500">KSh 0 - 500</option>
                    <option value="500-1000">KSh 500 - 1,000</option>
                    <option value="1000-5000">KSh 1,000 - 5,000</option>
                    <option value="5000+">KSh 5,000+</option>
                </select>
                <button class="btn btn-primary" id="add-credit-btn">+ Add</button>
            </div>
        </div>

        ${u.length>0?`
            <div class="stats-grid" style="margin-bottom: var(--space-md);">
                <div class="stat-card">
                    <div class="stat-label">Total Owed</div>
                    <div class="stat-value" style="color: var(--accent-secondary);">KSh ${p.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Customers</div>
                    <div class="stat-value">${u.length}</div>
                </div>
            </div>
        `:""}

        <div class="credit-list" id="credit-list"></div>
    `;function h(v="",I=null,$=null){const C=document.getElementById("credit-list");let A=u;if(v){const B=v.toLowerCase();A=A.filter(V=>V.customerName.toLowerCase().includes(B)||V.phone&&V.phone.includes(B))}if(I!==null&&(A=A.filter(B=>B.amount>=I)),$!==null&&(A=A.filter(B=>B.amount<=$)),A.length===0){C.innerHTML=`
                <div class="empty-state">
                    <h3>No matching records</h3>
                    <p>Try a different search or filter</p>
                </div>
            `;return}C.innerHTML=A.map(B=>{const V=B.trustScore||50,N=V>=70?"high":V>=40?"medium":"low",Z=["#0d9488","#14b8a6","#f97316","#fb923c","#ef4444","#3b82f6"],_e=Z[B.customerName.charCodeAt(0)%Z.length],ot=B.amount>0&&B.createdAt<Date.now()-7*864e5,Pt=(B.payments||[]).reduce((Xt,ke)=>Xt+ke.amount,0),Fe=B.originalAmount||B.amount+Pt;return`
                <div class="credit-item" data-id="${B.id}">
                    <div class="credit-avatar" style="background: ${_e}">
                        ${B.customerName.charAt(0).toUpperCase()}
                    </div>
                    <div class="credit-info">
                        <div class="credit-name">${B.customerName}</div>
                        <div class="credit-meta">
                            ${B.phone?`ð ${B.phone} Â· `:""}
                            ${B.payments?.length||0} payment${(B.payments?.length||0)!==1?"s":""}
                            ${ot?' Â· <span style="color:var(--danger)">Overdue</span>':""}
                        </div>
                        <div class="credit-history-mini">
                            Borrowed: KSh ${Fe.toLocaleString()} Â· Paid: KSh ${Pt.toLocaleString()}
                        </div>
                        <div class="trust-bar">
                            <div class="trust-fill ${N}" style="width: ${V}%"></div>
                        </div>
                    </div>
                    <div class="credit-amount ${B.amount<=0?"paid":""}">
                        <div class="amount-value">KSh ${B.amount.toLocaleString()}</div>
                        <div class="amount-label">${B.amount<=0?"Paid":"owes"}</div>
                    </div>
                </div>
            `}).join("")}h(),document.getElementById("credit-search")?.addEventListener("input",v=>{const I=document.getElementById("credit-amount-filter").value,{min:$,max:C}=Ri(I);h(v.target.value,$,C)}),document.getElementById("credit-amount-filter")?.addEventListener("change",v=>{const I=document.getElementById("credit-search").value,{min:$,max:C}=Ri(v.target.value);h(I,$,C)}),i.querySelectorAll(".credit-item").forEach(v=>{v.addEventListener("click",()=>{const I=u.find($=>$.id===v.dataset.id);I&&Ni(I,o,d,c)})});const m=()=>{document.querySelectorAll(".credit-item").forEach(v=>{v.addEventListener("click",()=>{const I=u.find($=>$.id===v.dataset.id);I&&Ni(I,o,d,c)})})};document.getElementById("credit-search")?.addEventListener("input",()=>setTimeout(m,50)),document.getElementById("credit-amount-filter")?.addEventListener("change",()=>setTimeout(m,50)),document.getElementById("add-credit-btn")?.addEventListener("click",()=>{is(o,d,c)})}function Ri(i){return i?i==="0-500"?{min:0,max:500}:i==="500-1000"?{min:500,max:1e3}:i==="1000-5000"?{min:1e3,max:5e3}:i==="5000+"?{min:5e3,max:null}:{min:null,max:null}:{min:null,max:null}}async function rs(i,o,d,c){const u=await jr(),p=u.reduce((h,m)=>h+m.balance,0);i.innerHTML=`
        <div style="display: flex; justify-content: flex-end; margin-bottom: var(--space-md);">
            <button class="btn btn-primary" id="add-debit-btn">+ New Deposit</button>
        </div>

        ${u.length>0?`
            <div class="stats-grid" style="margin-bottom: var(--space-md);">
                <div class="stat-card">
                    <div class="stat-label">Total Deposits Held</div>
                    <div class="stat-value" style="color: var(--success);">KSh ${p.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Accounts</div>
                    <div class="stat-value">${u.length}</div>
                </div>
            </div>
        `:""}

        <div class="credit-list" id="debit-list">
            ${u.length===0?`
                <div class="empty-state">
                    <h3>No deposit accounts</h3>
                    <p>Create a deposit account for customers who pre-pay</p>
                </div>
            `:u.map(h=>{const m=h.initialDeposit>0?Math.round(h.balance/h.initialDeposit*100):0,v=m<20;return`
                    <div class="credit-item debit-item" data-id="${h.id}">
                        <div class="credit-avatar" style="background: var(--success)">
                            ${h.customerName.charAt(0).toUpperCase()}
                        </div>
                        <div class="credit-info">
                            <div class="credit-name">${h.customerName}</div>
                            <div class="credit-meta">
                                ${h.phone?`ð ${h.phone} Â· `:""}
                                ${h.transactions?.length||0} transaction${(h.transactions?.length||0)!==1?"s":""}
                                Â· Started ${new Date(h.createdAt).toLocaleDateString()}
                            </div>
                            <div class="trust-bar">
                                <div class="trust-fill ${v?"low":"high"}" style="width: ${m}%"></div>
                            </div>
                            ${v?'<div style="font-size: 11px; color: var(--danger); margin-top: 2px;">â  Low balance</div>':""}
                        </div>
                        <div class="credit-amount paid">
                            <div class="amount-value">KSh ${h.balance.toLocaleString()}</div>
                            <div class="amount-label">balance</div>
                        </div>
                    </div>
                `}).join("")}
        </div>
    `,i.querySelectorAll(".debit-item").forEach(h=>{h.addEventListener("click",()=>{const m=u.find(v=>v.id===h.dataset.id);m&&as(m,o,d,c)})}),document.getElementById("add-debit-btn")?.addEventListener("click",()=>{os(o,d,c)})}function Ni(i,o,d,c){const u=document.getElementById("modal-backdrop"),p=document.getElementById("modal"),h=(i.payments||[]).reduce((v,I)=>v+I.amount,0),m=i.originalAmount||i.amount+h;p.innerHTML=`
        <div class="modal-handle"></div>
        <h2>${i.customerName}</h2>
        ${i.phone?`<div style="font-size: var(--font-size-sm); color: var(--text-muted); margin-bottom: 8px;">ð ${i.phone}</div>`:""}
        <div style="margin-bottom: var(--space-md);">
            <div style="font-size: var(--font-size-xl); font-weight: 700; color: var(--accent-secondary);">
                KSh ${i.amount.toLocaleString()}
            </div>
            <div style="font-size: var(--font-size-xs); color: var(--text-muted);">Outstanding balance</div>
            <div style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-top: 4px;">
                Total borrowed: KSh ${m.toLocaleString()} Â· Total paid: KSh ${h.toLocaleString()}
            </div>
        </div>

        ${i.payments&&i.payments.length>0?`
            <div class="section-header"><h3>Payment History</h3></div>
            <div style="margin-bottom: var(--space-md); max-height: 150px; overflow-y: auto;">
                ${i.payments.map(v=>`
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-light); font-size: var(--font-size-sm);">
                        <span style="color: var(--text-muted);">${new Date(v.date).toLocaleDateString()} ${new Date(v.date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</span>
                        <span style="color: var(--success); font-weight: 600;">KSh ${v.amount.toLocaleString()}</span>
                    </div>
                `).join("")}
            </div>
        `:""}

        ${i.amount>0?`
            <div class="form-group">
                <label>Record Payment (max: KSh ${i.amount.toLocaleString()})</label>
                <input type="number" id="payment-amount" placeholder="Amount paid" min="1" max="${i.amount}" />
            </div>
            <div class="modal-actions">
                <button class="btn btn-ghost" id="pay-cancel">Cancel</button>
                <button class="btn btn-success" id="pay-record">Record Payment</button>
            </div>
        `:`
            <div class="modal-actions">
                <button class="btn btn-ghost" id="pay-cancel">Close</button>
            </div>
        `}
    `,u.classList.remove("hidden"),p.classList.remove("hidden"),i.amount>0&&document.getElementById("pay-record").addEventListener("click",async()=>{const v=parseFloat(document.getElementById("payment-amount").value);if(!v||v<=0){W("Enter a valid amount (> 0)","warning");return}if(v>i.amount){W(`Payment cannot exceed KSh ${i.amount.toLocaleString()}`,"warning");return}try{await Ji(i.id,v),u.classList.add("hidden"),p.classList.add("hidden"),W(`Payment of KSh ${v.toLocaleString()} recorded â`,"success"),Et(c,o,d)}catch(I){W(I.message,"error")}}),document.getElementById("pay-cancel").addEventListener("click",()=>{u.classList.add("hidden"),p.classList.add("hidden")}),u.addEventListener("click",()=>{u.classList.add("hidden"),p.classList.add("hidden")})}function is(i,o,d){const c=document.getElementById("modal-backdrop"),u=document.getElementById("modal");u.innerHTML=`
        <div class="modal-handle"></div>
        <h2>Add Customer Tab</h2>
        <div class="form-group">
            <label>Customer Name</label>
            <input type="text" id="credit-name" placeholder="Customer name" />
        </div>
        <div class="form-group">
            <label>Phone Number (unique identifier)</label>
            <input type="tel" id="credit-phone" placeholder="07XX XXX XXX" maxlength="12" />
        </div>
        <div class="form-group">
            <label>Amount Owed (KSh)</label>
            <input type="number" id="credit-amount" placeholder="0" min="1" />
        </div>
        <div id="existing-customer-msg" class="hidden" style="padding: 8px; background: var(--accent-primary); background: rgba(13,148,136,0.15); border-radius: 8px; font-size: 12px; color: var(--accent-primary); margin-bottom: 12px;">
            â¹ï¸ This phone already has a tab â amount will be added to existing balance
        </div>
        <div class="modal-actions">
            <button class="btn btn-ghost" id="credit-cancel">Cancel</button>
            <button class="btn btn-primary" id="credit-save">Add Tab</button>
        </div>
    `,c.classList.remove("hidden"),u.classList.remove("hidden");const p=document.getElementById("credit-phone"),h=document.getElementById("existing-customer-msg");p.addEventListener("input",async()=>{const m=p.value.trim();if(m.length>=10){const{findCreditByPhone:v}=await wt(async()=>{const{findCreditByPhone:$}=await Promise.resolve().then(()=>oa);return{findCreditByPhone:$}},void 0),I=await v(m);I?(h.classList.remove("hidden"),h.textContent=`â¹ï¸ ${I.customerName} already has a tab (KSh ${I.amount}) â amount will be added`,document.getElementById("credit-name").value=I.customerName):h.classList.add("hidden")}else h.classList.add("hidden")}),document.getElementById("credit-save").addEventListener("click",async()=>{const m=document.getElementById("credit-name").value.trim(),v=document.getElementById("credit-phone").value.trim(),I=parseFloat(document.getElementById("credit-amount").value);if(!m){W("Enter customer name","warning");return}if(!I||I<=0){W("Enter a valid amount (> 0)","warning");return}try{await Mr(m,v,I,i),c.classList.add("hidden"),u.classList.add("hidden"),W(`${m}'s tab updated â KSh ${I.toLocaleString()}`,"success"),Et(d,i,o)}catch($){W($.message,"error")}}),document.getElementById("credit-cancel").addEventListener("click",()=>{c.classList.add("hidden"),u.classList.add("hidden")}),c.addEventListener("click",()=>{c.classList.add("hidden"),u.classList.add("hidden")})}function as(i,o,d,c){const u=document.getElementById("modal-backdrop"),p=document.getElementById("modal"),h=i.initialDeposit>0?Math.round(i.balance/i.initialDeposit*100):0;p.innerHTML=`
        <div class="modal-handle"></div>
        <h2>${i.customerName}</h2>
        ${i.phone?`<div style="font-size: var(--font-size-sm); color: var(--text-muted); margin-bottom: 8px;">ð ${i.phone}</div>`:""}
        <div style="margin-bottom: var(--space-md);">
            <div style="font-size: var(--font-size-xl); font-weight: 700; color: var(--success);">
                KSh ${i.balance.toLocaleString()}
            </div>
            <div style="font-size: var(--font-size-xs); color: var(--text-muted);">
                Remaining balance (${h}% of KSh ${i.initialDeposit.toLocaleString()})
            </div>
        </div>

        <div class="section-header"><h3>Transaction History</h3></div>
        <div style="margin-bottom: var(--space-md); max-height: 180px; overflow-y: auto;">
            ${(i.transactions||[]).map(m=>`
                <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-light); font-size: var(--font-size-sm);">
                    <div>
                        <div style="font-weight: 500;">${m.description}</div>
                        <div style="font-size: 11px; color: var(--text-muted);">${new Date(m.date).toLocaleString()}</div>
                    </div>
                    <span style="color: ${m.type==="deposit"?"var(--success)":"var(--accent-secondary)"}; font-weight: 600;">
                        ${m.type==="deposit"?"+":"-"}KSh ${m.amount.toLocaleString()}
                    </span>
                </div>
            `).join("")}
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Deduct Purchase</label>
                <input type="number" id="debit-purchase" placeholder="Amount" min="1" max="${i.balance}" />
            </div>
            <div class="form-group">
                <label>Top Up</label>
                <input type="number" id="debit-topup" placeholder="Amount" min="1" />
            </div>
        </div>
        <div class="form-group">
            <label>Description</label>
            <input type="text" id="debit-desc" placeholder="What was purchased?" />
        </div>
        <div class="modal-actions">
            <button class="btn btn-ghost" id="debit-cancel">Cancel</button>
            <button class="btn btn-success" id="debit-topup-btn">+ Top Up</button>
            <button class="btn btn-primary" id="debit-purchase-btn">- Deduct</button>
        </div>
    `,u.classList.remove("hidden"),p.classList.remove("hidden"),document.getElementById("debit-purchase-btn").addEventListener("click",async()=>{const m=parseFloat(document.getElementById("debit-purchase").value),v=document.getElementById("debit-desc").value.trim()||"Purchase";if(!m||m<=0){W("Enter a valid amount","warning");return}try{await ea(i.id,m,v),u.classList.add("hidden"),p.classList.add("hidden"),W(`KSh ${m.toLocaleString()} deducted â`,"success"),Et(c,o,d)}catch(I){W(I.message,"error")}}),document.getElementById("debit-topup-btn").addEventListener("click",async()=>{const m=parseFloat(document.getElementById("debit-topup").value);if(!m||m<=0){W("Enter a valid amount","warning");return}try{await ta(i.id,m),u.classList.add("hidden"),p.classList.add("hidden"),W(`KSh ${m.toLocaleString()} added â`,"success"),Et(c,o,d)}catch(v){W(v.message,"error")}}),document.getElementById("debit-cancel").addEventListener("click",()=>{u.classList.add("hidden"),p.classList.add("hidden")}),u.addEventListener("click",()=>{u.classList.add("hidden"),p.classList.add("hidden")})}function os(i,o,d){const c=document.getElementById("modal-backdrop"),u=document.getElementById("modal");u.innerHTML=`
        <div class="modal-handle"></div>
        <h2>New Deposit Account</h2>
        <div class="form-group">
            <label>Customer Name</label>
            <input type="text" id="debit-name" placeholder="Customer name" />
        </div>
        <div class="form-group">
            <label>Phone Number</label>
            <input type="tel" id="debit-phone" placeholder="07XX XXX XXX" maxlength="12" />
        </div>
        <div class="form-group">
            <label>Initial Deposit (KSh)</label>
            <input type="number" id="debit-amount" placeholder="0" min="1" />
        </div>
        <div class="modal-actions">
            <button class="btn btn-ghost" id="debit-cancel">Cancel</button>
            <button class="btn btn-success" id="debit-save">Create Account</button>
        </div>
    `,c.classList.remove("hidden"),u.classList.remove("hidden"),document.getElementById("debit-save").addEventListener("click",async()=>{const p=document.getElementById("debit-name").value.trim(),h=document.getElementById("debit-phone").value.trim(),m=parseFloat(document.getElementById("debit-amount").value);if(!p){W("Enter customer name","warning");return}if(!m||m<=0){W("Enter a valid deposit amount","warning");return}try{await Zi(p,h,m),c.classList.add("hidden"),u.classList.add("hidden"),W(`${p}'s deposit account â KSh ${m.toLocaleString()} â`,"success"),kt="debits",Et(d,i,o)}catch(v){W(v.message,"error")}}),document.getElementById("debit-cancel").addEventListener("click",()=>{c.classList.add("hidden"),u.classList.add("hidden")}),c.addEventListener("click",()=>{c.classList.add("hidden"),u.classList.add("hidden")})}async function Tn(i,o,d,{onLock:c}){const p=(localStorage.getItem("ts_theme")||"dark")==="dark",h=await ra(20);i.innerHTML=`
        <div class="page active" id="page-settings">
            <div class="page-header">
                <div>
                    <h2>Settings</h2>
                    <div class="subtitle">Preferences & Tools</div>
                </div>
            </div>

            <div class="settings-list">
                <div class="settings-item" id="toggle-theme">
                    <div class="settings-icon" style="background: var(--accent-primary); background: rgba(13,148,136,0.15);">
                        ${p?"ð":"âï¸"}
                    </div>
                    <div class="settings-info">
                        <div class="settings-label">Theme</div>
                        <div class="settings-desc">${p?"Dark Mode":"Light Mode"}</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="theme-switch" ${p?"":"checked"} />
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="settings-item" id="load-demo-data">
                    <div class="settings-icon" style="background: rgba(249,115,22,0.15);">ð¦</div>
                    <div class="settings-info">
                        <div class="settings-label">Load Demo Data</div>
                        <div class="settings-desc">Add sample products and customers</div>
                    </div>
                    <span class="settings-arrow">âº</span>
                </div>

                <div class="settings-item" id="view-reports">
                    <div class="settings-icon" style="background: rgba(59,130,246,0.15);">ð</div>
                    <div class="settings-info">
                        <div class="settings-label">Sales Reports</div>
                        <div class="settings-desc">Detailed sales analytics</div>
                    </div>
                    <span class="settings-arrow">âº</span>
                </div>

                <div class="settings-item" id="settings-lock">
                    <div class="settings-icon" style="background: rgba(239,68,68,0.15);">ð</div>
                    <div class="settings-info">
                        <div class="settings-label">Lock App</div>
                        <div class="settings-desc">Return to lock screen</div>
                    </div>
                    <span class="settings-arrow">âº</span>
                </div>
            </div>

            ${h.length>0?`
                <div class="section-header" style="margin-top: var(--space-lg);">
                    <h3>Sync Activity</h3>
                </div>
                <div class="sync-log">
                    ${h.map(m=>`
                        <div class="sync-log-item">
                            <span class="sync-log-time">${new Date(m.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</span>
                            <span class="sync-log-msg">${m.action}</span>
                            <span class="sync-log-status">${m.details||""}</span>
                        </div>
                    `).join("")}
                </div>
            `:""}
        </div>
    `,document.getElementById("theme-switch").addEventListener("change",m=>{const v=m.target.checked?"light":"dark";localStorage.setItem("ts_theme",v),document.documentElement.setAttribute("data-theme",v),Tn(i,o,d,{onLock:c})}),document.getElementById("load-demo-data").addEventListener("click",async()=>{await ss(),W("Demo data loaded! ð","success"),Tn(i,o,d,{onLock:c})}),document.getElementById("view-reports").addEventListener("click",()=>{location.hash="#reports"}),document.getElementById("settings-lock").addEventListener("click",c)}async function ss(){const i=Ht(),o=[{name:"White Bread 400g",price:60,stock:48,category:"Food",emoji:"ð",unit:"pcs",costPrice:45,description:"Premium white bread, soft and fresh",lowStockThreshold:10},{name:"Fresh Milk 500ml",price:75,stock:30,category:"Drinks",emoji:"ð¥",unit:"pcs",costPrice:55,description:"Pasteurized fresh milk",lowStockThreshold:8},{name:"Farm Eggs (Tray)",price:450,stock:15,category:"Food",emoji:"ð¥",unit:"tray",costPrice:380,description:"Farm fresh eggs, 30 per tray",lowStockThreshold:3},{name:"Maize Flour 2kg",price:180,stock:40,category:"Food",emoji:"ð½",unit:"pcs",costPrice:150,description:"Fine maize flour for ugali",lowStockThreshold:8},{name:"Cooking Oil 1L",price:320,stock:22,category:"Food",emoji:"ð«",unit:"litre",costPrice:280,description:"Pure vegetable cooking oil",lowStockThreshold:5},{name:"Rice 2kg",price:280,stock:25,category:"Food",emoji:"ð",unit:"pcs",costPrice:230,description:"Pishori long-grain rice",lowStockThreshold:5},{name:"Sugar 1kg",price:160,stock:35,category:"Food",emoji:"ð§",unit:"kg",costPrice:130,description:"White refined sugar",lowStockThreshold:8},{name:"Washing Soap",price:45,stock:60,category:"Household",emoji:"ð§¼",unit:"pcs",costPrice:30,description:"Multipurpose bar soap",lowStockThreshold:15},{name:"Phone Charger",price:350,stock:10,category:"Electronics",emoji:"ð",unit:"pcs",costPrice:200,description:"Fast charging USB cable",lowStockThreshold:3},{name:"Soda 500ml",price:80,stock:50,category:"Drinks",emoji:"ð¥¤",unit:"pcs",costPrice:55,description:"Assorted soft drinks",lowStockThreshold:10},{name:"Bread Spread",price:120,stock:18,category:"Food",emoji:"ð§",unit:"pcs",costPrice:90,description:"Butter spread 250g",lowStockThreshold:4},{name:"Tea Leaves 100g",price:85,stock:35,category:"Drinks",emoji:"ðµ",unit:"pcs",costPrice:60,description:"Kenya highland tea",lowStockThreshold:8}];for(const d of o)await Y.products.filter(u=>u.name===d.name&&!u._tombstone).first()||await Y.products.add({id:ge(),...d,_hlc:i,_tombstone:!1,_lastModified:Date.now(),createdAt:Date.now()})}const cs=Object.freeze(Object.defineProperty({__proto__:null,renderSettings:Tn},Symbol.toStringTag,{value:"Module"}));async function ls(i,o,d){const c=await Dn(),u=new Date,p=new Date(u);p.setHours(0,0,0,0);const h=new Date(u);h.setDate(u.getDate()-u.getDay()),h.setHours(0,0,0,0);const m=new Date(u.getFullYear(),u.getMonth(),1);let v=p.getTime(),I=null,$="",C="";async function A(){const B=await aa(v,I,$||null,C||null),V={cash:"ðµ Cash",credit:"ð Credit",mpesa:"ð± M-Pesa",airtel:"ð² Airtel"};i.innerHTML=`
            <div class="page active" id="page-reports">
                <div class="page-header">
                    <div>
                        <h2>Sales Report</h2>
                        <div class="subtitle">${B.totalSales} sales Â· KSh ${B.totalRevenue.toLocaleString()}</div>
                    </div>
                    <button class="btn btn-ghost" id="export-csv">ð¥ Export</button>
                </div>

                <div class="report-filters">
                    <select id="rpt-date-range">
                        <option value="today" selected>Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="all">All Time</option>
                    </select>
                    <select id="rpt-method">
                        <option value="">All Methods</option>
                        <option value="cash">Cash</option>
                        <option value="mpesa">M-Pesa</option>
                        <option value="airtel">Airtel</option>
                        <option value="credit">Credit</option>
                    </select>
                    <select id="rpt-profile">
                        <option value="">All Staff</option>
                        ${c.map(N=>`<option value="${N.id}">${N.name}</option>`).join("")}
                    </select>
                </div>

                <div class="stats-grid" style="margin-bottom: var(--space-md);">
                    <div class="stat-card revenue-card">
                        <div class="stat-label">Revenue</div>
                        <div class="stat-value">KSh ${B.totalRevenue.toLocaleString()}</div>
                        <div class="stat-sub">${B.totalSales} sales Â· ${B.totalItems} items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Sale</div>
                        <div class="stat-value">KSh ${Math.round(B.avgSaleSize).toLocaleString()}</div>
                    </div>
                </div>

                ${Object.keys(B.byMethod).length>0?`
                    <div class="section-header"><h3>By Payment Method</h3></div>
                    <div class="report-method-grid">
                        ${Object.entries(B.byMethod).map(([N,Z])=>`
                            <div class="report-method-card">
                                <div class="report-method-icon">${V[N]?.split(" ")[0]||"ð°"}</div>
                                <div class="report-method-info">
                                    <div class="report-method-name">${V[N]||N}</div>
                                    <div class="report-method-value">KSh ${Z.total.toLocaleString()} Â· ${Z.count} sales</div>
                                </div>
                            </div>
                        `).join("")}
                    </div>
                `:""}

                ${B.topProducts.length>0?`
                    <div class="section-header" style="margin-top: var(--space-md);"><h3>Top Products</h3></div>
                    <div class="report-top-products">
                        ${B.topProducts.slice(0,5).map((N,Z)=>`
                            <div class="report-product-row">
                                <span class="report-rank">#${Z+1}</span>
                                <div class="report-product-info">
                                    <div class="report-product-name">${N.name}</div>
                                    <div class="report-product-meta">${N.quantity} sold</div>
                                </div>
                                <span class="report-product-revenue">KSh ${N.revenue.toLocaleString()}</span>
                            </div>
                        `).join("")}
                    </div>
                `:""}

                <div class="section-header" style="margin-top: var(--space-md);"><h3>Sales Detail</h3></div>
                <div class="report-table-wrapper">
                    <div class="report-table">
                        ${B.sales.length===0?`
                            <div class="empty-state"><h3>No sales in this period</h3></div>
                        `:B.sales.map(N=>`
                            <div class="report-sale-row">
                                <div class="report-sale-main">
                                    <div class="report-sale-who">${N.profileName||"Unknown"}</div>
                                    <div class="report-sale-what">${N.items.map(Z=>`${Z.name} Ã${Z.quantity}`).join(", ")}</div>
                                    <div class="report-sale-when">${new Date(N.saleTime||N.createdAt).toLocaleString("en-KE",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}</div>
                                </div>
                                <div class="report-sale-right">
                                    <div class="report-sale-amount">KSh ${N.total.toLocaleString()}</div>
                                    <div class="report-sale-items">${N.items.reduce((Z,_e)=>Z+_e.quantity,0)} items</div>
                                    <div class="report-sale-method">${V[N.paymentMethod]||N.paymentMethod}</div>
                                </div>
                            </div>
                        `).join("")}
                    </div>
                </div>
            </div>
        `,document.getElementById("rpt-date-range").addEventListener("change",N=>{switch(N.target.value){case"today":v=p.getTime(),I=null;break;case"week":v=h.getTime(),I=null;break;case"month":v=m.getTime(),I=null;break;case"all":v=null,I=null;break}A()}),document.getElementById("rpt-method").addEventListener("change",N=>{$=N.target.value,A()}),document.getElementById("rpt-profile").addEventListener("change",N=>{C=N.target.value,A()}),document.getElementById("export-csv").addEventListener("click",()=>{us(B)})}A()}function us(i){const o=["Receipt #","Date","Time","Staff","Items","Qty","Amount","Payment Method"],d=i.sales.map(m=>{const v=new Date(m.saleTime||m.createdAt);return[m.receiptId||"",v.toLocaleDateString(),v.toLocaleTimeString(),m.profileName||"",m.items.map(I=>I.name).join("; "),m.items.reduce((I,$)=>I+$.quantity,0),m.total,m.paymentMethod].join(",")}),c=[o.join(","),...d].join(`
`),u=new Blob([c],{type:"text/csv"}),p=URL.createObjectURL(u),h=document.createElement("a");h.href=p,h.download=`DukaImara-report-${new Date().toISOString().split("T")[0]}.csv`,h.click(),URL.revokeObjectURL(p)}async function Bn(i,o){if(o.role!=="admin"){i.innerHTML='<div class="page active"><div class="empty-state"><h3>Access Denied</h3><p>Only admin users can access this page</p></div></div>';return}const d=await Dn(),c=await xt();await Vt();const p=(localStorage.getItem("ts_theme")||"dark")==="dark";i.innerHTML=`
        <div class="page active" id="page-admin">
            <div class="page-header">
                <div>
                    <h2>Admin Panel ð</h2>
                    <div class="subtitle">Manage profiles & system</div>
                </div>
            </div>

            <div class="stats-grid" style="margin-bottom: var(--space-lg);">
                <div class="stat-card">
                    <div class="stat-label">Profiles</div>
                    <div class="stat-value">${d.length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Products</div>
                    <div class="stat-value">${c.length}</div>
                </div>
            </div>

            <div class="section-header">
                <h3>Team Members</h3>
                <button class="btn btn-primary" id="admin-add-profile">+ Add Profile</button>
            </div>

            <div class="admin-profile-list" id="admin-profiles">
                ${d.map(h=>`
                    <div class="admin-profile-card" data-id="${h.id}">
                        <div class="admin-profile-header">
                            <div class="credit-avatar" style="background: ${h.color}">
                                ${h.name.charAt(0).toUpperCase()}
                            </div>
                            <div class="admin-profile-info">
                                <div class="admin-profile-name">
                                    ${h.name} ${h.role==="admin"?"ð":""}
                                </div>
                                <div class="admin-profile-role">${h.role==="admin"?"Administrator":"Staff"}</div>
                            </div>
                            ${h.role!=="admin"?`<button class="btn btn-ghost btn-sm admin-delete-profile" data-id="${h.id}">ðï¸</button>`:""}
                        </div>
                        ${h.role!=="admin"?`
                            <div class="admin-privileges">
                                <label class="admin-priv-toggle">
                                    <input type="checkbox" data-id="${h.id}" data-priv="canSell" ${h.privileges?.canSell?"checked":""} />
                                    <span>Can Sell</span>
                                </label>
                                <label class="admin-priv-toggle">
                                    <input type="checkbox" data-id="${h.id}" data-priv="canAddStock" ${h.privileges?.canAddStock?"checked":""} />
                                    <span>Can Manage Stock</span>
                                </label>
                                <label class="admin-priv-toggle">
                                    <input type="checkbox" data-id="${h.id}" data-priv="canManageCredits" ${h.privileges?.canManageCredits?"checked":""} />
                                    <span>Can Manage Credits</span>
                                </label>
                                <label class="admin-priv-toggle">
                                    <input type="checkbox" data-id="${h.id}" data-priv="canViewReports" ${h.privileges?.canViewReports?"checked":""} />
                                    <span>Can View Reports</span>
                                </label>
                                <label class="admin-priv-toggle">
                                    <input type="checkbox" data-id="${h.id}" data-priv="canManageDebits" ${h.privileges?.canManageDebits?"checked":""} />
                                    <span>Can Manage Deposits</span>
                                </label>
                            </div>
                        `:`
                            <div class="admin-privileges">
                                <div style="font-size: var(--font-size-xs); color: var(--text-muted); padding: 8px;">
                                    Full access to all features
                                </div>
                            </div>
                        `}
                    </div>
                `).join("")}
            </div>

            <div class="settings-list" style="margin-top: var(--space-lg);">
                <div class="section-header"><h3>System</h3></div>
                <div class="settings-item" id="admin-toggle-theme">
                    <div class="settings-icon" style="background: rgba(13,148,136,0.15);">
                        ${p?"ð":"âï¸"}
                    </div>
                    <div class="settings-info">
                        <div class="settings-label">Theme</div>
                        <div class="settings-desc">${p?"Dark Mode":"Light Mode"}</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="admin-theme-switch" ${p?"":"checked"} />
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item" id="admin-demo-data">
                    <div class="settings-icon" style="background: rgba(249,115,22,0.15);">ð¦</div>
                    <div class="settings-info">
                        <div class="settings-label">Load Demo Data</div>
                        <div class="settings-desc">Add sample products</div>
                    </div>
                    <span class="settings-arrow">âº</span>
                </div>
                <div class="settings-item" id="admin-view-reports">
                    <div class="settings-icon" style="background: rgba(59,130,246,0.15);">ð</div>
                    <div class="settings-info">
                        <div class="settings-label">Sales Reports</div>
                        <div class="settings-desc">Detailed analytics</div>
                    </div>
                    <span class="settings-arrow">âº</span>
                </div>
                <div class="settings-item" id="admin-lock">
                    <div class="settings-icon" style="background: rgba(239,68,68,0.15);">ð</div>
                    <div class="settings-info">
                        <div class="settings-label">Lock App</div>
                        <div class="settings-desc">Return to lock screen</div>
                    </div>
                    <span class="settings-arrow">âº</span>
                </div>
            </div>
        </div>
    `,i.querySelectorAll(".admin-priv-toggle input").forEach(h=>{h.addEventListener("change",async m=>{const v=m.target.dataset.id,I=m.target.dataset.priv,$=d.find(C=>C.id===v);if($){const C={...$.privileges,[I]:m.target.checked};await Hi(v,{privileges:C}),W(`${$.name}'s permissions updated`,"success")}})}),i.querySelectorAll(".admin-delete-profile").forEach(h=>{h.addEventListener("click",async m=>{m.stopPropagation();const v=h.dataset.id,I=d.find($=>$.id===v);if(confirm(`Delete profile "${I?.name}"? This cannot be undone.`))try{await Vi(v),W(`${I.name} deleted`,"info"),Bn(i,o)}catch($){W($.message,"error")}})}),document.getElementById("admin-add-profile").addEventListener("click",()=>{ds(i,o)}),document.getElementById("admin-theme-switch")?.addEventListener("change",h=>{const m=h.target.checked?"light":"dark";localStorage.setItem("ts_theme",m),document.documentElement.setAttribute("data-theme",m),Bn(i,o)}),document.getElementById("admin-demo-data")?.addEventListener("click",async()=>{const{renderSettings:h}=await wt(async()=>{const{renderSettings:A}=await Promise.resolve().then(()=>cs);return{renderSettings:A}},void 0),{db:m}=await wt(async()=>{const{db:A}=await Promise.resolve().then(()=>oa);return{db:A}},void 0),{uuid:v}=await wt(async()=>{const{uuid:A}=await Promise.resolve().then(()=>lo);return{uuid:A}},void 0),{now:I}=await wt(async()=>{const{now:A}=await Promise.resolve().then(()=>co);return{now:A}},void 0),$=I(),C=[{name:"White Bread 400g",price:60,stock:48,category:"Food",emoji:"ð",unit:"pcs",costPrice:45,description:"Premium white bread",lowStockThreshold:10},{name:"Fresh Milk 500ml",price:75,stock:30,category:"Drinks",emoji:"ð¥",unit:"pcs",costPrice:55,description:"Pasteurized fresh milk",lowStockThreshold:8},{name:"Farm Eggs (Tray)",price:450,stock:15,category:"Food",emoji:"ð¥",unit:"tray",costPrice:380,description:"Farm fresh eggs, 30 per tray",lowStockThreshold:3},{name:"Maize Flour 2kg",price:180,stock:40,category:"Food",emoji:"ð½",unit:"pcs",costPrice:150,description:"Fine maize flour for ugali",lowStockThreshold:8},{name:"Cooking Oil 1L",price:320,stock:22,category:"Food",emoji:"ð«",unit:"litre",costPrice:280,description:"Pure vegetable cooking oil",lowStockThreshold:5},{name:"Soda 500ml",price:80,stock:50,category:"Drinks",emoji:"ð¥¤",unit:"pcs",costPrice:55,description:"Assorted soft drinks",lowStockThreshold:10}];for(const A of C)await m.products.filter(V=>V.name===A.name&&!V._tombstone).first()||await m.products.add({id:v(),...A,_hlc:$,_tombstone:!1,_lastModified:Date.now(),createdAt:Date.now()});W("Demo data loaded! ð","success")}),document.getElementById("admin-view-reports")?.addEventListener("click",()=>{location.hash="#reports"}),document.getElementById("admin-lock")?.addEventListener("click",()=>{sessionStorage.removeItem("ts_profileId");const{lock:h}=require("../components/pin-lock.js")||{};location.hash="#dashboard",location.reload()})}function ds(i,o){const d=document.getElementById("modal-backdrop"),c=document.getElementById("modal");c.innerHTML=`
        <div class="modal-handle"></div>
        <h2>Add Team Member</h2>
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="new-staff-name" placeholder="Staff name" />
        </div>
        <div class="form-group">
            <label>4-Digit PIN</label>
            <input type="password" id="new-staff-pin" placeholder="â¢â¢â¢â¢" maxlength="4" inputmode="numeric" />
        </div>
        <div class="form-group">
            <label>Permissions</label>
            <div class="admin-privileges-modal">
                <label class="admin-priv-toggle"><input type="checkbox" id="np-canSell" checked /><span>Can Sell</span></label>
                <label class="admin-priv-toggle"><input type="checkbox" id="np-canAddStock" /><span>Can Manage Stock</span></label>
                <label class="admin-priv-toggle"><input type="checkbox" id="np-canManageCredits" /><span>Can Manage Credits</span></label>
                <label class="admin-priv-toggle"><input type="checkbox" id="np-canViewReports" /><span>Can View Reports</span></label>
                <label class="admin-priv-toggle"><input type="checkbox" id="np-canManageDebits" /><span>Can Manage Deposits</span></label>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-ghost" id="np-cancel">Cancel</button>
            <button class="btn btn-primary" id="np-save">Create Profile</button>
        </div>
    `,d.classList.remove("hidden"),c.classList.remove("hidden"),document.getElementById("np-save").addEventListener("click",async()=>{const u=document.getElementById("new-staff-name").value.trim(),p=document.getElementById("new-staff-pin").value.trim();if(!u){W("Enter staff name","warning");return}if(p.length!==4){W("PIN must be 4 digits","warning");return}const h={canSell:document.getElementById("np-canSell").checked,canAddStock:document.getElementById("np-canAddStock").checked,canManageCredits:document.getElementById("np-canManageCredits").checked,canViewReports:document.getElementById("np-canViewReports").checked,canManageDebits:document.getElementById("np-canManageDebits").checked};try{await Or(u,p,"staff",h,o.id),d.classList.add("hidden"),c.classList.add("hidden"),W(`${u} added to team â`,"success"),Bn(i,o)}catch(m){W(m.message,"error")}}),document.getElementById("np-cancel").addEventListener("click",()=>{d.classList.add("hidden"),c.classList.add("hidden")}),d.addEventListener("click",()=>{d.classList.add("hidden"),c.classList.add("hidden")})}let we=null,Ea="dashboard";function fs(){const i=localStorage.getItem("ts_theme")||"light";document.documentElement.setAttribute("data-theme",i)}async function Fi(i){Ea=i;const o=`#${i}`;location.hash!==o&&history.replaceState(null,"",o);const d=document.getElementById("page-container");if(d.innerHTML="",!we)return;const c=we.id;switch(i){case"dashboard":await To(d,c,we,{navigateTo:u=>Rr(u),addToCart:Sa});break;case"sales":await _a(d,c,we);break;case"inventory":await Pn(d,c,we);break;case"credits":await Et(d,c,we);break;case"reports":await ls(d);break;case"settings":await Tn(d,c,we,{onLock:()=>{we=null,sessionStorage.removeItem("ts_profileId"),la()}});break;case"admin":await Bn(d,we);break}}function zi(){fs(),Cn(),xo(1e4),ko(i=>{we=i,sessionStorage.setItem("ts_profileId",i.id),So(u=>Fi(u)),_o(i),$o(),va(3e4);const o=location.hash.replace("#","")||"dashboard",c=["dashboard","sales","inventory","credits","reports","settings","admin"].includes(o)?o:"dashboard";Fi(c)}),document.getElementById("lock-btn").addEventListener("click",()=>{we=null,sessionStorage.removeItem("ts_profileId"),la()}),window.addEventListener("hashchange",()=>{if(!we)return;const i=location.hash.replace("#","")||"dashboard";i!==Ea&&Rr(i)}),"serviceWorker"in navigator&&(navigator.serviceWorker.getRegistrations().then(i=>{for(const o of i)o.active&&o.active.scriptURL.includes("sw.js")&&o.update().catch(()=>{})}),navigator.serviceWorker.register("/sw.js").then(i=>console.log("[App] SW registered:",i.scope)).catch(i=>console.warn("[App] SW registration failed:",i.message)),navigator.serviceWorker.addEventListener("message",i=>{i.data?.type==="SYNC_TRIGGER"&&wt(()=>Promise.resolve().then(()=>Io),void 0).then(o=>o.forceSync())}))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",zi):zi();
